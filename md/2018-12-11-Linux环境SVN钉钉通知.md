---
title: Linux环境SVN钉钉通知
tags:
  - 钉钉
  - svn
categories:
  - Linux
copyright: true
date: 2018-12-11 16:25:49
---

# 1 参考资料
<!--more-->
https://www.cnblogs.com/jianxuanbing/p/6835765.html

# 2 步骤
![3](3.jpg)
## 2.1 修改pre-commit

``` bash
#"!/bin/sh

REPOS="$1"
TXN="$2"

SVNLOOK=/usr/bin/svnlook  # 同pre-commit.tmpl文件中的SVNLOOK
LOGMSG=`$SVNLOOK log -t "$TXN" "$REPOS" | grep "[a-zA-Z0-9]" | wc -c`
if [ "$LOGMSG" -lt 10 ];then
   echo "提交失败： 注释不能低于10个字符" 1>&2
   exit 1
fi
```

## 2.2 修改post-commit

``` bash

#!/bin/sh
# 设置默认字符集，否则post信息到钉钉时中文乱码
export LANG=en_US.UTF-8
# svn中变量1为仓库路径，2为提交版本号
REPOS="$1"
REV="$2"
time=$(date +%F/%T)
# 下方svnlook命令获取相应的结果
AUTHOR=$(/usr/bin/svnlook author -r ${REV} ${REPOS})
CHANGEDDIRS=$(/usr/bin/svnlook dirs-changed $REPOS)
MESSAGE=$(/usr/bin/svnlook log -r $REV $REPOS)

CONTENT=提交时间：${time}\\n提交版本：${REV}\\n作者：${AUTHOR}\\n提交备注：${MESSAGE}\\n修改目录：$CHANGEDDIRS
cd /home/
/usr/local/jdk1.8.0_152/bin/java Request 92bfa50db10658ee1c37f9ab6b7a000e14ce94a901002170762e472af3754fbf  $CONTENT
```
{%note info no-cion%}**备注**：
1. 脚本需要设置LANG变量为UTF8,否则中文乱码
2. CONTENT变量赋值种的`:`为中文书写方式，输出的消息存在空格的效果。
3. Request为java请求文件编译后的class文件，下面讲解
{%endnote%}

**效果对比：**
![1](1.jpg)
![2](2.jpg)

## 3 配置Java请求文件
由于钉钉提供的接口是https协议，curl需要支持https，因此通过java代码发起Post请求，打包成可运行的class文件，然后用`post-commit`调用，传入信息即可。

``` javascript
package com.wolf.util;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.net.URL;

import javax.net.ssl.HttpsURLConnection;

public class Request {
    public static void main(String[] args) throws Exception {
        String token = args[0];
        String content = args[1];
        content = "{\"msgtype\": \"text\",\"text\": {\"content\": \""+content+"\"}}";
        httpsRequest("https://oapi.dingtalk.com/robot/send?access_token="+token, "POST", content);
        System.out.println("OK");
        System.exit(0);
    }

    /**
     * 发送https请求
     */
    public static String httpsRequest(String requestUrl, String requestMethod, String outputStr) throws Exception {
        HttpsURLConnection conn = null;
        BufferedReader bufferedReader = null;
        try {
            URL url = new URL(requestUrl);
            conn = (HttpsURLConnection) url.openConnection();
            conn.setDoOutput(true);
            conn.setDoInput(true);
            conn.setUseCaches(false);
            conn.setRequestMethod(requestMethod);
            conn.setRequestProperty("content-type", "application/json");
            if (null != outputStr) {
                OutputStream outputStream = conn.getOutputStream();
                outputStream.write(outputStr.getBytes("utf-8"));
                outputStream.close();
            }
            bufferedReader = new BufferedReader(new InputStreamReader(conn.getInputStream(), "utf-8"));
            String str = null;
            StringBuffer buffer = new StringBuffer();
            while ((str = bufferedReader.readLine()) != null) {
                buffer.append(str);
            }
            return buffer.toString();
        } catch (Exception e) {
            throw e;
        } finally {
            if (conn != null) {
                conn.disconnect();
            }
            if (bufferedReader != null) {
                try {
                    bufferedReader.close();
                } catch (IOException e) {
                }
            }
        }
    }
}
```
{%note info %}**备注：**
将上面代码使用eclipse工具导出为`java`文件，然后`javac Request.java`命令生成`class`文件，`java Request`命令执行`class`文件。
{%endnote%}

# 3 问题汇总

## 3.1 乱码问题
参考上面讲述，及解决方法
## 3.2 消息：后空格问题
参考上面代码`：`使用中文写法。
# 4 附件
[Request.class](https://github.com/kxinter/kxinter.github.io/raw/master/2018/12/11/Linux%E7%8E%AF%E5%A2%83SVN%E9%92%89%E9%92%89%E9%80%9A%E7%9F%A5/Request.class)
[Request.java](https://github.com/kxinter/kxinter.github.io/blob/master/2018/12/11/Linux%E7%8E%AF%E5%A2%83SVN%E9%92%89%E9%92%89%E9%80%9A%E7%9F%A5/Request.java)