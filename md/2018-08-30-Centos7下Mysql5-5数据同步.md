---
title: Centos7下Mysql5.5数据同步
tags:
  - mysql
categories:
  - Linux
date: 2018-08-30 17:23:58
---

# 1 环境
<!--more-->
<table>
    <tr>
        <td>服务器</td> 
        <td>系统</td> 
	    <td>服务</td>
		<td>java</td>
		<td>mysql</td>
		<td>ip</td>
   </tr>
       <tr>
        <td>Liferay-a</td>
		<td> Centos7</td>
		<td>Liferay+keepalive+sersync</td>
		<td>1.7.0_80</td>
		<td>5.5.42</td>
		<td>172.20.20.59 </td>  
   </tr>
       <tr>
        <td>Liferay-b</td>
		<td> Centos7</td>
		<td>Liferay+keepalive+rsync</td>
		<td>1.7.0_80</td>
		<td>5.5.42</td>
		<td>172.20.20.60 </td>  
   </tr>
    <tr>
        <td colspan="6">虚拟IP:172.20.20.58</td>   
    </tr>
</table>

# 2 安装liferay

安装liferay官方版本6.2-ce4,方法自行度娘。恢复数据参考《liferay备份还原文档》

# 3 安装keepalive

``` ebnf
Yum install keepalive
```

## 3.1 编辑配置文件

``` vim
vi /etc/keepalived/keepalived.conf
```

Liferay-a:
![enter description here](1.jpg)


Liferay-b:
![enter description here](2.jpg)


启动keepalive，建立虚拟IP，主服务器当机，从服务器获得Ip.

# 4 mysql主从同步

下载mysql-5.5.42-linux2.6-x86_64.tar.gz
解压到/usr/local,重命名为mysql

## 4.1 编辑配置文件

``` nginx
Vi /etc/my.cnf
```

Liferay-a:
![enter description here](3.jpg)


Liferay-b
![enter description here](4.jpg)


## 4.2 建立mysql主从同步

查看liferay-a(主服务器)，查看mysql（主）信息，并建立同步帐号：

``` sql
GRANT ALL PRIVILEGES ON bitnami_liferay.* TO 'tongbu'@'%' IDENTIFIED BY 'De123456' WITH GRANT OPTION;
```

进入liferay-b（从服务器），在mysql中输入命令，建立连接

``` sql
CHANGE MASTER TO MASTER_HOST='172.20.20.59',  MASTER_USER='tongbu', MASTER_PASSWORD='De123456', MASTER_LOG_FILE='mysql-bin.000022',MASTER_LOG_POS=151424110;
```

输入命令，

查看备服务器信息

``` sql
SHOW SLAVE STATUS\G
```
![enter description here](5.png)

## 4.3 恢复数据库

通过mysql命令恢复bitnami_liferay数据库备份到lifreay-a(主服务器)，自动实时同步数据到从服务器。

# 5 目录同步

## 5.1 安装rsync(liferay-b)

只需在liferay-b服务器上安装rsync。

Liferay-b作为rsync服务器，lifray-a作为客户端，实时同步目录数据到liferay-bYum install rsync

### 5.1.1 编辑配置文件

``` stylus
vi /etc/rsyncd.conf liferay-b:
```
![enter description here](6.png)

新建rsyncd.pass1密码文件在/etc/目录

文件格式 帐号:密码 设置文件权限为600（必须）
![enter description here](7.png)


## 5.2 安装sersync（liferay-a）

Liferay-a安装实时同步工具sersync2.5.4_64bit_binary_stable_final.tar.gz
下载sersync2.5.4_64bit_binary_stable_final.tar.gz
解压到/usr/local

### 5.2.1 编辑confxml.xml


``` css
vi confxml.xml
```
![enter description here](8.png)

### 5.2.2 在/etc/目录创建密码文件rsyncd.pass1

文件格式只填写密码（注意和同步服务器的密码文件内的密码一样）
![enter description here](9.png)


## 5.3 启动sersync，开启实时同步

``` groovy
/usr/local/sersync/sersync2 -d -r -o /usr/local/sersync/confxml.xml
```

