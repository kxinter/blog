<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/kxinter.gitub.io/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/kxinter.gitub.io/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/kxinter.gitub.io/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/kxinter.gitub.io/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/kxinter.gitub.io/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/kxinter.gitub.io/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/kxinter.gitub.io/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="日常运维文档整理。">
<meta property="og:type" content="website">
<meta property="og:title" content="OperationMAN">
<meta property="og:url" content="https://kxinter.github.io/kxinter.gitub.io/index.html">
<meta property="og:site_name" content="OperationMAN">
<meta property="og:description" content="日常运维文档整理。">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="OperationMAN">
<meta name="twitter:description" content="日常运维文档整理。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/kxinter.gitub.io/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://kxinter.github.io/kxinter.gitub.io/"/>





  <title>OperationMAN</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/kxinter.gitub.io/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">OperationMAN</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">笔记</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/kxinter.gitub.io/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/kxinter.gitub.io/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/kxinter.gitub.io/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/kxinter.gitub.io/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kxinter.github.io/kxinter.gitub.io/kxinter.gitub.io/2018/08/27/Docker集群-Docker-Swarm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/kxinter.gitub.io/images/touxiang.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OperationMAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/kxinter.gitub.io/2018/08/27/Docker集群-Docker-Swarm/" itemprop="url">Docker集群-Docker_Swarm</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-27T11:52:53+08:00">
                2018-08-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/kxinter.gitub.io/categories/Docker/" itemprop="url" rel="index">
                    <span itemprop="name">Docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-安装-Swarm"><a href="#1-安装-Swarm" class="headerlink" title="1 安装 Swarm"></a>1 安装 Swarm</h1><h2 id="1-1-下载镜像"><a href="#1-1-下载镜像" class="headerlink" title="1.1 下载镜像"></a>1.1 下载镜像</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> docker pull swarm</span><br></pre></td></tr></table></figure>
<p>可以使用下面的命令来查看 Swarm 版本，验证是否成功下载 Swarm 镜像。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --rm swarm -v</span><br><span class="line">swarm version <span class="number">1.2</span><span class="number">.2</span> (<span class="number">34e3</span>da3)</span><br></pre></td></tr></table></figure>
<h2 id="1-2-配置节点"><a href="#1-2-配置节点" class="headerlink" title="1.2 配置节点"></a>1.2 配置节点</h2><p>Docker 主机在加入 Swarm 集群前，需要进行一些简单配置，添加 Docker daemon 的网络监听。</p>
<p>例如，在启动 Docker daemon 的时候通过 -H 参数：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>sudo docker daemon -H <span class="symbol">tcp:</span>/<span class="regexp">/0.0.0.0:2375 -H unix:/</span><span class="regexp">//var</span><span class="regexp">/run/docker</span>.sock</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：Docker 1.8.0 版本之前不支持 daemon 命令，可以用 -d 代替。</p>
</blockquote>
<p>如果是通过服务方式启动，则需要修改服务的配置文件。</p>
<p>以 Ubuntu 14.04 为例，配置文件为 <code>/etc/default/docker</code>（其他版本的 Linux 上略有不同）。</p>
<p>在文件的最后添加：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DOCKER_OPTS=<span class="string">"$DOCKER_OPTS -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock"</span></span><br></pre></td></tr></table></figure>
<h2 id="1-3-启动集群"><a href="#1-3-启动集群" class="headerlink" title="1.3 启动集群"></a>1.3 启动集群</h2><p>Docker 集群管理需要使用服务发现（Service Discover）功能，Swarm 支持以下的几种方式：DockerHub、本地文件、etcd、consul、zookeeper 和手动指定节点 IP 地址信息等。</p>
<p>除了手动指定外，这些方法原理上都是通过维护一套数据库机制，来管理集群中注册节点的 Docker daemon 的访问信息。</p>
<p>本地配置集群推荐使用 consul 作为服务发现后端。利用社区提供的 Docker 镜像，整个过程只需要三步即可完成。</p>
<h3 id="1-3-1-启动-Consul-服务后端"><a href="#1-3-1-启动-Consul-服务后端" class="headerlink" title="1.3.1 启动 Consul 服务后端"></a>1.3.1 启动 Consul 服务后端</h3><p>启动 consul 服务容器，映射到主机的 8500 端口。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> docker run -d -p 8500:8500 --name=consul progrium/consul -server -bootstrap</span><br></pre></td></tr></table></figure>
<p>获取到本地主机的地址作为 consul 的服务地址：&lt;consul_ip&gt;:8500。</p>
<h3 id="1-3-2-启动管理节点"><a href="#1-3-2-启动管理节点" class="headerlink" title="1.3.2 启动管理节点"></a>1.3.2 启动管理节点</h3><p>首先，启动一个主管理节点，映射到主机的 4000 端口，并获取所在主机地址为 &lt;manager0_ip&gt;。其中 4000 端口是 Swarm 管理器的默认监听端口，用户也可以指定映射为其它端口。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -p <span class="number">4000</span>:<span class="number">4000</span> swarm manage -<span class="string">H :</span><span class="number">4000</span> --replication --advertise &lt;manager0_ip&gt;:<span class="number">4000</span> <span class="string">consul:</span><span class="comment">//&lt;consul_ip&gt;:8500</span></span><br></pre></td></tr></table></figure>
<p>为了提高高可用性，用户也可以启动从管理节点。假定获取所在主机地址为 &lt;manager1_ip&gt;。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d swarm manage -<span class="string">H :</span><span class="number">4000</span> --replication --advertise &lt;manager1_ip&gt;:<span class="number">4000</span> <span class="string">consul:</span><span class="comment">//&lt;consul_ip&gt;:8500</span></span><br></pre></td></tr></table></figure>
<h3 id="1-3-3-启动工作节点"><a href="#1-3-3-启动工作节点" class="headerlink" title="1.3.3 启动工作节点"></a>1.3.3 启动工作节点</h3><p>需要在每个工作节点上启动 agent 服务。</p>
<p>获取节点的主机地址为 &lt;node_ip&gt;，并指定前面获取到的 consul 服务地址。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d swarm <span class="keyword">join</span> --advertise=<span class="symbol">&lt;node_ip&gt;</span>:<span class="number">2375</span> consu<span class="variable">l:</span>//<span class="symbol">&lt;consul_ip&gt;</span>:<span class="number">8500</span></span><br></pre></td></tr></table></figure>
<p>节点启动后，用户可以指定 Docker 服务地址为 &lt;manager0_ip&gt;:4000&gt; 来测试各种 Docker 命令，可以看到整个 Swarm 集群就像一个虚拟的 Docker 主机一样正常工作。</p>
<p>由于 Swarm 实际上是通过 agent 调用了本地的 Docker daemon 来运行容器，当 Swarm 集群服务出现故障时，无法接受新的请求，但已经运行起来的容器将不会受到影响。</p>
<h1 id="2-使用-Swarm"><a href="#2-使用-Swarm" class="headerlink" title="2 使用 Swarm"></a>2 使用 Swarm</h1><p>前面演示了基于 consul 服务发现后端来配置一个本地 Swarm 集群。其中，consul 也可以被替换为 etcd、zookeeper 等。</p>
<p>另外一个更方便的方式是直接使用 DockerHub 提供的免费服务发现后端。</p>
<p>下面使用这种方式来演示 Swarm 的主要操作，包括：</p>
<ul>
<li>create：创建一个集群； </li>
<li>list：列出集群中的节点； </li>
<li>manage：管理一个集群； </li>
<li>join：让节点加入到某个集群。</li>
</ul>
<blockquote>
<p>注意，使用 DockerHub 的服务发现后端，需要各个节点能通过公网访问到 DockerHub 的服务接口。</p>
</blockquote>
<h2 id="2-1-创建集群-id"><a href="#2-1-创建集群-id" class="headerlink" title="2.1 创建集群 id"></a>2.1 创建集群 id</h2><p>在任意一台安装了 Swarm 的机器上执行 swarm create 命令来在 DockerHub 服务上进行注册。</p>
<p>Swarm 会通过服务发现后端（此处为 DockerHub 提供）来获取一个唯一的由数字和字母组成的 token，用来标识要管理的集群。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="keyword">run</span> --rm swarm create</span><br><span class="line">946d65606f7c2f49766e4dddac5b4365</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意返回的字符串，这是集群的唯一 id，加入集群的各个节点将需要这个信息。</p>
</blockquote>
<h2 id="2-2-配置集群节点"><a href="#2-2-配置集群节点" class="headerlink" title="2.2 配置集群节点"></a>2.2 配置集群节点</h2><p>在所有要加入集群的普通节点上面执行 swarm join 命令，表示把这台机器加入指定集群当中。</p>
<p>例如某台机器 IP 地址为 192.168.0.2，将其加入我们刚创建的 946d65606f7c2f49766e4dddac5b4365 集群，则可以通过：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="keyword">run</span> --<span class="keyword">rm</span> swarm join --addr=192.168.0.2:2375 <span class="keyword">token</span>:<span class="comment">//946d65606f7c2f49766e4dddac5b4365</span></span><br><span class="line">time=<span class="string">"2015-12-09T08:59:43Z"</span> level=info msg=<span class="string">"Registering on the discovery service every 20s..."</span> addr=<span class="string">"192.168.0.2:2375"</span> discovery=<span class="string">"token://946d65606f7c2f49766e4dddac5b4365"</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：其中 –addr 指定的 IP 地址信息将被发送给服务发现后端，用以区分集群不同的节点。manager<br>服务必须要通过这个地址可以访问到该节点。</p>
</blockquote>
<p>通过控制台可以看到，上述命令执行后，默认每隔 20 秒（可以通过 –heartbeat 选项指定），会输出一条心跳信息。对于发现服务后端来说，默认如果超过 60 秒（可以通过 –ttl 选项指定）没有收到心跳信息，则将节点从列表中删除。</p>
<p>如果不希望看到输出日志信息，则可以用 -d 选项替换 –rm 选项，让服务后台执行。</p>
<p>执行 swarm join 命令实际上是通过 agent 把自己的信息注册到发现服务上，因此，此时对于后端的发现服务来说，已经可以看到有若干节点注册上来了。那么，如何管理和使用这些节点呢，这就得需要 Swarm 的 manager 服务了。</p>
<h2 id="2-3-配置管理节点"><a href="#2-3-配置管理节点" class="headerlink" title="2.3 配置管理节点"></a>2.3 配置管理节点</h2><p>配置管理节点需要通过 swarm manage 命令，该命令将启动 manager 服务，默认监听到 2375 端口，所有对集群的管理可以通过该服务接口进行。</p>
<p>读者可能注意到，manager 服务默认监听的端口跟 Docker 服务监听端口是一样的，这是为了兼容其它基于 Docker 的服务，可以无缝地切换到 Swarm 平台上来。</p>
<p>仍然在节点 192.168.0.2 进行操作。由于我们是采用 Docker 容器形式启动 manager 服务，本地的 2375端口已经被 Docker Daemon 占用。我们将 manager 服务监听端口映射到本地一个空闲的 12375 端口。</p>
<p>$ docker run -d -p 12375:2375 swarm manage token://946d65606f7c2f49766e4dddac5b4365<br>1e1ca8c4117b6b7271efc693f9685b4e907d8dc95324350392b21e94b3cffd18<br>可以通过 docker ps 命令来查看启动的 swarm manager 服务容器。</p>
<p>$ docker ps<br>CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                     NAMES<br>1e1ca8c4117b        swarm               “/swarm manage token:”   11 seconds ago      Up 10 seconds       0.0.0.0:12375-&gt;2375/tcp   jovial_rosalind<br>命令如果执行成功会返回刚启动的 Swarm 容器的 ID，此时一个简单的 Swarm 集群就已经搭建起来了，包括一个普通节点和一个管理节点。</p>
<p>查看集群节点列表<br>集群启动成功以后，用户可以在任何一台节点上使用 swarm list 命令查看集群中的节点列表。例如</p>
<p>$ docker run –rm swarm list token://946d65606f7c2f49766e4dddac5b4365<br>192.168.0.2:2375<br>显示正是之前用 swarm join 命令加入集群的节点的地址。</p>
<p>我们在另外一台节点 192.168.0.3 上同样使用 swarm join 命令新加入一个节点：</p>
<p>$docker run –rm swarm join –addr=192.168.0.3:2375 token://946d65606f7c2f49766e4dddac5b4365<br>time=”2015-12-10T02:05:34Z” level=info msg=”Registering on the discovery service every 20s…” addr=”192.168.0.3:2375” discovery=”token://946d65606f7c2f49766e4dddac5b4365”<br>…<br>再次使用 swarm list 命令查看集群中的节点列表信息，可以看到新加入的节点：</p>
<p>$ docker run –rm swarm list token://946d65606f7c2f49766e4dddac5b4365<br>192.168.0.3:2375<br>192.168.0.2:2375<br>使用集群服务<br>那么，怎么使用 Swarm 提供的服务呢？</p>
<p>实际上，所有 Docker 客户端可以继续使用，只要指定使用 Swarm manager 服务的监听地址即可。</p>
<p>例如，manager 服务监听的地址为 192.168.0.2:12375，则可以通过指定 -H 192.168.0.2:12375 选项来继续使用 Docker 客户端，执行任意 Docker 命令，例如 ps、info、run 等等。</p>
<p>在任意节点上使用 docker run 来启动若干容器，例如</p>
<p>$docker -H 192.168.0.2:12375:12375 run -d ubuntu ping 127.0.0.1<br>4c9bccbf86fb6e2243da58c1b15e9378fac362783a663426bbe7058eea84de46<br>使用 ps 命令查看集群中正在运行的容器。</p>
<p>$ docker -H 192.168.0.2:12375 ps<br>CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                         NAMES<br>4c9bccbf86fb        ubuntu              “ping 127.0.0.1”         About a minute ago   Up About a minute                       clever_wright<br>730061a3801a        registry:latest     “docker-registry”        2 minutes ago        Up 2 minutes         192.168.0.2:5000-&gt;5000/tcp   Host-1/registry_registry_1<br>72d99f24a06f        redis:3.0           “/entrypoint.sh redis”   2 minutes ago        Up 2 minutes         6379/tcp                      Host-1/registry_redis_1,Host-1/registry_registry_1/redis,Host-1/registry_registry_1/redis_1,Host-1/registry_registry_1/registry_redis_1<br>输出结果中显示目前集群中正在运行的容器（注意不包括 Swarm manager 服务容器），可以在不同节点上使用 docker ps 查看本地容器，发现这些容器实际上可能运行在集群中多个节点上（被 Swarm 调度策略进行分配）。</p>
<p>使用 info 查看所有节点的信息。</p>
<p>$ docker -H 192.168.0.2:12375 info<br>Containers: 18<br>Images: 36<br>Role: primary<br>Strategy: spread<br>Filters: health, port, dependency, affinity, constraint<br>Nodes: 2<br> Host-1: 192.168.0.2:2375<br>  └ Containers: 15<br>  └ Reserved CPUs: 0 / 4<br>  └ Reserved Memory: 1 GiB / 4.053 GiB<br>  └ Labels: executiondriver=native-0.2, kernelversion=3.16.0-43-generic, operatingsystem=Ubuntu 14.04.3 LTS, storagedriver=aufs<br> Host-2: 192.168.0.3:2375<br>  └ Containers: 3<br>  └ Reserved CPUs: 0 / 8<br>  └ Reserved Memory: 0 B / 16.46 GiB<br>  └ Labels: executiondriver=native-0.2, kernelversion=3.16.0-30-generic, operatingsystem=Ubuntu 14.04.3 LTS, storagedriver=aufs<br>CPUs: 12<br>Total Memory: 20.51 GiB<br>Name: 1e1ca8c4117b<br>结果输出显示这个集群目前只有两个节点，地址分别是 192.168.0.2 和 192.168.0.3。</p>
<p>类似的，也可以通过 Compose 模板来启动多个服务。不过请注意，要想让服务分布到多个 Swarm 节点上，需要采用版本 2 的写法。</p>
<p>使用网络<br>Swarm 为了支持跨主机的网络，默认采用了 overlay 网络类型，实现上通过 vxlan 来构建联通整个 Swarm 集群的网络。</p>
<p>首先，在集群中所有节点上，添加配置 Docker daemon 选项：</p>
<p>–cluster-store=&lt;DISCOVERY_HOST:PORT&gt; –cluster-advertise=&lt;DOCKER_DAEMON_HOST:PORT&gt;<br>以 consul 服务为例，可能类似：</p>
<p>–cluster-store=consul://<consul 服务地址="">:8500 –cluster-advertise=192.168.0.3:2375<br>之后重启 Docker 服务。</consul></p>
<p>首先，创建一个网络。</p>
<p>$ docker -H 192.168.0.2:12375 network create swarm_network<br>查看网络，将看到一个 overlay 类型的网络。</p>
<p>$ docker -H 192.168.0.2:12375 network ls<br>NETWORK ID          NAME                DRIVER<br>6edf2d16ec97        swarm_network       overlay<br>此时，所有添加到这个网络上的容器将自动被分配到集群中的节点上，并且彼此联通。</p>
<p>使用其它服务发现后端<br>Swarm 目前可以支持多种服务发现后端，这些后端功能上都是一致的，即维护属于某个集群的节点的信息。不同方案并无优劣之分，在实际使用时候，可以结合自身需求和环境限制进行选择，甚至自己定制其它方案。</p>
<p>使用中可以通过不同的路径来选择特定的服务发现后端机制。</p>
<p>token://<token>：使用 DockerHub 提供的服务，适用于可以访问公网情况；<br>file://path/to/file：使用本地文件，需要手动管理；<br>consul://<ip>/<path></path>：使用 consul 服务，私有环境推荐；<br>etcd://<ip1>,<ip2>/<path></path>：使用 etcd 服务，私有环境推荐；<br>zk://<ip1>,<ip2>/<path></path>：使用 zookeeper 服务，私有环境推荐；<br>[nodes://]<ip1>,<ip2>：手动指定集群中节点的地址，方便进行服务测试。<br>使用文件<br>使用本地文件的方式十分简单，就是讲所有属于某个集群的节点的 Docker daemon 信息写入一个文件中，然后让 manager 从这个文件中直接读取相关信息。</ip2></ip1></ip2></ip1></ip2></ip1></ip></token></p>
<p>首先，在 Swarm 管理节点（192.168.0.2）上新建一个文件，把要加入集群的机器的 Docker daemon 信息写入文件：</p>
<p>$ tee /tmp/cluster_info &lt;&lt;-‘EOF’<br>192.168.0.2:2375<br>192.168.0.3:2375<br>EOF<br>然后，本地执行 swarm manage 命令，并指定服务发现机制为本地文件，注意因为是容器方式运行 manager，需要将本地文件挂载到容器内。</p>
<p>$ docker run -d -p 12375:2375 -v /tmp/cluster_info:/tmp/cluster_info swarm manage file:///tmp/cluster_info<br>接下来就可以通过使用 Swarm 服务来进行管理了，例如使用 info 查看所有节点的信息。</p>
<p>$ docker -H 192.168.0.2:12375 info<br>Containers: 18<br>Images: 36<br>Role: primary<br>Strategy: spread<br>Filters: health, port, dependency, affinity, constraint<br>Nodes: 2<br> Host-1: 192.168.0.2:2375<br>  └ Containers: 15<br>  └ Reserved CPUs: 0 / 4<br>  └ Reserved Memory: 1 GiB / 4.053 GiB<br>  └ Labels: executiondriver=native-0.2, kernelversion=3.16.0-43-generic, operatingsystem=Ubuntu 14.04.3 LTS, storagedriver=aufs<br> Host-2: 192.168.0.3:2375<br>  └ Containers: 3<br>  └ Reserved CPUs: 0 / 8<br>  └ Reserved Memory: 0 B / 16.46 GiB<br>  └ Labels: executiondriver=native-0.2, kernelversion=3.16.0-30-generic, operatingsystem=Ubuntu 14.04.3 LTS, storagedriver=aufs<br>CPUs: 12<br>Total Memory: 20.51 GiB<br>Name: e71eb5f1d48b<br>其它发现服务后端<br>其它服务发现后端的使用方法，也是大同小异，不同之处在于使用 Swarm 命令时指定的路径格式不同。</p>
<p>例如，对于前面介绍的 consul 服务后端来说。</p>
<p>快速部署一个 consul 服务的命令为：</p>
<p>$ docker run -d -p 8500:8500 –name=consul progrium/consul -server -bootstrap<br>之后创建 Swarm 的管理服务，指定使用 consul 服务，管理端口监听在本地的 4000 端口。</p>
<p>$ docker run -d -p 4000:4000 swarm manage -H :4000 –replication –advertise &lt;manager_ip&gt;:4000 consul://&lt;consul_ip&gt;:8500<br>Swarm 节点注册时候命令格式类似于：</p>
<p>$ swarm join –advertise=&lt;node_ip:2375&gt; consul://&lt;consul_addr&gt;/<optional path="" prefix=""><br>对于 etcd 服务后端来说，节点注册时候命令格式类似于：</optional></p>
<p>$ swarm join –addr=&lt;node_addr:2375&gt; etcd://&lt;etcd_addr1&gt;,&lt;etcd_addr2&gt;/<optional path="" prefix=""><br>启动管理服务时候，格式类似于：</optional></p>
<p>$ swarm manage -H tcp://&lt;manager_ip&gt;:4000 etcd://&lt;etcd_addr1&gt;,&lt;etcd_addr2&gt;/<optional path="" prefix=""><br>地址和端口的范围匹配<br>对于基于文件，以及手动指定节点信息两种服务发现后端机制来说，其中地址和端口域可以支持指定一个范围，以一次性指定多个地址。 例如：</optional></p>
<p>192.168.0.[2:10]:2375 代表 192.168.0.2:2375 – 192.168.0.10:2375 一共 9 个地址；<br>192.168.0.2:[2:9]375 代表 192.168.0.2:2375 – 192.168.0.2:9375 一共 8 个地址。<br>Swarm 中的调度器<br>调度是集群十分重要的功能，Swarm 目前支持三种调度策略：spread、binpack 和 random。</p>
<p>在执行swarm manage命令启动管理服务的时候，可以通过 –strategy 参数指定调度策略，默认的是 spread。</p>
<p>简单来说，这三种调度策略的优化目标如下：</p>
<p>spread：如果节点配置相同，选择一个正在运行的容器数量最少的那个节点，即尽量平摊容器到各个节点；<br>binpack：跟 spread 相反，尽可能的把所有的容器放在一台节点上面运行，即尽量少用节点，避免容器碎片化。<br>random：直接随机分配，不考虑集群中节点的状态，方便进行测试使用。<br>spread 调度策略<br>仍然以之前创建好的集群为例，来演示下 spread 策略的行为。</p>
<p>在 192.168.0.2 节点启动管理服务，管理 token://946d65606f7c2f49766e4dddac5b4365 的集群。</p>
<p>$ docker run -d -p 12375:2375 swarm manage  –strategy “spread” token://946d65606f7c2f49766e4dddac5b4365<br>c6f25e6e6abbe45c8bcf75ac674f2b64d5f31a5c6070d64ba954a0309b197930<br>列出集群中节点。</p>
<p>$ docker run –rm swarm list token://946d65606f7c2f49766e4dddac5b4365<br>192.168.0.3:2375<br>192.168.0.2:2375<br>此时，两个节点上除了 swarm 外都没有运行其它容器。</p>
<p>启动一个 ubuntu 容器。</p>
<p>$ docker -H 192.168.0.2:12375 run -d ubuntu:14.04 ping 127.0.0.1<br>bac3dfda5306181140fc959969d738549d607bc598390f57bdd432d86f16f069<br>查看发现它实际上被调度到了 192.168.0.3 节点（当节点配置相同时候，初始节点随机选择）。</p>
<p>再次启动一个 ubuntu 容器。</p>
<p>$ docker -H 192.168.0.2:12375 run -d ubuntu:14.04 ping 127.0.0.1<br>8247067ba3a31e0cb692a8373405f95920a10389ce3c2a07091408281695281c<br>查看它的位置，发现被调度到了另外一个节点：192.168.0.2 节点。</p>
<p>$ docker -H 192.168.0.2:12375 ps<br>CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                         NAMES<br>8247067ba3a3        ubuntu:14.04        “ping 127.0.0.1”         1 minutes ago       Up 1 minutes                            Host-2/sick_galileo<br>bac3dfda5306        ubuntu:14.04        “ping 127.0.0.1”         2 minutes ago       Up 2 minutes                            Host-3/compassionate_ritchie<br>当节点配置不同的时候，spread会更愿意分配到配置较高的节点上。</p>
<p>binpack 调度策略<br>现在来看看 binpack 策略下的情况。</p>
<p>直接启动若干 ubuntu 容器，并查看它们的位置。</p>
<p>$ docker -H 192.168.0.2:12375 run -d ubuntu:14.04 ping 127.0.0.1<br>$ docker -H 192.168.0.2:12375 ps<br>CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                         NAMES<br>4c4f45eba866        ubuntu:14.04        “ping 127.0.0.1”         3 minutes ago       Up 3 minutes                            Host-3/hopeful_brown<br>5e650541233c        ubuntu:14.04        “ping 127.0.0.1”         3 minutes ago       Up 3 minutes                            Host-3/pensive_wright<br>99c5a092530a        ubuntu:14.04        “ping 127.0.0.1”         3 minutes ago       Up 3 minutes                            Host-3/naughty_engelbart<br>4ab392c26eb2        ubuntu:14.04        “ping 127.0.0.1”         3 minutes ago       Up 3 minutes                            Host-3/thirsty_mclean<br>可以看到，所有的容器都是分布在同一个节点（192.168.0.3）上运行的。</p>
<p>Swarm 中的过滤器<br>Swarm 的调度器可以按照指定调度策略自动分配容器到节点。但有些时候希望能对这些分配加以干预。比如说，让 IO 敏感的容器分配到安装了 SSD 的节点上；让计算敏感的容器分配到 CPU 核数多的机器上；让网络敏感的容器分配到高带宽的机房；让某些容器尽量放同一个节点……。</p>
<p>这可以通过过滤器（filter）来实现，目前支持 Constraint、Affinity、Port、Dependency、Health等五种过滤器。</p>
<p>Constraint 过滤器<br>Constraint 过滤器是绑定到节点的键值对，相当于给节点添加标签。</p>
<p>可在启动 Docker 服务的时候指定，例如指定某个节点颜色为 red。</p>
<p>$ sudo docker daemon –label color=red -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock<br>同样的，可以写在 Docker 服务的配置文件里面（以 Ubuntu 14.04 为例，是 /etc/default/docker）。</p>
<p>DOCKER_OPTS=”–label color=red -H 0.0.0.0:2375 -H unix:///var/run/docker.sock”<br>使用 Swarm 启动容器的时候，采用 -e constarint:key=value 的形式，可以过滤选择出匹配条件的节点。</p>
<p>例如，我们将 192.168.0.2 节点打上红色标签，192.168.0.3 节点打上绿色标签。</p>
<p>然后，分别启动两个容器，指定使用过滤器分别为红色和绿色。</p>
<p>$ docker -H 192.168.0.2:12375 run -d -e constraint:color==red ubuntu:14.04 ping 127.0.0.1<br>252ffb48e64e9858c72241f5eedf6a3e4571b1ad926faf091db3e26672370f64<br>$ docker -H 192.168.0.2:12375 run -d -e constraint:color==green ubuntu:14.04 ping 127.0.0.1<br>3d6f8d7af8583416b17061d038545240c9e5c3be7067935d3ef2fbddce4b8136<br>注：指定标签中间是两个等号</p>
<p>查看它们将被分配到指定节点上。</p>
<p>$ docker -H 192.168.0.2:12375 ps<br>CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                         NAMES<br>252ffb48e64e        ubuntu:14.04        “ping 127.0.0.1”         1 minutes ago       Up 1 minutes                            Host-2/sick_galileo<br>3d6f8d7af858        ubuntu:14.04        “ping 127.0.0.1”         2 minutes ago       Up 2 minutes                            Host-3/compassionate_ritchie<br>另外，Docker 内置了一些常见的过滤器，包括 node、storagedriver、executiondriver、kernelversion、operatingsystem 等。这些值可以通过 docker info 命令查看。</p>
<p>例如，目前集群中各个节点的信息为：</p>
<p>$ docker -H 192.168.0.2:12375 info<br>Containers: 5<br>Images: 39<br>Role: primary<br>Strategy: spread<br>Filters: health, port, dependency, affinity, constraint<br>Nodes: 2<br> Host-2: 192.168.0.2:2375<br>  └ Containers: 4<br>  └ Reserved CPUs: 0 / 4<br>  └ Reserved Memory: 1 GiB / 4.053 GiB<br>  └ Labels: color=red, executiondriver=native-0.2, kernelversion=3.16.0-43-generic, operatingsystem=Ubuntu 14.04.3 LTS, storagedriver=aufs<br> Host-3: 192.168.0.3:2375<br>  └ Containers: 1<br>  └ Reserved CPUs: 0 / 8<br>  └ Reserved Memory: 0 B / 16.46 GiB<br>  └ Labels: color=green, executiondriver=native-0.2, kernelversion=3.16.0-30-generic, operatingsystem=Ubuntu 14.04.3 LTS, storagedriver=aufs<br>CPUs: 12<br>Total Memory: 20.51 GiB<br>Name: 946d65606f7c<br>Affinity 过滤器<br>Affinity 过滤器允许用户在启动一个容器的时候，让它分配到某个已有容器的节点上。</p>
<p>例如，下面我们将启动一个 nginx 容器，让它分配到已经运行某个 ubuntu 容器的节点上。</p>
<p>在 Constraint 过滤器的示例中，我们分别启动了两个 ubuntu 容器 sick_galileo 和 compassionate_ritchie，分别在 Host-2 和 Host-3 上。</p>
<p>现在启动一个 nginx 容器，让它跟容器 sick_galileo 放在一起，都放到 Host-2 节点上。可以通过 -e affinity:container==<name or="" id=""> 参数来实现。</name></p>
<p>$ docker -H 192.168.0.2:12375 run -d -e affinity:container==sick_galileo nginx<br>然后启动一个 redis 容器，让它跟容器 compassionate_ritchie 放在一起，都放到 Host-3 节点上。</p>
<p>$ docker -H 192.168.0.2:12375 run -d -e affinity:container==compassionate_ritchie redis<br>查看所有容器运行情况。</p>
<p>$ docker -H 192.168.0.2:12375 ps<br>CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                         NAMES<br>0a32f15aa8ee        redis               “/entrypoint.sh redis”   2 seconds ago       Up 1 seconds        6379/tcp                  Host-3/awesome_darwin<br>d2b9a53e67d5        nginx               “nginx -g ‘daemon off”   29 seconds ago      Up 28 seconds       80/tcp, 443/tcp               Host-2/fervent_wilson<br>252ffb48e64e        ubuntu:14.04        “ping 127.0.0.1”         2 minutes ago       Up 2 minutes                            Host-2/sick_galileo<br>3d6f8d7af858        ubuntu:14.04        “ping 127.0.0.1”         3 minutes ago       Up 3 minutes                            Host-3/compassionate_ritchie<br>其它过滤器<br>其它过滤器的使用方法也是大同小异，例如通过 -e affinity:image==<name or="" id=""> 来选择拥有指定镜像的节点；通过 -e affinity:label_name==value 来选择拥有指定标签的容器所允许的节点。</name></p>
<p>此外，当容器端口需要映射到宿主机指定端口号的时候，Swarm 也会自动分配容器到指定宿主机端口可用的节点。</p>
<p>当不同容器之间存在数据卷或链接依赖的时候，Swarm 会分配这些容器到同一个节点上。</p>
<p>本章小结<br>本章笔者介绍了 Docker Swarm 的安装、使用和主要功能。</p>
<p>通过使用 Swarm，用户可以将若干 Docker 主机节点组成的集群当作一个大的虚拟 Docker 主机使用。并且，原先基于单机的 Docker 应用，可以无缝的迁移到 Swarm 上来。</p>
<p>实现这些功能的前提是服务自动发现能力。在现代分布式系统中，服务的自动发现、注册、更新等能力将成为系统的基本保障和重要基础。</p>
<p>在生产环境中，Swarm 的管理节点和发现服务后端要采用高可用性上的保护，可以采用集群模式。</p>
<p>值得一提的是，Swarm V2 功能已经被无缝嵌入到了 Docker 1.12+ 版本中，用户今后可以直接使用 Docker 命令来完成相关功能的配置，这将使得集群功能的管理更加简便。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kxinter.github.io/kxinter.gitub.io/kxinter.gitub.io/2018/08/27/Openstack云镜像制作-Centos7篇/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/kxinter.gitub.io/images/touxiang.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OperationMAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/kxinter.gitub.io/2018/08/27/Openstack云镜像制作-Centos7篇/" itemprop="url">Openstack云镜像制作-Centos7篇</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-27T11:31:29+08:00">
                2018-08-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/kxinter.gitub.io/categories/云计算/" itemprop="url" rel="index">
                    <span itemprop="name">云计算</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一、制作步骤"><a href="#一、制作步骤" class="headerlink" title="一、制作步骤"></a>一、制作步骤</h1><h2 id="1、安装kvm"><a href="#1、安装kvm" class="headerlink" title="1、安装kvm"></a>1、安装kvm</h2><p>参考centos 7系统安装配置kvm软件步骤</p>
<p><strong>1、创建虚拟硬盘大小10G     名称：centos7-dis.qcow2</strong></p>
<p><strong>2、安装系统</strong></p>
<blockquote>
<p>注意一：分区，分区的时候只给”/“ 根目录分一个区即可，其他都不要。格式ext4<br>注意二：网络设置方面，确保你的网卡eth0是DHCP状态的，而且请务必勾上”auto connect”的对勾</p>
</blockquote>
<h2 id="2、进入虚拟机系统操作"><a href="#2、进入虚拟机系统操作" class="headerlink" title="2、进入虚拟机系统操作"></a>2、进入虚拟机系统操作</h2><p>关于CentOS镜像制作需要注意以下几点：</p>
<p><strong>(1) 修改网络信息 /etc/sysconfig/network-scripts/ifcfg-eth0 （删掉mac信息)，如下：</strong></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">TYPE</span>=Ethernet  </span><br><span class="line"><span class="attr">DEVICE</span>=eth0  </span><br><span class="line"><span class="attr">ONBOOT</span>=<span class="literal">yes</span>  </span><br><span class="line"><span class="attr">BOOTPROTO</span>=dhcp  </span><br><span class="line"><span class="attr">NM_CONTROLLED</span>=<span class="literal">no</span></span><br></pre></td></tr></table></figure>
<p><strong>(2) 删除已生成的网络设备规则，否则制作的镜像不能上网</strong><br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">rm</span> -rf /etc/udev/rules.<span class="keyword">d</span>/70-persistent-<span class="keyword">net</span>.rules</span><br></pre></td></tr></table></figure></p>
<p><strong>(3)增加一行到/etc/sysconfig/network</strong></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">NOZERCONF</span>=<span class="literal">yes</span></span><br></pre></td></tr></table></figure>
<p><strong>(4)安装cloud-init（可选），cloud-init可以在开机时进行密钥注入以及修改hostname等，关于cloud-init，陈沙克的一篇博文有介绍：<a href="http://www.chenshake.com/about-openstack-centos-mirror/" target="_blank" rel="noopener">http://www.chenshake.com/about-openstack-centos-mirror/</a></strong></p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y cloud-utils cloud-init parted</span><br></pre></td></tr></table></figure>
<p>修改配置文件/etc/cloud/cloud.cfg ，在cloud_init_modules 下面增加:</p>
<figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">- resolv-conf</span></span><br></pre></td></tr></table></figure>
<p><strong>(5)设置系统能自动获取openstack指定的hostname和ssh-key（可选）</strong><br>编辑/etc/rc.local文件，该文件在开机后会执行，加入以下代码：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">if [ ! -d /root/.ssh ]; then</span><br><span class="line">mkdir -p /root/.ssh</span><br><span class="line">chmod 700 /root/.ssh</span><br><span class="line">fi</span><br><span class="line"><span class="comment"># Fetch public key using HTTP</span></span><br><span class="line">ATTEMPTS=30</span><br><span class="line">FAILED=0</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">while [ ! -f /root/.ssh/authorized_keys ]; do</span><br><span class="line">curl -f http://169.254.169.254/latest/meta-data/public-keys/0/openssh-key &gt; /tmp/metadata-key 2&gt;/dev/null</span><br><span class="line">if [ $? -eq 0 ]; then</span><br><span class="line">cat /tmp/metadata-key &gt;&gt; /root/.ssh/authorized_keys</span><br><span class="line">chmod 0600 /root/.ssh/authorized_keys</span><br><span class="line">restorecon /root/.ssh/authorized_keys</span><br><span class="line">rm -f /tmp/metadata-key</span><br><span class="line">echo “Successfully retrieved<span class="keyword"> public</span> key from<span class="built_in"> instance </span>metadata”</span><br><span class="line">echo “*****************”</span><br><span class="line">echo “AUTHORIZED KEYS”</span><br><span class="line">echo “*****************”</span><br><span class="line">cat /root/.ssh/authorized_keys</span><br><span class="line">echo “*****************”</span><br><span class="line"></span><br><span class="line">curl -f http://169.254.169.254/latest/meta-data/hostname &gt; /tmp/metadata-hostname 2&gt;/dev/null</span><br><span class="line">if [ $? -eq 0 ]; then</span><br><span class="line">TEMP_HOST=`cat /tmp/metadata-hostname`</span><br><span class="line">sed -i “s/^HOSTNAME=.*$/HOSTNAME=$TEMP_HOST/g” /etc/sysconfig/network</span><br><span class="line">/bin/hostname $TEMP_HOST</span><br><span class="line">echo “Successfully retrieved hostname from<span class="built_in"> instance </span>metadata”</span><br><span class="line">echo “*****************”</span><br><span class="line">echo “HOSTNAME CONFIG”</span><br><span class="line">echo “*****************”</span><br><span class="line">cat /etc/sysconfig/network</span><br><span class="line">echo “*****************”</span><br><span class="line"></span><br><span class="line">else</span><br><span class="line">echo “Failed to retrieve hostname from<span class="built_in"> instance </span>metadata. This is a soft error so we’ll continue”</span><br><span class="line">fi</span><br><span class="line">rm -f /tmp/metadata-hostname</span><br><span class="line">else</span><br><span class="line">FAILED=$(($FAILED + 1))</span><br><span class="line">if [ $FAI<span class="class">LED -ge $ATTEMPTS ];</span> then</span><br><span class="line">echo “Failed to retrieve<span class="keyword"> public</span> key from<span class="built_in"> instance </span>metadata after $FAILED attempts, quitting”</span><br><span class="line">break</span><br><span class="line">fi</span><br><span class="line">echo “Could<span class="built_in"> not </span>retrieve<span class="keyword"> public</span> key from<span class="built_in"> instance </span>metadata (attempt <span class="comment">#$FAILED/$ATTEMPTS), retrying in 5 seconds…”</span></span><br><span class="line">sleep 5</span><br><span class="line">fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set a random pass on first boot</span></span><br><span class="line"><span class="keyword">if</span> [ -f /root/firstrun ]; <span class="keyword">then</span></span><br><span class="line">  dd <span class="keyword">if</span>=/dev/urandom count=50|md5sum|passwd --stdin root</span><br><span class="line">  passwd -l root</span><br><span class="line">  rm /root/firstrun</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -d /root/.ssh ]; <span class="keyword">then</span></span><br><span class="line">  mkdir -m 0700 -p /root/.ssh</span><br><span class="line">  restorecon /root/.ssh</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># Get the root ssh key setup</span></span><br><span class="line"><span class="comment"># Get the root ssh key setup</span></span><br><span class="line">ReTry=0</span><br><span class="line"><span class="keyword">while</span> [ ! -f /root/.ssh/authorized_keys ] &amp;&amp; [ <span class="variable">$ReTry</span> -lt 10 ]; <span class="keyword">do</span></span><br><span class="line">  sleep 2</span><br><span class="line">  curl -f http://169.254.169.254/latest/meta-data/public-keys/0/openssh-key &gt; /root/.ssh/pubkey</span><br><span class="line">  <span class="keyword">if</span> [ 0 -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    mv /root/.ssh/pubkey /root/.ssh/authorized_keys</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  ReTry=$[Retry+1]</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">chmod 600 /root/.ssh/authorized_keys &amp;&amp; restorecon /root/.ssh/authorized_keys</span><br></pre></td></tr></table></figure>
<p>主要目的就是获取hostname和公钥</p>
<p><strong>(6)其他</strong></p>
<p>route命令查看一下路由表</p>
<p>查看/etc/ssh/sshd_conf中PermitRootLogin是不是为yes</p>
<p>清除操作记录</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">清除登陆系统成功的记录</span><br><span class="line">[root<span class="variable">@localhost</span> root]<span class="comment"># echo &gt; /var/log/wtmp //此文件默认打开时乱码，可查到ip等信息</span></span><br><span class="line">[root<span class="variable">@localhost</span> root]<span class="comment"># last //此时即查不到用户登录信息</span></span><br><span class="line"></span><br><span class="line">清除登陆系统失败的记录</span><br><span class="line">[root<span class="variable">@localhost</span> root]<span class="comment"># echo &gt; /var/log/btmp //此文件默认打开时乱码，可查到登陆失败信息</span></span><br><span class="line">[root<span class="variable">@localhost</span> root]<span class="comment"># lastb //查不到登陆失败信息</span></span><br><span class="line"> </span><br><span class="line">清除历史执行命令</span><br><span class="line">[root<span class="variable">@localhost</span> root]<span class="comment"># history -c //清空历史执行命令</span></span><br><span class="line">[root<span class="variable">@localhost</span> root]<span class="comment"># echo &gt; ./.bash_history //或清空用户目录下的这个文件即可</span></span><br><span class="line"> </span><br><span class="line">导入空历史记录</span><br><span class="line">[root<span class="variable">@localhost</span> root]<span class="comment"># vi /root/history //新建记录文件</span></span><br><span class="line">[root<span class="variable">@localhost</span> root]<span class="comment"># history -c //清除记录 </span></span><br><span class="line">[root<span class="variable">@localhost</span> root]<span class="comment"># history -r /root/history.txt //导入记录 </span></span><br><span class="line">[root<span class="variable">@localhost</span> root]<span class="comment"># history //查询导入结果</span></span><br><span class="line"></span><br><span class="line">example </span><br><span class="line">[root<span class="variable">@localhost</span> root]<span class="comment"># vi /root/history</span></span><br><span class="line">[root<span class="variable">@localhost</span> root]<span class="comment"># history -c </span></span><br><span class="line">[root<span class="variable">@localhost</span> root]<span class="comment"># history -r /root/history.txt </span></span><br><span class="line">[root<span class="variable">@localhost</span> root]<span class="comment"># history </span></span><br><span class="line">[root<span class="variable">@localhost</span> root]<span class="comment"># echo &gt; /var/log/wtmp  </span></span><br><span class="line">[root<span class="variable">@localhost</span> root]<span class="comment"># last</span></span><br><span class="line">[root<span class="variable">@localhost</span> root]<span class="comment"># echo &gt; /var/log/btmp</span></span><br><span class="line">[root<span class="variable">@localhost</span> root]<span class="comment"># lastb </span></span><br><span class="line">[root<span class="variable">@localhost</span> root]<span class="comment"># history -c </span></span><br><span class="line">[root<span class="variable">@localhost</span> root]<span class="comment"># echo &gt; ./.bash_history</span></span><br><span class="line">[root<span class="variable">@localhost</span> root]<span class="comment"># history</span></span><br></pre></td></tr></table></figure>
<p>关闭虚拟机</p>
<h2 id="3、宿主机操作"><a href="#3、宿主机操作" class="headerlink" title="3、宿主机操作"></a>3、宿主机操作</h2><p>资料：<a href="https://www.cnblogs.com/BuildingHome/p/4834859.html" target="_blank" rel="noopener">KVM镜像管理利器-guestfish使用详解</a></p>
<p>1）安装guestfish套件安装</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install libguestfs-tools</span><br></pre></td></tr></table></figure>
<p>2）压缩镜像文件</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ virt-sparsify --<span class="keyword">compress</span> centos7-<span class="keyword">dis</span>.qcow2 centos7-<span class="keyword">dis</span>-cloud.qcow2</span><br></pre></td></tr></table></figure>
<p><img src="1.png" alt="enter description here"><br>镜像制作完成</p>
<p>上传openstack</p>
<h1 id="二、参考文档："><a href="#二、参考文档：" class="headerlink" title="二、参考文档："></a>二、参考文档：</h1><p><a href="http://www.cnblogs.com/gorlf/p/4140740.html" target="_blank" rel="noopener">penStack镜像制作-CentOS</a></p>
<p><a href="http://www.aboutyun.com/thread-6617-1-1.html" target="_blank" rel="noopener">openstack镜像制作思路、指导及问题总结</a></p>
<p><a href="http://blog.csdn.net/xiegh2014/article/details/53248403" target="_blank" rel="noopener">openstack制作centos6</a>.5镜像</p>
<p><a href="http://www.linuxidc.com/Linux/2012-10/72483.htm" target="_blank" rel="noopener">制作OpenStack上使用的CentOS系统镜像</a></p>
<p><a href="https://www.cnblogs.com/BuildingHome/p/4834859.html" target="_blank" rel="noopener">KVM镜像管理利器-guestfish使用详解</a></p>
<p><a href="http://blog.csdn.net/leadway123/article/details/49155421" target="_blank" rel="noopener">CentOS清除用户登录记录和命令历史方法</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kxinter.github.io/kxinter.gitub.io/kxinter.gitub.io/2018/08/27/VMware共享文件夹设置方法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/kxinter.gitub.io/images/touxiang.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OperationMAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/kxinter.gitub.io/2018/08/27/VMware共享文件夹设置方法/" itemprop="url">VMware共享文件夹设置方法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-27T11:24:35+08:00">
                2018-08-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/kxinter.gitub.io/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一、安装包依赖："><a href="#一、安装包依赖：" class="headerlink" title="一、安装包依赖："></a>一、安装包依赖：</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yum -y <span class="keyword">install</span> kernel-devel-$(uname -r) </span><br><span class="line">$ yum -y <span class="keyword">install</span> net-tools perl gcc gcc-c++</span><br></pre></td></tr></table></figure>
<h1 id="二、安装vmtool"><a href="#二、安装vmtool" class="headerlink" title="二、安装vmtool"></a>二、安装vmtool</h1><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ mount <span class="string">/dev/cdrom</span> <span class="string">/home/tmp</span></span><br><span class="line">$ cp <span class="string">/home/tmp/VMwareTools-9.6.0-1294478.tar.gz</span> <span class="string">/tmp</span></span><br><span class="line">$ <span class="keyword">cd</span> <span class="string">/tmp</span></span><br><span class="line">$ tar -zxvf VMwareTools-9.6.0-1294478.tar.gz</span><br><span class="line">$ <span class="keyword">cd</span> vmware-tools-distrib</span><br><span class="line">$ <span class="string">./vmware-install.pl</span></span><br></pre></td></tr></table></figure>
<p>按提示操作即可。</p>
<h1 id="三、问题"><a href="#三、问题" class="headerlink" title="三、问题"></a>三、问题</h1><p>有/mnt/hgfs但没有共享文件的解决方法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mount -t vmhgfs .host:/  /mnt/hgfs</span><br><span class="line">Error: cannot mount filesystem: No such device</span><br></pre></td></tr></table></figure>
<p>这时不能用mount工具挂载，而是得用vmhgfs-fuse，需要安装工具包</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ yum install <span class="keyword">open</span>-<span class="keyword">vm</span>-tools-devel -<span class="keyword">y</span></span><br><span class="line">有的源的名字并不一定为<span class="keyword">open</span>-<span class="keyword">vm</span>-tools-devel(centos) ，而是<span class="keyword">open</span>-<span class="keyword">vm</span>-dkms(unbuntu)</span><br><span class="line">执行：vmhgfs-fuse .hos<span class="variable">t:</span>/ /mnt/hgfs</span><br></pre></td></tr></table></figure>
<p>此时进入/mnt/hgfs就能看到你设置的共享文件夹了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kxinter.github.io/kxinter.gitub.io/kxinter.gitub.io/2018/08/27/SSL证书制作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/kxinter.gitub.io/images/touxiang.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OperationMAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/kxinter.gitub.io/2018/08/27/SSL证书制作/" itemprop="url">SSL证书制作</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-27T11:13:09+08:00">
                2018-08-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/kxinter.gitub.io/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一、环境"><a href="#一、环境" class="headerlink" title="一、环境"></a>一、环境</h1><p>OS:centos 7.3</p>
<h1 id="二、步骤"><a href="#二、步骤" class="headerlink" title="二、步骤"></a>二、步骤</h1><h2 id="1、安装openssl"><a href="#1、安装openssl" class="headerlink" title="1、安装openssl"></a>1、安装openssl</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install opensll</span><br></pre></td></tr></table></figure>
<h2 id="2、制作CA证书"><a href="#2、制作CA证书" class="headerlink" title="2、制作CA证书"></a>2、制作CA证书</h2><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ openssl genrsa -des3 -out my-ca.<span class="type">key</span> <span class="number">2048</span></span><br><span class="line">$ openssl req -new -x509 -days <span class="number">3650</span> -<span class="type">key</span> my-ca.<span class="type">key</span> -out my-ca.crt</span><br></pre></td></tr></table></figure>
<h2 id="3、生成服务器证书"><a href="#3、生成服务器证书" class="headerlink" title="3、生成服务器证书"></a>3、生成服务器证书</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ openssl genrsa -des3 -out mars-server<span class="selector-class">.key</span> <span class="number">1024</span></span><br><span class="line">$ openssl req -new -key mars-server<span class="selector-class">.key</span> -out mars-server.csr</span><br><span class="line">$ openssl x509 -req -<span class="keyword">in</span> mars-server<span class="selector-class">.csr</span> -out mars-server<span class="selector-class">.crt</span> -sha1 -CA my-ca<span class="selector-class">.crt</span> -CAkey my-ca<span class="selector-class">.key</span> -CAcreateserial -days <span class="number">3650</span></span><br></pre></td></tr></table></figure>
<h2 id="4、生成无密码密钥"><a href="#4、生成无密码密钥" class="headerlink" title="4、生成无密码密钥"></a>4、生成无密码密钥</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl rsa -<span class="keyword">in</span> mars-server<span class="selector-class">.key</span> -out mars-server<span class="selector-class">.key</span><span class="selector-class">.insecure</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kxinter.github.io/kxinter.gitub.io/kxinter.gitub.io/2018/08/23/proxy-pass反向代理配置中url后面加不加-的说明/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/kxinter.gitub.io/images/touxiang.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OperationMAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/kxinter.gitub.io/2018/08/23/proxy-pass反向代理配置中url后面加不加-的说明/" itemprop="url">proxy_pass反向代理配置中url后面加不加/的说明</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-23T17:28:53+08:00">
                2018-08-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/kxinter.gitub.io/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>OS:centos7</p>
<p>nginx _proxy服务器：192.168.1.23</p>
<p>web服务器：192.168.1.5</p>
<h1 id="情况说明"><a href="#情况说明" class="headerlink" title="情况说明"></a>情况说明</h1><h2 id="path路径后面加”-”"><a href="#path路径后面加”-”" class="headerlink" title="path路径后面加”/”"></a>path路径后面加”/”</h2><h3 id="情况一"><a href="#情况一" class="headerlink" title="情况一"></a>情况一</h3><p>NGINX配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost conf.d]# cat test.conf</span><br><span class="line">server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name localhost;</span><br><span class="line">location / &#123;</span><br><span class="line">root /var/www/html;</span><br><span class="line">index index.html;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">location  /proxy/ &#123;</span><br><span class="line">          proxy_pass http://192.168.1.5:8090/;</span><br><span class="line">		  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，访问<a href="http://192.168.1.23/proxy/就会被代理到http://192.168.1.5:8090/。匹配的proxy目录不需要存在根目录/var/www/html里面" target="_blank" rel="noopener">http://192.168.1.23/proxy/就会被代理到http://192.168.1.5:8090/。匹配的proxy目录不需要存在根目录/var/www/html里面</a></p>
<blockquote>
<p>注意，终端里如果访问<a href="http://192.168.1.23/proxy（即后面不带”/”），则会访问失败！因为proxy_pass配置的url后面加了”/”" target="_blank" rel="noopener">http://192.168.1.23/proxy（即后面不带”/”），则会访问失败！因为proxy_pass配置的url后面加了”/”</a></p>
</blockquote>
<p>访问结果如下</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost conf.d]<span class="meta"># curl http:<span class="comment">//192.168.1.23/proxy/</span></span></span><br><span class="line">this is <span class="number">192.168</span><span class="number">.1</span><span class="number">.5</span></span><br><span class="line">[root@localhost conf.d]<span class="meta"># curl http:<span class="comment">//192.168.1.23/proxy</span></span></span><br><span class="line"><span class="params">&lt;html&gt;</span></span><br><span class="line"><span class="params">&lt;head&gt;</span><span class="params">&lt;title&gt;</span><span class="number">301</span> Moved Permanently<span class="params">&lt;/title&gt;</span><span class="params">&lt;/head&gt;</span></span><br><span class="line"><span class="params">&lt;body bgcolor="white"&gt;</span></span><br><span class="line"><span class="params">&lt;center&gt;</span><span class="params">&lt;h1&gt;</span><span class="number">301</span> Moved Permanently<span class="params">&lt;/h1&gt;</span><span class="params">&lt;/center&gt;</span></span><br><span class="line"><span class="params">&lt;hr&gt;</span><span class="params">&lt;center&gt;</span>nginx/<span class="number">1.10</span><span class="number">.3</span><span class="params">&lt;/center&gt;</span></span><br><span class="line"><span class="params">&lt;/body&gt;</span></span><br><span class="line"><span class="params">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure>
<p>页面访问<a href="http://103.110.186.23/proxy的时候，会自动加上”/”（同理是由于proxy_pass配置的url后面加了”/”），并反代到http://103.110.186.5:8090的结果。" target="_blank" rel="noopener">http://103.110.186.23/proxy的时候，会自动加上”/”（同理是由于proxy_pass配置的url后面加了”/”），并反代到http://103.110.186.5:8090的结果。</a><br><img src="1.png" alt="enter description here"></p>
<h3 id="情况二"><a href="#情况二" class="headerlink" title="情况二"></a>情况二</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost conf.d]<span class="comment"># cat test.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">listen <span class="number">80</span>;</span><br><span class="line">server_name localhost;</span><br><span class="line"><span class="keyword">location</span> <span class="title">/ &#123;</span></span><br><span class="line"><span class="title">root</span> /var/www/html;</span><br><span class="line">index index.html;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">location</span>  <span class="title">/proxy</span>/ &#123;</span><br><span class="line">          proxy_pass http://<span class="number">192.168</span>.<span class="number">1.5</span>:<span class="number">8090</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@localhost conf.d]<span class="comment"># service nginx restart</span></span><br><span class="line">Redirecting to /bin/systemctl restart  nginx.service</span><br><span class="line"><span class="comment">## 那么访问http://192.168.1.23/proxy或http://192.168.1.23/proxy/，都会失败！</span></span><br><span class="line"><span class="comment">## 这样配置后，访问http://192.168.1.23/proxy/就会被反向代理到http://192.168.1.5:8090/proxy/</span></span><br></pre></td></tr></table></figure>
<p><img src="2.png" alt="enter description here"></p>
<h3 id="情况三"><a href="#情况三" class="headerlink" title="情况三"></a>情况三</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost <span class="keyword">conf</span>.<span class="keyword">d</span>]# <span class="keyword">cat</span> <span class="keyword">test</span>.<span class="keyword">conf</span></span><br><span class="line">server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name localhost;</span><br><span class="line">location / &#123;</span><br><span class="line">root /<span class="keyword">var</span>/www/html;</span><br><span class="line">index index.html;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">location  /proxy/ &#123;</span><br><span class="line">          proxy_pass http:<span class="comment">//192.168.1.5:8090/haha/;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@localhost <span class="keyword">conf</span>.<span class="keyword">d</span>]# service nginx restart</span><br><span class="line">Redirecting to /bin/systemctl restart  nginx.service</span><br><span class="line">[root@localhost <span class="keyword">conf</span>.<span class="keyword">d</span>]# curl http:<span class="comment">//192.168.1.23/proxy/</span></span><br><span class="line">192.168.1.5  haha-index.html</span><br></pre></td></tr></table></figure>
<p>这样配置的话，访问<a href="http://103.110.186.23/proxy代理到http://192.168.1.5:8090/haha/" target="_blank" rel="noopener">http://103.110.186.23/proxy代理到http://192.168.1.5:8090/haha/</a><br><img src="3.png" alt="enter description here"></p>
<h3 id="情况四"><a href="#情况四" class="headerlink" title="情况四"></a>情况四</h3><p>相对于第三种配置的url不加”/”</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost conf.d]# cat test.conf</span><br><span class="line">server &#123;</span><br><span class="line">listen <span class="number">80</span>;</span><br><span class="line">server_name localhost;</span><br><span class="line">location / &#123;</span><br><span class="line">root /var/www/html;</span><br><span class="line">index index.html;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">location  /proxy/ &#123;</span><br><span class="line">          proxy_pass http:<span class="comment">//192.168.1.5:8090/haha;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@localhost conf.d]# service nginx restart</span><br><span class="line">Redirecting to /bin/systemctl restart  nginx.service</span><br><span class="line">[root@localhost conf.d]# curl http:<span class="comment">//192.168.1.23/proxy/index.html</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.5</span>   hahaindex.html</span><br><span class="line"></span><br><span class="line">##################################### </span><br><span class="line">上面配置后，访问http:<span class="comment">//192.168.1.23/proxy/index.html就会被代理到http://192.168.1.5:8090/hahaindex.html</span></span><br><span class="line">同理，访问http:<span class="comment">//192.168.1.23/proxy/test.html就会被代理到http://192.168.1.5:8090/hahatest.html</span></span><br><span class="line">[root@localhost conf.d]# curl http:<span class="comment">//192.168.1.23/proxy/index.html</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.5</span>   hahaindex.html</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意，这种情况下，不能直接访问<a href="http://192.168.1.23/proxy/，后面就算是默认的index.html文件也要跟上，否则访问失败！" target="_blank" rel="noopener">http://192.168.1.23/proxy/，后面就算是默认的index.html文件也要跟上，否则访问失败！</a><br><img src="4.png" alt="enter description here"></p>
</blockquote>
<p>———————————————————————————————————————————<br>上面四种方式都是匹配的path路径后面加”/”，下面说下path路径后面不带”/”的情况：</p>
<h2 id="path路径后面不加”-”"><a href="#path路径后面不加”-”" class="headerlink" title="path路径后面不加”/”"></a>path路径后面不加”/”</h2><h3 id="情况一-1"><a href="#情况一-1" class="headerlink" title="情况一"></a>情况一</h3><p>proxy_pass后面url带”/”：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost conf.d]<span class="comment"># cat test.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">listen <span class="number">80</span>;</span><br><span class="line">server_name localhost;</span><br><span class="line"><span class="keyword">location</span> <span class="title">/ &#123;</span></span><br><span class="line"><span class="title">root</span> /var/www/html;</span><br><span class="line">index index.html;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">location</span>  <span class="title">/proxy</span> &#123;</span><br><span class="line">          proxy_pass http://<span class="number">192.168</span>.<span class="number">1.5</span>:<span class="number">8090</span>/;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@localhost conf.d]<span class="comment"># service nginx restart</span></span><br><span class="line">Redirecting to /bin/systemctl restart  nginx.service</span><br></pre></td></tr></table></figure>
<p><img src="5.png" alt="enter description here"></p>
<h3 id="情况二，"><a href="#情况二，" class="headerlink" title="情况二，"></a>情况二，</h3><p>proxy_pass后面url不带”/”</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost conf.d]<span class="comment"># cat test.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">listen <span class="number">80</span>;</span><br><span class="line">server_name localhost;</span><br><span class="line"><span class="keyword">location</span> <span class="title">/ &#123;</span></span><br><span class="line"><span class="title">root</span> /var/www/html;</span><br><span class="line">index index.html;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">location</span>  <span class="title">/proxy</span> &#123;</span><br><span class="line">          proxy_pass http://<span class="number">192.168</span>.<span class="number">1.5</span>:<span class="number">8090</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@localhost conf.d]<span class="comment"># service nginx restart</span></span><br><span class="line">Redirecting to /bin/systemctl restart  nginx.service</span><br><span class="line">[root@localhost conf.d]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>这样配置的话，访问<a href="http://103.110.186.23/proxy会自动加上”/”（即变成http://103.110.186.23/proxy/），代理到192.168.1.5:8090/proxy/" target="_blank" rel="noopener">http://103.110.186.23/proxy会自动加上”/”（即变成http://103.110.186.23/proxy/），代理到192.168.1.5:8090/proxy/</a><br><img src="7.png" alt="enter description here"></p>
<h3 id="情况三-1"><a href="#情况三-1" class="headerlink" title="情况三"></a>情况三</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost conf.d]<span class="comment"># cat test.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">listen <span class="number">80</span>;</span><br><span class="line">server_name localhost;</span><br><span class="line"><span class="keyword">location</span> <span class="title">/ &#123;</span></span><br><span class="line"><span class="title">root</span> /var/www/html;</span><br><span class="line">index index.html;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">location</span>  <span class="title">/proxy</span> &#123;</span><br><span class="line">          proxy_pass http://<span class="number">192.168</span>.<span class="number">1.5</span>:<span class="number">8090</span>/haha/;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@localhost conf.d]<span class="comment"># service nginx restart</span></span><br><span class="line">Redirecting to /bin/systemctl restart  nginx.service</span><br></pre></td></tr></table></figure>
<p>这样配置的话，访问<a href="http://103.110.186.23/proxy会自动加上”/”（即变成http://103.110.186.23/proxy/），代理到http://192.168.1.5:8090/haha/" target="_blank" rel="noopener">http://103.110.186.23/proxy会自动加上”/”（即变成http://103.110.186.23/proxy/），代理到http://192.168.1.5:8090/haha/</a><br><img src="8.png" alt="enter description here"></p>
<h3 id="情况四-1"><a href="#情况四-1" class="headerlink" title="情况四"></a>情况四</h3><p>相对于第三种配置的url不加”/”</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost conf.d]<span class="comment"># cat test.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">listen <span class="number">80</span>;</span><br><span class="line">server_name localhost;</span><br><span class="line"><span class="keyword">location</span> <span class="title">/ &#123;</span></span><br><span class="line"><span class="title">root</span> /var/www/html;</span><br><span class="line">index index.html;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">location</span>  <span class="title">/proxy</span> &#123;</span><br><span class="line">          proxy_pass http://<span class="number">192.168</span>.<span class="number">1.5</span>:<span class="number">8090</span>/haha;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@localhost conf.d]<span class="comment"># service nginx restart</span></span><br><span class="line">Redirecting to /bin/systemctl restart  nginx.service</span><br></pre></td></tr></table></figure>
<p>这样配置的话，访问<a href="http://103.110.186.23/proxy，和第三种结果一样，同样被代理到http://192.168.1.5:8090/haha/" target="_blank" rel="noopener">http://103.110.186.23/proxy，和第三种结果一样，同样被代理到http://192.168.1.5:8090/haha/</a><br><img src="9.png" alt="enter description here"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kxinter.github.io/kxinter.gitub.io/kxinter.gitub.io/2018/08/23/Xmanager远程连接CentOS7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/kxinter.gitub.io/images/touxiang.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OperationMAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/kxinter.gitub.io/2018/08/23/Xmanager远程连接CentOS7/" itemprop="url">Xmanager远程连接CentOS7</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-23T17:04:02+08:00">
                2018-08-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/kxinter.gitub.io/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="安装epel源"><a href="#安装epel源" class="headerlink" title="安装epel源"></a>安装epel源</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> -y epel-<span class="keyword">release</span></span><br></pre></td></tr></table></figure>
<h1 id="安装lightdm和xfce"><a href="#安装lightdm和xfce" class="headerlink" title="安装lightdm和xfce"></a>安装lightdm和xfce</h1><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">yum install -y lightdm</span> </span><br><span class="line"><span class="attribute">yum groupinstall -y xfce</span></span><br></pre></td></tr></table></figure>
<h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vim</span> /etc/lightdm/lightdm.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<p>内容如下</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[XDMCPServer]</span></span><br><span class="line"><span class="attr">enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">177</span></span><br></pre></td></tr></table></figure>
<h2 id="将Display-Manager切换为lightdm"><a href="#将Display-Manager切换为lightdm" class="headerlink" title="将Display Manager切换为lightdm"></a>将Display Manager切换为lightdm</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">disable</span> gdm &amp;&amp; systemctl <span class="built_in">enable</span> lightdm</span><br></pre></td></tr></table></figure>
<h2 id="启动lightdm"><a href="#启动lightdm" class="headerlink" title="启动lightdm"></a>启动lightdm</h2><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">systemctl start lightdm</span></span><br></pre></td></tr></table></figure>
<h2 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h2><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="keyword">stop</span> firewalld.service</span><br></pre></td></tr></table></figure>
<h1 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h1><p>打开Xmanger客户端，选择XDMCP并输入服务器的ip，回车运行即可。<br>输入账号密码<br>然后就出现下图：（如果正常跳过这步）<br><img src="1.jpg" alt="enter description here"><br><strong>或者出现黑屏提示无法建立连接</strong><br>这是因为刚开始安装的是Gnome，所以系统默认使用它，现在要改成Xfce，最简单的方法就是把xfce.desktopz之外的文件都干掉。</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/share/xsessions/</span><br><span class="line"><span class="built_in">mkdir</span> bak</span><br><span class="line">mv gnome* bak</span><br><span class="line">systemctl <span class="built_in">restart</span> lightdm</span><br></pre></td></tr></table></figure>
<p>重新连接<br>一切正常操作之后就成功连接了。然后就可以快速便捷的工作了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kxinter.github.io/kxinter.gitub.io/kxinter.gitub.io/2018/08/23/编辑rc-local启动命令执行不成功处理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/kxinter.gitub.io/images/touxiang.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OperationMAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/kxinter.gitub.io/2018/08/23/编辑rc-local启动命令执行不成功处理/" itemprop="url">编辑rc.local启动命令执行不成功处理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-23T16:26:31+08:00">
                2018-08-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/kxinter.gitub.io/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="问题举例："><a href="#问题举例：" class="headerlink" title="问题举例："></a>问题举例：</h1><p>rc.local内容如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># THIS FILE IS ADDED FOR COMPATIBILITY PURPOSES</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># It is highly advisable to create own systemd services or udev rules</span></span><br><span class="line"><span class="comment"># to run scripts during boot instead of using this file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In contrast to previous versions due to parallel execution during boot</span></span><br><span class="line"><span class="comment"># this script will NOT be run after all other services.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please note that you must run 'chmod +x /etc/rc.d/rc.local' to ensure</span></span><br><span class="line"><span class="comment"># that this script will be executed during boot.</span></span><br><span class="line"></span><br><span class="line">touch /var/lock/subsys/<span class="built_in">local</span></span><br><span class="line">mount -t cifs -o username=backup,password=xxxxxxx //192.168.1.170/192.168.1.11/ /mnt/backup_data/</span><br><span class="line">/usr/<span class="built_in">local</span>/tomcat/bin/startup.sh</span><br></pre></td></tr></table></figure>
<p>挂载命令执行了，但tomcat没有启动</p>
<h1 id="问题原因及处理方法"><a href="#问题原因及处理方法" class="headerlink" title="问题原因及处理方法"></a>问题原因及处理方法</h1><h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><p>因java使用的是解压缩版，在/etc/profile内添加java的环境变量，系统启动时先执行的是rc.local,因此tomcat启动失败</p>
<h1 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h1><h2 id="方法1"><a href="#方法1" class="headerlink" title="方法1"></a>方法1</h2><p>在rc.local内添加java的环境变量命令（必须放在tomcat启动命令前）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/<span class="built_in">local</span>/java/jdk1.6.0_18</span><br><span class="line"><span class="built_in">export</span> JRE_HOME=/usr/<span class="built_in">local</span>/java/jdk1.6.0_18/jre</span><br></pre></td></tr></table></figure>
<h2 id="方法2"><a href="#方法2" class="headerlink" title="方法2"></a>方法2</h2><p>在tomcat的启动脚本内添加java路径<br>分别在tomcat_home/bin目录内的catalina.sh ，setclasspath.sh脚本前面指定JAVA_HOME路径</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/<span class="built_in">local</span>/java/jdk1.6.0_18</span><br><span class="line"><span class="built_in">export</span> JRE_HOME=/usr/<span class="built_in">local</span>/java/jdk1.6.0_18/jre</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kxinter.github.io/kxinter.gitub.io/kxinter.gitub.io/2018/08/23/docker私有仓库搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/kxinter.gitub.io/images/touxiang.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OperationMAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/kxinter.gitub.io/2018/08/23/docker私有仓库搭建/" itemprop="url">docker私有仓库搭建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-23T16:17:08+08:00">
                2018-08-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/kxinter.gitub.io/categories/Docker/" itemprop="url" rel="index">
                    <span itemprop="name">Docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="搭建仓库"><a href="#搭建仓库" class="headerlink" title="搭建仓库"></a>搭建仓库</h1><p>安装docker-ce,过程省略…….；运行以下命令启动仓库</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --name registry --restart always -d -p <span class="number">5000</span>:<span class="number">5000</span> -v /.<span class="symbol">registry:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">registry</span> <span class="title">registry</span></span></span><br></pre></td></tr></table></figure>
<h1 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h1><p>修改所有需要使用私有仓库的docker服务器（包括仓库服务器）的docker配置，在/etc/docker目录创建daemon.json文件内容如下：<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 下面这句表示表示开启5000端口的非安全模式，也就是http模式，否则在push或pull时会报https错误</span></span><br><span class="line">&#123; <span class="string">"insecure-registries"</span>:[<span class="string">"192.168.1.11:5000"</span>] &#125;</span><br><span class="line"><span class="meta"># 下面这句是使用阿里云镜像加速，提高外网官方仓库的下载速度，这里一起列出了，不是必须要添加的，和私有仓库没有关系。</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://cz0az3lb.mirror.aliyuncs.com"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以同时设置，写法如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">"insecure-registries"</span>:[<span class="string">"192.168.1.118:5000"</span>],</span><br><span class="line"><span class="attr">"registry-mirrors"</span>: [<span class="string">"http://192.168.1.118:5001"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重启docker服务，配置生效</p>
<h1 id="查询仓库镜像列表"><a href="#查询仓库镜像列表" class="headerlink" title="查询仓库镜像列表"></a>查询仓库镜像列表</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix-11 docker]<span class="comment"># curl -XGET http://192.168.1.11:5000/v2/_catalog</span></span><br><span class="line">&#123;<span class="string">"repositories"</span>:[<span class="string">"nginx"</span>]&#125;</span><br><span class="line"><span class="comment"># 显示镜像nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询镜像版本</span></span><br><span class="line"></span><br><span class="line">``` elixir</span><br><span class="line">[root@zabbix-11 docker]<span class="comment"># curl -XGET http://192.168.1.11:5000/v2/nginx/tags/list</span></span><br><span class="line">&#123;<span class="string">"name"</span>:<span class="string">"nginx"</span>,<span class="string">"tags"</span>:[<span class="string">"1"</span>,<span class="string">"1.13.7"</span>]&#125;</span><br><span class="line"><span class="comment">#查询nginx镜像的版本号，有1/1.13.7版本</span></span><br></pre></td></tr></table></figure>
<p>以上查询也可以在web页面查询，复制命令后方http链接地址就行。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kxinter.github.io/kxinter.gitub.io/kxinter.gitub.io/2018/08/23/zabbix3-4-7监控日志/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/kxinter.gitub.io/images/touxiang.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OperationMAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/kxinter.gitub.io/2018/08/23/zabbix3-4-7监控日志/" itemprop="url">zabbix3.4.7监控日志</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-23T16:01:47+08:00">
                2018-08-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/kxinter.gitub.io/categories/自动化运维/" itemprop="url" rel="index">
                    <span itemprop="name">自动化运维</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一、日志item介绍"><a href="#一、日志item介绍" class="headerlink" title="一、日志item介绍"></a>一、日志item介绍</h1><p>下面介绍zabbix另一个“重量级”的功能——日志文件监控，它最主要的是监控日志文件中有没有某个字符串的表达式，对应日志轮转与否，zabbix都支持。</p>
<p>在配置Item的时候，Type选择Zabbix agent (active)，这里主要需要配置的是Key。下面是监控日志的两种key——log和logtr。</p>
<p>log[/path/to/some/file,<regexp>,<encoding>,<maxlines>,<mode>,<output>]</output></mode></maxlines></encoding></regexp></p>
<p>logtr[/path/to/some/filename_format,<regexp>,<encoding>,<maxlines>,<mode>,<output>]</output></mode></maxlines></encoding></regexp></p>
<blockquote>
<p>◆ regexp：要匹配内容的正则表达式，或者直接写你要检索的内容也可以，例如我想检索带ERROR关键词的记录</p>
<p>◆ encoding：编码相关，留空即可</p>
<p>◆<br>maxlines：一次性最多提交多少行，这个参数覆盖配置文件zabbxi_agentd.conf中的’MaxLinesPerSecond’，我们也可以留空</p>
<p>◆ mode：默认是all，也可以是skip，skip会跳过老数据</p>
<p>◆ output：输出给zabbix<br>server的数据。可以是\1、\2一直\9，\1表示第一个正则表达式匹配出得内容，\2表示第二个正则表达式匹配错的内容。</p>
</blockquote>
<p><em>如果仔细看可以发现，第一个参数不一样，logrt的第一个参数可以使用正则表达式。针对日志回滚用得，例如我们每天都切割nginx日志，日志名位<a href="http://www.a.com_2015-01-01.log、www.a.com_2015-01-02.log等等，使用log肯定不合适，如果文件名使用正则，那么新增的日志文件会立即加入监控。" target="_blank" rel="noopener">www.a.com_2015-01-01.log、www.a.com_2015-01-02.log等等，使用log肯定不合适，如果文件名使用正则，那么新增的日志文件会立即加入监控。</a></em></p>
<blockquote>
<p>备注：不管新日志、老日志，只要他们有变更，zabbix都会监控。</p>
</blockquote>
<p>只要配置了<regexp>，Zabbix会根据<regexp>的正则表达式来匹配日志中的内容。注意，一定要保证Zabbix用户对日志文件有可读权限，否则这个Item的状态会变成“unsupported”。</regexp></regexp></p>
<h1 id="二、监控原理及注意事项"><a href="#二、监控原理及注意事项" class="headerlink" title="二、监控原理及注意事项"></a>二、监控原理及注意事项</h1><p>1、Zabbix Server和Zabbix Agent会追踪日志文件的大小和最后修改时间，并且分别记录在字节计数器和最新的时间计数器中。</p>
<p>2、Agent会从上次读取日志的地方开始读取日志。</p>
<p>3、字节计数器和最新时间计数器的数据会被记录在Zabbix数据库，并且发送给Agent，这样能够保证Agent从上次停止的地方开始读取日志。</p>
<p>4、当日志文件大小小于字节计数器中的数字时，字节计数器会变为0，从头开始读取文件。</p>
<p>5、所有符合配置的文件，都会被监控。</p>
<p>6、一个目录下的多个文件如果修改时间相同，会按照字母顺序来读取。</p>
<p>7、到每个Update interval的时间时，Agent会检查一次目录下的文件。</p>
<p>8、Zabbix Agent每秒发送日志量，有一个日志行数上限，防止网络和CPU负载过高，这个数字在zabbix_agentd.conf中的MaxLinePerSecond。</p>
<p>9、在logtr中，正则表达式只对文件名有效，对文件目录无效。</p>
<h1 id="三、日志监控配置"><a href="#三、日志监控配置" class="headerlink" title="三、日志监控配置"></a>三、日志监控配置</h1><p>请确保Agent有如下两项配置</p>
<p>1、Hostname设定为Server创建主机是填写的Host name，必须一致</p>
<p>2、ServerActive设定为Server的IP</p>
<p>Host&gt;&gt;目标主机&gt;&gt;监控项&gt;&gt;创建监控项，如下：</p>
<h2 id="1、log方式"><a href="#1、log方式" class="headerlink" title="1、log方式"></a>1、log方式</h2><p><img src="1.jpg" alt="1"></p>
<h2 id="2、logrt方式"><a href="#2、logrt方式" class="headerlink" title="2、logrt方式"></a>2、logrt方式</h2><p><img src="2.png" alt="enter description here"></p>
<p>说明：</p>
<ol>
<li><p>type必须选择zabbix agent（active），因为数据是zabbix被监控的主动提交给server</p>
</li>
<li><p>key：log[/var/log/message,error]，我们这里是监控的系统日志，打印出带有error的行，大家也可以去监控其他的日志，mysql、nginx等等都是可以的。</p>
</li>
<li><p>key: logrt[“/mnt/backup/log/[0-9]+_[0-9]+.log”,END],监控备份日志，例如20180305_113523.log,正则表达式[0-9]+_[0-9]+.log，具体可以百度学习正则表达式写法；“”双引号在使用表达式时     候最好用上，否则在保存时可能报语法错误；</p>
</li>
<li><p>log time format：MMpddphh:mm:ss，对应日志的行头Sep 14 07:32:38，y表示年、M表示月、d表示日、p和:一个占位符，h表示小时，m表示分钟，s表示秒。</p>
</li>
</ol>
<h1 id="四、结果查看"><a href="#四、结果查看" class="headerlink" title="四、结果查看"></a>四、结果查看</h1><p>切换到最新数据里面，找到相应数据，如下是我的监控截图<br><img src="3.png" alt="enter description here"></p>
<h1 id="五、触发器设置"><a href="#五、触发器设置" class="headerlink" title="五、触发器设置"></a>五、触发器设置</h1><p>创建触发器，在周期24h内，写入日志则备份正常，否则告警；这里如下简单设置<br><img src="4.png" alt="enter description here"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kxinter.github.io/kxinter.gitub.io/kxinter.gitub.io/2018/08/23/jenkins邮件通知/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/kxinter.gitub.io/images/touxiang.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OperationMAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/kxinter.gitub.io/2018/08/23/jenkins邮件通知/" itemprop="url">jenkins邮件通知</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-23T15:51:51+08:00">
                2018-08-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/kxinter.gitub.io/categories/自动化运维/" itemprop="url" rel="index">
                    <span itemprop="name">自动化运维</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>jenkins集成mail通知服务不再说明，功能简单，这里简单说下常用mail插件Email Extension Plugin</p>
<h1 id="安装Email-Extension-Plugin"><a href="#安装Email-Extension-Plugin" class="headerlink" title="安装Email Extension Plugin"></a>安装Email Extension Plugin</h1><p><img src="1.png" alt="enter description here"></p>
<h2 id="配置Email"><a href="#配置Email" class="headerlink" title="配置Email"></a>配置Email</h2><p>系统管理&gt;系统设置&gt;Extended E-mail Notification</p>
<p>下面是我的配置，改动不大，邮件通知帐号在系统集成email处配置，这里主要提下插件通知模版<br><img src="2.png" alt="enter description here"><br><img src="3.png" alt="enter description here"></p>
<h2 id="配置默认模版"><a href="#配置默认模版" class="headerlink" title="配置默认模版"></a>配置默认模版</h2><p>Default Content Type配置为html</p>
<h3 id="标题"><a href="#标题" class="headerlink" title="标题"></a>标题</h3><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">构建通知：<span class="symbol">$</span>PROJECT_NAME - Build # <span class="symbol">$</span>BUILD_NUMBER - <span class="symbol">$</span>BUILD_STATUS!</span><br></pre></td></tr></table></figure>
<p><img src="4.png" alt="enter description here"></p>
<h3 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>$&#123;ENV, var="JOB_NAME"&#125;-第$&#123;BUILD_NUMBER&#125;次构建日志<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">leftmargin</span>=<span class="string">"8"</span> <span class="attr">marginwidth</span>=<span class="string">"0"</span> <span class="attr">topmargin</span>=<span class="string">"8"</span> <span class="attr">marginheight</span>=<span class="string">"4"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">offset</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">width</span>=<span class="string">"95%"</span> <span class="attr">cellpadding</span>=<span class="string">"0"</span> <span class="attr">cellspacing</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">style</span>=<span class="string">"font-size: 11pt; font-family: Tahoma, Arial, Helvetica, sans-serif"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h2</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">font</span>&gt;</span>来自Mr.Jenkins的邮件通知<span class="tag">&lt;/<span class="name">font</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">font</span>&gt;</span>(本邮件是程序自动下发的，请勿回复！)<span class="tag">&lt;/<span class="name">font</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">"#0B610B"</span>&gt;</span>构建信息<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">hr</span> <span class="attr">size</span>=<span class="string">"2"</span> <span class="attr">width</span>=<span class="string">"100%"</span> <span class="attr">align</span>=<span class="string">"center"</span> /&gt;</span></span><br><span class="line">             <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>项目名称：$&#123;PROJECT_NAME&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>构建编号：$&#123;BUILD_NUMBER&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">li</span>&gt;</span>构建状态：$&#123;BUILD_STATUS&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>触发原因：$&#123;CAUSE&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">li</span>&gt;</span>构建地址：$&#123;BUILD_URL&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>构建日志：<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"$&#123;BUILD_URL&#125;console"</span>&gt;</span>$&#123;BUILD_URL&#125;console<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>单元测试报告：<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"$&#123;BUILD_URL&#125;testReport/"</span>&gt;</span>$&#123;BUILD_URL&#125;testReport/<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>工作目录：<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"$&#123;PROJECT_URL&#125;ws"</span>&gt;</span>$&#123;PROJECT_URL&#125;ws<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">"#0B610B"</span>&gt;</span>构建日志:<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">hr</span> <span class="attr">size</span>=<span class="string">"2"</span> <span class="attr">width</span>=<span class="string">"100%"</span> <span class="attr">align</span>=<span class="string">"center"</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">cols</span>=<span class="string">"80"</span> <span class="attr">rows</span>=<span class="string">"30"</span> <span class="attr">readonly</span>=<span class="string">"readonly"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">style</span>=<span class="string">"font-family: Courier New"</span>&gt;</span>$&#123;BUILD_LOG&#125;<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="添加项目构建"><a href="#添加项目构建" class="headerlink" title="添加项目构建"></a>添加项目构建</h1><p><img src="5.png" alt="enter description here"></p>
<h1 id="通知展示"><a href="#通知展示" class="headerlink" title="通知展示"></a>通知展示</h1><p><img src="6.png" alt="enter description here"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/kxinter.gitub.io/page/2/">2</a><a class="page-number" href="/kxinter.gitub.io/page/3/">3</a><a class="extend next" rel="next" href="/kxinter.gitub.io/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/kxinter.gitub.io/images/touxiang.jpeg"
                alt="Mr.Zhao" />
            
              <p class="site-author-name" itemprop="name">Mr.Zhao</p>
              <p class="site-description motion-element" itemprop="description">日常运维文档整理。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/kxinter.gitub.io/archives/">
              
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/kxinter.gitub.io/categories/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/kxinter.gitub.io/tags/index.html">
                  <span class="site-state-item-count">30</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mr.Zhao</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/kxinter.gitub.io/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/kxinter.gitub.io/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/kxinter.gitub.io/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/kxinter.gitub.io/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/kxinter.gitub.io/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/kxinter.gitub.io/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/kxinter.gitub.io/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/kxinter.gitub.io/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/kxinter.gitub.io/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

  
  
</body>
</html>
