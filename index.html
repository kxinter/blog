<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/kxinter.gitub.io/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/kxinter.gitub.io/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/kxinter.gitub.io/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/kxinter.gitub.io/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/kxinter.gitub.io/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/kxinter.gitub.io/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/kxinter.gitub.io/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="日常运维文档整理。">
<meta property="og:type" content="website">
<meta property="og:title" content="OperationMAN">
<meta property="og:url" content="https://kxinter.github.io/kxinter.gitub.io/index.html">
<meta property="og:site_name" content="OperationMAN">
<meta property="og:description" content="日常运维文档整理。">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="OperationMAN">
<meta name="twitter:description" content="日常运维文档整理。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/kxinter.gitub.io/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://kxinter.github.io/kxinter.gitub.io/"/>





  <title>OperationMAN</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/kxinter.gitub.io/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">OperationMAN</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">笔记</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/kxinter.gitub.io/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/kxinter.gitub.io/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/kxinter.gitub.io/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/kxinter.gitub.io/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kxinter.github.io/kxinter.gitub.io/kxinter.gitub.io/2018/08/23/zabbix3-4-7监控日志/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/kxinter.gitub.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OperationMAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/kxinter.gitub.io/2018/08/23/zabbix3-4-7监控日志/" itemprop="url">zabbix3.4.7监控日志</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-23T16:01:47+08:00">
                2018-08-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/kxinter.gitub.io/categories/自动化运维/" itemprop="url" rel="index">
                    <span itemprop="name">自动化运维</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/kxinter.gitub.io/categories/自动化运维/Zabbix/" itemprop="url" rel="index">
                    <span itemprop="name">Zabbix</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一、日志item介绍"><a href="#一、日志item介绍" class="headerlink" title="一、日志item介绍"></a>一、日志item介绍</h1><p>下面介绍zabbix另一个“重量级”的功能——日志文件监控，它最主要的是监控日志文件中有没有某个字符串的表达式，对应日志轮转与否，zabbix都支持。</p>
<p>在配置Item的时候，Type选择Zabbix agent (active)，这里主要需要配置的是Key。下面是监控日志的两种key——log和logtr。</p>
<p>log[/path/to/some/file,<regexp>,<encoding>,<maxlines>,<mode>,<output>]</output></mode></maxlines></encoding></regexp></p>
<p>logtr[/path/to/some/filename_format,<regexp>,<encoding>,<maxlines>,<mode>,<output>]</output></mode></maxlines></encoding></regexp></p>
<blockquote>
<p>◆ regexp：要匹配内容的正则表达式，或者直接写你要检索的内容也可以，例如我想检索带ERROR关键词的记录</p>
<p>◆ encoding：编码相关，留空即可</p>
<p>◆<br>maxlines：一次性最多提交多少行，这个参数覆盖配置文件zabbxi_agentd.conf中的’MaxLinesPerSecond’，我们也可以留空</p>
<p>◆ mode：默认是all，也可以是skip，skip会跳过老数据</p>
<p>◆ output：输出给zabbix<br>server的数据。可以是\1、\2一直\9，\1表示第一个正则表达式匹配出得内容，\2表示第二个正则表达式匹配错的内容。</p>
</blockquote>
<p><em>如果仔细看可以发现，第一个参数不一样，logrt的第一个参数可以使用正则表达式。针对日志回滚用得，例如我们每天都切割nginx日志，日志名位<a href="http://www.a.com_2015-01-01.log、www.a.com_2015-01-02.log等等，使用log肯定不合适，如果文件名使用正则，那么新增的日志文件会立即加入监控。" target="_blank" rel="noopener">www.a.com_2015-01-01.log、www.a.com_2015-01-02.log等等，使用log肯定不合适，如果文件名使用正则，那么新增的日志文件会立即加入监控。</a></em></p>
<blockquote>
<p>备注：不管新日志、老日志，只要他们有变更，zabbix都会监控。</p>
</blockquote>
<p>只要配置了<regexp>，Zabbix会根据<regexp>的正则表达式来匹配日志中的内容。注意，一定要保证Zabbix用户对日志文件有可读权限，否则这个Item的状态会变成“unsupported”。</regexp></regexp></p>
<h1 id="二、监控原理及注意事项"><a href="#二、监控原理及注意事项" class="headerlink" title="二、监控原理及注意事项"></a>二、监控原理及注意事项</h1><p>1、Zabbix Server和Zabbix Agent会追踪日志文件的大小和最后修改时间，并且分别记录在字节计数器和最新的时间计数器中。</p>
<p>2、Agent会从上次读取日志的地方开始读取日志。</p>
<p>3、字节计数器和最新时间计数器的数据会被记录在Zabbix数据库，并且发送给Agent，这样能够保证Agent从上次停止的地方开始读取日志。</p>
<p>4、当日志文件大小小于字节计数器中的数字时，字节计数器会变为0，从头开始读取文件。</p>
<p>5、所有符合配置的文件，都会被监控。</p>
<p>6、一个目录下的多个文件如果修改时间相同，会按照字母顺序来读取。</p>
<p>7、到每个Update interval的时间时，Agent会检查一次目录下的文件。</p>
<p>8、Zabbix Agent每秒发送日志量，有一个日志行数上限，防止网络和CPU负载过高，这个数字在zabbix_agentd.conf中的MaxLinePerSecond。</p>
<p>9、在logtr中，正则表达式只对文件名有效，对文件目录无效。</p>
<h1 id="三、日志监控配置"><a href="#三、日志监控配置" class="headerlink" title="三、日志监控配置"></a>三、日志监控配置</h1><p>请确保Agent有如下两项配置</p>
<p>1、Hostname设定为Server创建主机是填写的Host name，必须一致</p>
<p>2、ServerActive设定为Server的IP</p>
<p>Host&gt;&gt;目标主机&gt;&gt;监控项&gt;&gt;创建监控项，如下：</p>
<h2 id="1、log方式"><a href="#1、log方式" class="headerlink" title="1、log方式"></a>1、log方式</h2><p><img src="1.jpg" alt="1"></p>
<h2 id="2、logrt方式"><a href="#2、logrt方式" class="headerlink" title="2、logrt方式"></a>2、logrt方式</h2><p><img src="2.png" alt="enter description here"></p>
<p>说明：</p>
<ol>
<li><p>type必须选择zabbix agent（active），因为数据是zabbix被监控的主动提交给server</p>
</li>
<li><p>key：log[/var/log/message,error]，我们这里是监控的系统日志，打印出带有error的行，大家也可以去监控其他的日志，mysql、nginx等等都是可以的。</p>
</li>
<li><p>key: logrt[“/mnt/backup/log/[0-9]+_[0-9]+.log”,END],监控备份日志，例如20180305_113523.log,正则表达式[0-9]+_[0-9]+.log，具体可以百度学习正则表达式写法；“”双引号在使用表达式时     候最好用上，否则在保存时可能报语法错误；</p>
</li>
<li><p>log time format：MMpddphh:mm:ss，对应日志的行头Sep 14 07:32:38，y表示年、M表示月、d表示日、p和:一个占位符，h表示小时，m表示分钟，s表示秒。</p>
</li>
</ol>
<h1 id="四、结果查看"><a href="#四、结果查看" class="headerlink" title="四、结果查看"></a>四、结果查看</h1><p>切换到最新数据里面，找到相应数据，如下是我的监控截图<br><img src="3.png" alt="enter description here"></p>
<h1 id="五、触发器设置"><a href="#五、触发器设置" class="headerlink" title="五、触发器设置"></a>五、触发器设置</h1><p>创建触发器，在周期24h内，写入日志则备份正常，否则告警；这里如下简单设置<br><img src="4.png" alt="enter description here"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kxinter.github.io/kxinter.gitub.io/kxinter.gitub.io/2018/08/23/jenkins邮件通知/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/kxinter.gitub.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OperationMAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/kxinter.gitub.io/2018/08/23/jenkins邮件通知/" itemprop="url">jenkins邮件通知</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-23T15:51:51+08:00">
                2018-08-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/kxinter.gitub.io/categories/自动化运维/" itemprop="url" rel="index">
                    <span itemprop="name">自动化运维</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/kxinter.gitub.io/categories/自动化运维/Jenkins/" itemprop="url" rel="index">
                    <span itemprop="name">Jenkins</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>jenkins集成mail通知服务不再说明，功能简单，这里简单说下常用mail插件Email Extension Plugin</p>
<h1 id="安装Email-Extension-Plugin"><a href="#安装Email-Extension-Plugin" class="headerlink" title="安装Email Extension Plugin"></a>安装Email Extension Plugin</h1><p><img src="1.png" alt="enter description here"></p>
<h2 id="配置Email"><a href="#配置Email" class="headerlink" title="配置Email"></a>配置Email</h2><p>系统管理&gt;系统设置&gt;Extended E-mail Notification</p>
<p>下面是我的配置，改动不大，邮件通知帐号在系统集成email处配置，这里主要提下插件通知模版<br><img src="2.png" alt="enter description here"><br><img src="3.png" alt="enter description here"></p>
<h2 id="配置默认模版"><a href="#配置默认模版" class="headerlink" title="配置默认模版"></a>配置默认模版</h2><p>Default Content Type配置为html</p>
<h3 id="标题"><a href="#标题" class="headerlink" title="标题"></a>标题</h3><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">构建通知：<span class="symbol">$</span>PROJECT_NAME - Build # <span class="symbol">$</span>BUILD_NUMBER - <span class="symbol">$</span>BUILD_STATUS!</span><br></pre></td></tr></table></figure>
<p><img src="4.png" alt="enter description here"></p>
<h3 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>$&#123;ENV, var="JOB_NAME"&#125;-第$&#123;BUILD_NUMBER&#125;次构建日志<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">leftmargin</span>=<span class="string">"8"</span> <span class="attr">marginwidth</span>=<span class="string">"0"</span> <span class="attr">topmargin</span>=<span class="string">"8"</span> <span class="attr">marginheight</span>=<span class="string">"4"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">offset</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">width</span>=<span class="string">"95%"</span> <span class="attr">cellpadding</span>=<span class="string">"0"</span> <span class="attr">cellspacing</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">style</span>=<span class="string">"font-size: 11pt; font-family: Tahoma, Arial, Helvetica, sans-serif"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h2</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">font</span>&gt;</span>来自Mr.Jenkins的邮件通知<span class="tag">&lt;/<span class="name">font</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">font</span>&gt;</span>(本邮件是程序自动下发的，请勿回复！)<span class="tag">&lt;/<span class="name">font</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">"#0B610B"</span>&gt;</span>构建信息<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">hr</span> <span class="attr">size</span>=<span class="string">"2"</span> <span class="attr">width</span>=<span class="string">"100%"</span> <span class="attr">align</span>=<span class="string">"center"</span> /&gt;</span></span><br><span class="line">             <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>项目名称：$&#123;PROJECT_NAME&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>构建编号：$&#123;BUILD_NUMBER&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">li</span>&gt;</span>构建状态：$&#123;BUILD_STATUS&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>触发原因：$&#123;CAUSE&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">li</span>&gt;</span>构建地址：$&#123;BUILD_URL&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>构建日志：<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"$&#123;BUILD_URL&#125;console"</span>&gt;</span>$&#123;BUILD_URL&#125;console<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>单元测试报告：<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"$&#123;BUILD_URL&#125;testReport/"</span>&gt;</span>$&#123;BUILD_URL&#125;testReport/<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>工作目录：<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"$&#123;PROJECT_URL&#125;ws"</span>&gt;</span>$&#123;PROJECT_URL&#125;ws<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">"#0B610B"</span>&gt;</span>构建日志:<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">hr</span> <span class="attr">size</span>=<span class="string">"2"</span> <span class="attr">width</span>=<span class="string">"100%"</span> <span class="attr">align</span>=<span class="string">"center"</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">cols</span>=<span class="string">"80"</span> <span class="attr">rows</span>=<span class="string">"30"</span> <span class="attr">readonly</span>=<span class="string">"readonly"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">style</span>=<span class="string">"font-family: Courier New"</span>&gt;</span>$&#123;BUILD_LOG&#125;<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="添加项目构建"><a href="#添加项目构建" class="headerlink" title="添加项目构建"></a>添加项目构建</h1><p><img src="5.png" alt="enter description here"></p>
<h1 id="通知展示"><a href="#通知展示" class="headerlink" title="通知展示"></a>通知展示</h1><p><img src="6.png" alt="enter description here"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kxinter.github.io/kxinter.gitub.io/kxinter.gitub.io/2018/08/22/Docker集群WEB管理工具Shipyard/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/kxinter.gitub.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OperationMAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/kxinter.gitub.io/2018/08/22/Docker集群WEB管理工具Shipyard/" itemprop="url">Docker集群WEB管理工具Shipyard</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-22T17:00:58+08:00">
                2018-08-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/kxinter.gitub.io/categories/Docker/" itemprop="url" rel="index">
                    <span itemprop="name">Docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><p>Shipyard部署总体较为简单，有一键部署脚本，只需执行相应命令就可以实现部署，但在部署中还是出现很多问题，主要是shipyard官方网站无法访问，无法使用官方一键脚本部署，使用网上找到的修改版，里面有部分内容有所缺失，现已修改。</p>
<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>centos:7.4</p>
<p>master: 192.168.1.44</p>
<p>node1: 192.168.1.12</p>
<p>node2: 192.168.1.18</p>
<p>docker version: docker-ce-18.03.0-ce</p>
<h1 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h1><p>安装之前需要部署好docker环境</p>
<h2 id="1、master节点执行一件部署命令"><a href="#1、master节点执行一件部署命令" class="headerlink" title="1、master节点执行一件部署命令"></a>1、master节点执行一件部署命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 正常直接从官方拉取脚本执行就行了，命令如下</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> curl -s https://shipyard-project.com/deploy | bash -s</span></span><br><span class="line"></span><br><span class="line">[root@master ~]# curl -s https://shipyard-project.com/deploy | bash -s</span><br><span class="line">Deploying Shipyard</span><br><span class="line"><span class="meta"> -&gt;</span><span class="bash"> Starting Database</span></span><br><span class="line">Unable to find image 'rethinkdb:latest' locally</span><br><span class="line">Trying to pull repository xxx.mirror.aliyuncs.com/rethinkdb ...</span><br><span class="line">Pulling repository xxx.mirror.aliyuncs.com/rethinkdb</span><br><span class="line">Trying to pull repository docker.io/library/rethinkdb ...</span><br><span class="line">latest: Pulling from docker.io/library/rethinkdb</span><br><span class="line">Digest: sha256:29640c7d5015832c40305ad5dcc5d0996ce79b87f7e32d2fd99c9d65ad9414d4</span><br><span class="line"><span class="meta"> -&gt;</span><span class="bash"> Starting Discovery</span></span><br><span class="line"><span class="meta"> -&gt;</span><span class="bash"> Starting Cert Volume</span></span><br><span class="line"><span class="meta"> -&gt;</span><span class="bash"> Starting Proxy</span></span><br><span class="line"><span class="meta"> -&gt;</span><span class="bash"> Starting Swarm Manager</span></span><br><span class="line"><span class="meta"> -&gt;</span><span class="bash"> Starting Swarm Agent</span></span><br><span class="line"><span class="meta"> -&gt;</span><span class="bash"> Starting Controller</span></span><br><span class="line">Waiting for Shipyard on 192.168.1.44:8080</span><br><span class="line"> </span><br><span class="line">Shipyard available at http://192.168.1.44:8080</span><br><span class="line">Username: admin Password: shipyard</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 或者下载脚本后本地执行，命令如下</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sh deploy</span></span><br></pre></td></tr></table></figure>
<p>执行脚本的时候会自动下载相关镜像，也可以事先下载镜像文件</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# docker</span> pull alpine</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# docker</span> pull library/rethinkdb</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# docker</span> pull microbox/etcd</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# docker</span> pull shipyard/docker-proxy</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# docker</span> pull swarm</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# docker</span> pull shipyard/shipyard</span><br></pre></td></tr></table></figure>
<p>通过访问<a href="http://IP：8080登录shipyard,默认帐号密码：admin" target="_blank" rel="noopener">http://IP：8080登录shipyard,默认帐号密码：admin</a>   shipyard<br><img src="1.png" alt="enter description here"></p>
<h2 id="2、分别在node节点执行如下命令，添加节点到shipyard"><a href="#2、分别在node节点执行如下命令，添加节点到shipyard" class="headerlink" title="2、分别在node节点执行如下命令，添加节点到shipyard"></a>2、分别在node节点执行如下命令，添加节点到shipyard</h2><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署机就是master节点</span></span><br><span class="line">$ curl -sSL https://shipyard-project.com/deploy | <span class="attr">ACTION=</span><span class="keyword">node</span> <span class="title">DISCOVERY</span>=etcd://<span class="tag">&lt;shipyard部署机ip&gt;</span> bash -s</span><br><span class="line"><span class="comment"># 或者通过本地脚本执行命令</span></span><br><span class="line">$ cat deploy | <span class="attr">ACTION=</span><span class="keyword">node</span> <span class="title">DISCOVERY</span>=etcd://<span class="tag">&lt;shipyard部署机ip&gt;</span> bash -s</span><br></pre></td></tr></table></figure>
<p><img src="2.png" alt="enter description here"><br><img src="3.png" alt="enter description here"><br><img src="4.png" alt="enter description here"></p>
<h1 id="问题总结"><a href="#问题总结" class="headerlink" title="问题总结"></a>问题总结</h1><h2 id="注意项目1："><a href="#注意项目1：" class="headerlink" title="注意项目1："></a>注意项目1：</h2><p>—————————————————————————————————————<br>上面安装shipyard的脚本是英文版的，其实还有中文版的脚本，下面两种都可以使用：（两个地址都失效）</p>
<p>1）安装shipyard</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl -sSL http://dockerclub.net/public/script/deploy | bash -s ==&gt; 中文版</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> curl -sSL https://shipyard-project.com/deploy | bash -s ==&gt; 英文版</span></span><br></pre></td></tr></table></figure>
<p>2）添加node节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl -sSL http://dockerclub.net/public/script/deploy | ACTION=node DISCOVERY=etcd://&lt;shipyard部署机ip&gt; bash -s ==&gt; 中文版</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> curl -sSL https://shipyard-project.com/deploy | ACTION=node DISCOVERY=etcd://&lt;shipyard部署机ip&gt; bash -s ==&gt; 英文版</span></span><br></pre></td></tr></table></figure>
<p>3）删除shipyard（在节点机上执行，就会将节点从shipyard管理里踢出）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl http://dockerclub.net/public/script/deploy | ACTION=remove bash -s ==&gt; 中文版</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> curl -sSL https://shipyard-project.com/deploy | ACTION=remove bash -s ==&gt; 英文版</span></span><br></pre></td></tr></table></figure>
<p>—————————————————————————————————————</p>
<p>问题项目2：<br>—————————————————————————————————————</p>
<p>1）安装shipyard前不需要部署swarm集群，一键包已包含集群建设</p>
<p>2）部署后无法发现节点，容器页面报错，意思是到节点IP:3375端口无法建立连接，500错误；根据排查，发现所有节点swarm_manager容器都没有开启3375端口，于是在脚本里面修改</p>
<p>容器启动命令，添加开启3375端口，具体看下方脚本；</p>
<p>3）在shipyard web页面，master自身发现较慢，不知道什么原因</p>
<p>4）中文版shipard创建容器的时候，设置端口映射但不生效，使用英文版没有问题，未发现问题原因</p>
<p>5）shipyard只适合较小规模docker集群，功能上已跟不上现阶段的docker集群需求。</p>
<p>—————————————————————————————————————</p>
<h1 id="deploy脚本"><a href="#deploy脚本" class="headerlink" title="deploy脚本"></a>deploy脚本</h1><p>这个是中文版的脚本，和官方的区别就是修改了shipyard镜像文件，下方标注部分说明</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> != <span class="string">""</span> ] &amp;&amp; [ <span class="string">"<span class="variable">$1</span>"</span> = <span class="string">"-h"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Shipyard Deploy uses the following environment variables:"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"  ACTION: this is the action to use (deploy, upgrade, node, remove)"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"  DISCOVERY: discovery system used by Swarm (only if using 'node' action)"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"  IMAGE: this overrides the default Shipyard image"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"  PREFIX: prefix for container names"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"  SHIPYARD_ARGS: these are passed to the Shipyard controller container as controller args"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"  TLS_CERT_PATH: path to certs to enable TLS for Shipyard"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"  PORT: specify the listen port for the controller (default: 8080)"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"  IP: specify the address at which the controller or node will be available (default: eth0 ip)"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"  PROXY_PORT: port to run docker proxy (default: 2375)"</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">"`which docker`"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"You must have the Docker CLI installed on your \$PATH"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"  See http://docs.docker.com for details"</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">ACTION=<span class="variable">$&#123;ACTION:-deploy&#125;</span></span><br><span class="line"><span class="comment">#官方IMAGE=$&#123;IMAGE:-shipyard/shipyard:latest&#125;</span></span><br><span class="line"><span class="comment">#备注官方shipyard:latest标签镜像似乎有问题，实际使用shipyard:master标签镜像</span></span><br><span class="line">IMAGE=<span class="variable">$&#123;IMAGE:-dockerclub/shipyard:latest&#125;</span></span><br><span class="line">PREFIX=<span class="variable">$&#123;PREFIX:-shipyard&#125;</span></span><br><span class="line">SHIPYARD_ARGS=<span class="variable">$&#123;SHIPYARD_ARGS:-""&#125;</span></span><br><span class="line">TLS_CERT_PATH=<span class="variable">$&#123;TLS_CERT_PATH:-&#125;</span></span><br><span class="line">CERT_PATH=<span class="string">"/etc/shipyard"</span></span><br><span class="line">PROXY_PORT=<span class="variable">$&#123;PROXY_PORT:-2375&#125;</span></span><br><span class="line">SWARM_PORT=3375</span><br><span class="line">SHIPYARD_PROTOCOL=http</span><br><span class="line">SHIPYARD_PORT=<span class="variable">$&#123;PORT:-8080&#125;</span></span><br><span class="line">SHIPYARD_IP=<span class="variable">$&#123;IP&#125;</span></span><br><span class="line">DISCOVERY_BACKEND=etcd</span><br><span class="line">DISCOVERY_PORT=4001</span><br><span class="line">DISCOVERY_PEER_PORT=7001</span><br><span class="line">ENABLE_TLS=0</span><br><span class="line">CERT_FINGERPRINT=<span class="string">""</span></span><br><span class="line">LOCAL_CA_CERT=<span class="string">""</span></span><br><span class="line">LOCAL_SSL_CERT=<span class="string">""</span></span><br><span class="line">LOCAL_SSL_KEY=<span class="string">""</span></span><br><span class="line">LOCAL_SSL_CLIENT_CERT=<span class="string">""</span></span><br><span class="line">LOCAL_SSL_CLIENT_KEY=<span class="string">""</span></span><br><span class="line">SSL_CA_CERT=<span class="string">""</span></span><br><span class="line">SSL_CERT=<span class="string">""</span></span><br><span class="line">SSL_KEY=<span class="string">""</span></span><br><span class="line">SSL_CLIENT_CERT=<span class="string">""</span></span><br><span class="line">SSL_CLIENT_KEY=<span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">show_cert_help</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"To use TLS in Shipyard, you must have existing certificates."</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"The certs must be named ca.pem, server.pem, server-key.pem, cert.pem and key.pem"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"If you need to generate certificates, see https://github.com/ehazlett/certm for examples."</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_certs</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$TLS_CERT_PATH</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">return</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ ! -e <span class="variable">$TLS_CERT_PATH</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Error: unable to find certificates in <span class="variable">$TLS_CERT_PATH</span>"</span></span><br><span class="line">        show_cert_help</span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$PROXY_PORT</span>"</span> = <span class="string">"2375"</span> ]; <span class="keyword">then</span></span><br><span class="line">        PROXY_PORT=2376</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    SWARM_PORT=3376</span><br><span class="line">    SHIPYARD_PROTOCOL=https</span><br><span class="line">    LOCAL_SSL_CA_CERT=<span class="string">"<span class="variable">$TLS_CERT_PATH</span>/ca.pem"</span></span><br><span class="line">    LOCAL_SSL_CERT=<span class="string">"<span class="variable">$TLS_CERT_PATH</span>/server.pem"</span></span><br><span class="line">    LOCAL_SSL_KEY=<span class="string">"<span class="variable">$TLS_CERT_PATH</span>/server-key.pem"</span></span><br><span class="line">    LOCAL_SSL_CLIENT_CERT=<span class="string">"<span class="variable">$TLS_CERT_PATH</span>/cert.pem"</span></span><br><span class="line">    LOCAL_SSL_CLIENT_KEY=<span class="string">"<span class="variable">$TLS_CERT_PATH</span>/key.pem"</span></span><br><span class="line">    SSL_CA_CERT=<span class="string">"<span class="variable">$CERT_PATH</span>/ca.pem"</span></span><br><span class="line">    SSL_CERT=<span class="string">"<span class="variable">$CERT_PATH</span>/server.pem"</span></span><br><span class="line">    SSL_KEY=<span class="string">"<span class="variable">$CERT_PATH</span>/server-key.pem"</span></span><br><span class="line">    SSL_CLIENT_CERT=<span class="string">"<span class="variable">$CERT_PATH</span>/cert.pem"</span></span><br><span class="line">    SSL_CLIENT_KEY=<span class="string">"<span class="variable">$CERT_PATH</span>/key.pem"</span></span><br><span class="line">    CERT_FINGERPRINT=$(openssl x509 -noout -<span class="keyword">in</span> <span class="variable">$LOCAL_SSL_CERT</span> -fingerprint -sha256 | awk -F= <span class="string">'&#123;print $2;&#125;'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ ! -e <span class="variable">$LOCAL_SSL_CA_CERT</span> ] || [ ! -e <span class="variable">$LOCAL_SSL_CERT</span> ] || [ ! -e <span class="variable">$LOCAL_SSL_KEY</span> ] || [ ! -e <span class="variable">$LOCAL_SSL_CLIENT_CERT</span> ] || [ ! -e <span class="variable">$LOCAL_SSL_CLIENT_KEY</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Error: unable to find certificates"</span></span><br><span class="line">        show_cert_help</span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    ENABLE_TLS=1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># container functions</span></span><br><span class="line"><span class="function"><span class="title">start_certs</span></span>() &#123;</span><br><span class="line">    ID=$(docker run \</span><br><span class="line">        -ti \</span><br><span class="line">        -d \</span><br><span class="line">        --restart=always \</span><br><span class="line">        --name <span class="variable">$PREFIX</span>-certs \</span><br><span class="line">        -v <span class="variable">$CERT_PATH</span> \</span><br><span class="line">        alpine \</span><br><span class="line">        sh)</span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$ENABLE_TLS</span> = 1 ]; <span class="keyword">then</span></span><br><span class="line">        docker cp <span class="variable">$LOCAL_SSL_CA_CERT</span> <span class="variable">$PREFIX</span>-certs:<span class="variable">$SSL_CA_CERT</span></span><br><span class="line">        docker cp <span class="variable">$LOCAL_SSL_CERT</span> <span class="variable">$PREFIX</span>-certs:<span class="variable">$SSL_CERT</span></span><br><span class="line">        docker cp <span class="variable">$LOCAL_SSL_KEY</span> <span class="variable">$PREFIX</span>-certs:<span class="variable">$SSL_KEY</span></span><br><span class="line">        docker cp <span class="variable">$LOCAL_SSL_CLIENT_CERT</span> <span class="variable">$PREFIX</span>-certs:<span class="variable">$SSL_CLIENT_CERT</span></span><br><span class="line">        docker cp <span class="variable">$LOCAL_SSL_CLIENT_KEY</span> <span class="variable">$PREFIX</span>-certs:<span class="variable">$SSL_CLIENT_KEY</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">remove_certs</span></span>() &#123;</span><br><span class="line">    docker rm -fv <span class="variable">$PREFIX</span>-certs &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">get_ip</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$SHIPYARD_IP</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        SHIPYARD_IP=`docker run --rm --net=host alpine ip route get 8.8.8.8 | awk <span class="string">'&#123; print $7;  &#125;'</span>`</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start_discovery</span></span>() &#123;</span><br><span class="line">    get_ip</span><br><span class="line"></span><br><span class="line">    ID=$(docker run \</span><br><span class="line">        -ti \</span><br><span class="line">        -d \</span><br><span class="line">        -p 4001:4001 \</span><br><span class="line">        -p 7001:7001 \</span><br><span class="line">        --restart=always \</span><br><span class="line">        --name <span class="variable">$PREFIX</span>-discovery \</span><br><span class="line">        microbox/etcd:latest -addr <span class="variable">$SHIPYARD_IP</span>:<span class="variable">$DISCOVERY_PORT</span> -peer-addr <span class="variable">$SHIPYARD_IP</span>:<span class="variable">$DISCOVERY_PEER_PORT</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">remove_discovery</span></span>() &#123;</span><br><span class="line">    docker rm -fv <span class="variable">$PREFIX</span>-discovery &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start_rethinkdb</span></span>() &#123;</span><br><span class="line">    ID=$(docker run \</span><br><span class="line">        -ti \</span><br><span class="line">        -d \</span><br><span class="line">        --restart=always \</span><br><span class="line">        --name <span class="variable">$PREFIX</span>-rethinkdb \</span><br><span class="line">        rethinkdb)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">remove_rethinkdb</span></span>() &#123;</span><br><span class="line">    docker rm -fv <span class="variable">$PREFIX</span>-rethinkdb &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start_proxy</span></span>() &#123;</span><br><span class="line">    TLS_OPTS=<span class="string">""</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$ENABLE_TLS</span> = 1 ]; <span class="keyword">then</span></span><br><span class="line">        TLS_OPTS=<span class="string">"-e SSL_CA=<span class="variable">$SSL_CA_CERT</span> -e SSL_CERT=<span class="variable">$SSL_CERT</span> -e SSL_KEY=<span class="variable">$SSL_KEY</span> -e SSL_SKIP_VERIFY=1"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="comment"># Note: we add SSL_SKIP_VERIFY=1 to skip verification of the client</span></span><br><span class="line">    <span class="comment"># certificate in the proxy image.  this will pass it to swarm that</span></span><br><span class="line">    <span class="comment"># does verify.  this helps with performance and avoids certificate issues</span></span><br><span class="line">    <span class="comment"># when running through the proxy.  ultimately if the cert is invalid</span></span><br><span class="line">    <span class="comment"># swarm will fail to return.</span></span><br><span class="line">    ID=$(docker run \</span><br><span class="line">        -ti \</span><br><span class="line">        -d \</span><br><span class="line">        -p <span class="variable">$PROXY_PORT</span>:<span class="variable">$PROXY_PORT</span> \</span><br><span class="line">        --hostname=<span class="variable">$HOSTNAME</span> \</span><br><span class="line">        --restart=always \</span><br><span class="line">        --name <span class="variable">$PREFIX</span>-proxy \</span><br><span class="line">        -v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">        -e PORT=<span class="variable">$PROXY_PORT</span> \</span><br><span class="line">        --volumes-from=<span class="variable">$PREFIX</span>-certs <span class="variable">$TLS_OPTS</span>\</span><br><span class="line">        shipyard/docker-proxy:latest)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">remove_proxy</span></span>() &#123;</span><br><span class="line">    docker rm -fv <span class="variable">$PREFIX</span>-proxy &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start_swarm_manager</span></span>() &#123;</span><br><span class="line">    get_ip</span><br><span class="line"></span><br><span class="line">    TLS_OPTS=<span class="string">""</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$ENABLE_TLS</span> = 1 ]; <span class="keyword">then</span></span><br><span class="line">        TLS_OPTS=<span class="string">"--tlsverify --tlscacert=<span class="variable">$SSL_CA_CERT</span> --tlscert=<span class="variable">$SSL_CERT</span> --tlskey=<span class="variable">$SSL_KEY</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    EXTRA_RUN_OPTS=<span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$DISCOVERY</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        DISCOVERY=<span class="string">"<span class="variable">$DISCOVERY_BACKEND</span>://discovery:<span class="variable">$DISCOVERY_PORT</span>"</span></span><br><span class="line">        EXTRA_RUN_OPTS=<span class="string">"--link <span class="variable">$PREFIX</span>-discovery:discovery"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    ID=$(docker run \</span><br><span class="line">        -ti \</span><br><span class="line">        -d \</span><br><span class="line"><span class="comment">#下面3375端口是我出现无法连接节点后自己添加的，问题是启动容器没有开放3375端口</span></span><br><span class="line">        -p 3375:3375 \</span><br><span class="line">        --restart=always \</span><br><span class="line">        --name <span class="variable">$PREFIX</span>-swarm-manager \</span><br><span class="line">        --volumes-from=<span class="variable">$PREFIX</span>-certs <span class="variable">$EXTRA_RUN_OPTS</span> \</span><br><span class="line">        swarm:latest \</span><br><span class="line">        m --replication --addr <span class="variable">$SHIPYARD_IP</span>:<span class="variable">$SWARM_PORT</span> --host tcp://0.0.0.0:<span class="variable">$SWARM_PORT</span> <span class="variable">$TLS_OPTS</span> <span class="variable">$DISCOVERY</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">remove_swarm_manager</span></span>() &#123;</span><br><span class="line">    docker rm -fv <span class="variable">$PREFIX</span>-swarm-manager &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start_swarm_agent</span></span>() &#123;</span><br><span class="line">    get_ip</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$DISCOVERY</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        DISCOVERY=<span class="string">"<span class="variable">$DISCOVERY_BACKEND</span>://discovery:<span class="variable">$DISCOVERY_PORT</span>"</span></span><br><span class="line">        EXTRA_RUN_OPTS=<span class="string">"--link <span class="variable">$PREFIX</span>-discovery:discovery"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    ID=$(docker run \</span><br><span class="line">        -ti \</span><br><span class="line">        -d \</span><br><span class="line">        --restart=always \</span><br><span class="line">        --name <span class="variable">$PREFIX</span>-swarm-agent <span class="variable">$EXTRA_RUN_OPTS</span> \</span><br><span class="line">        swarm:latest \</span><br><span class="line">        j --addr <span class="variable">$SHIPYARD_IP</span>:<span class="variable">$PROXY_PORT</span> <span class="variable">$DISCOVERY</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">remove_swarm_agent</span></span>() &#123;</span><br><span class="line">    docker rm -fv <span class="variable">$PREFIX</span>-swarm-agent &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start_controller</span></span>() &#123;</span><br><span class="line">    <span class="comment">#-v $CERT_PATH:/etc/docker:ro \</span></span><br><span class="line">    TLS_OPTS=<span class="string">""</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$ENABLE_TLS</span> = 1 ]; <span class="keyword">then</span></span><br><span class="line">        TLS_OPTS=<span class="string">"--tls-ca-cert <span class="variable">$SSL_CA_CERT</span> --tls-cert=<span class="variable">$SSL_CERT</span> --tls-key=<span class="variable">$SSL_KEY</span> --shipyard-tls-ca-cert=<span class="variable">$SSL_CA_CERT</span> --shipyard-tls-cert=<span class="variable">$SSL_CERT</span> --shipyard-tls-key=<span class="variable">$SSL_KEY</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    ID=$(docker run \</span><br><span class="line">        -ti \</span><br><span class="line">        -d \</span><br><span class="line">        --restart=always \</span><br><span class="line">        --name <span class="variable">$PREFIX</span>-controller \</span><br><span class="line">        --link <span class="variable">$PREFIX</span>-rethinkdb:rethinkdb \</span><br><span class="line">        --link <span class="variable">$PREFIX</span>-swarm-manager:swarm \</span><br><span class="line">        -p <span class="variable">$SHIPYARD_PORT</span>:<span class="variable">$SHIPYARD_PORT</span> \</span><br><span class="line">        --volumes-from=<span class="variable">$PREFIX</span>-certs \</span><br><span class="line">        <span class="variable">$IMAGE</span> \</span><br><span class="line">        --debug \</span><br><span class="line">        server \</span><br><span class="line">        --listen :<span class="variable">$SHIPYARD_PORT</span> \</span><br><span class="line">        -d tcp://swarm:<span class="variable">$SWARM_PORT</span> <span class="variable">$TLS_OPTS</span> <span class="variable">$SHIPYARD_ARGS</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">wait_for_available</span></span>() &#123;</span><br><span class="line">    <span class="built_in">set</span> +e </span><br><span class="line">    IP=<span class="variable">$1</span></span><br><span class="line">    PORT=<span class="variable">$2</span></span><br><span class="line">    <span class="built_in">echo</span> Waiting <span class="keyword">for</span> Shipyard on <span class="variable">$IP</span>:<span class="variable">$PORT</span></span><br><span class="line"></span><br><span class="line">    docker pull ehazlett/curl &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line">    TLS_OPTS=<span class="string">""</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$ENABLE_TLS</span> = 1 ]; <span class="keyword">then</span></span><br><span class="line">        TLS_OPTS=<span class="string">"-k"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    until $(docker run --rm ehazlett/curl --output /dev/null --connect-timeout 1 --silent --head --fail <span class="variable">$TLS_OPTS</span> <span class="variable">$SHIPYARD_PROTOCOL</span>://<span class="variable">$IP</span>:<span class="variable">$PORT</span>/ &gt; /dev/null 2&gt;&amp;1); <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">'.'</span></span><br><span class="line">        sleep 1 </span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">'\n'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">remove_controller</span></span>() &#123;</span><br><span class="line">    docker rm -fv <span class="variable">$PREFIX</span>-controller &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$ACTION</span>"</span> = <span class="string">"deploy"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line">    check_certs</span><br><span class="line"></span><br><span class="line">    get_ip </span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Deploying Shipyard"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">" -&gt; Starting Database"</span></span><br><span class="line">    start_rethinkdb</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">" -&gt; Starting Discovery"</span></span><br><span class="line">    start_discovery</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">" -&gt; Starting Cert Volume"</span></span><br><span class="line">    start_certs</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">" -&gt; Starting Proxy"</span></span><br><span class="line">    start_proxy</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">" -&gt; Starting Swarm Manager"</span></span><br><span class="line">    start_swarm_manager</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">" -&gt; Starting Swarm Agent"</span></span><br><span class="line">    start_swarm_agent</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">" -&gt; Starting Controller"</span></span><br><span class="line">    start_controller</span><br><span class="line"></span><br><span class="line">    wait_for_available <span class="variable">$SHIPYARD_IP</span> <span class="variable">$SHIPYARD_PORT</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Shipyard available at <span class="variable">$SHIPYARD_PROTOCOL</span>://<span class="variable">$SHIPYARD_IP</span>:<span class="variable">$SHIPYARD_PORT</span>"</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$ENABLE_TLS</span> = 1 ] &amp;&amp; [ ! -z <span class="string">"<span class="variable">$CERT_FINGERPRINT</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"SSL SHA-256 Fingerprint: <span class="variable">$CERT_FINGERPRINT</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Username: admin Password: shipyard"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">"<span class="variable">$ACTION</span>"</span> = <span class="string">"node"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$DISCOVERY</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"You must set the DISCOVERY environment variable"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"with the discovery system used with Swarm"</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    check_certs</span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Adding Node"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">" -&gt; Starting Cert Volume"</span></span><br><span class="line">    start_certs</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">" -&gt; Starting Proxy"</span></span><br><span class="line">    start_proxy</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">" -&gt; Starting Swarm Manager"</span></span><br><span class="line">    start_swarm_manager <span class="variable">$DISCOVERY</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">" -&gt; Starting Swarm Agent"</span></span><br><span class="line">    start_swarm_agent</span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Node added to Swarm: <span class="variable">$SHIPYARD_IP</span>"</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">"<span class="variable">$ACTION</span>"</span> = <span class="string">"upgrade"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line">    check_certs</span><br><span class="line"></span><br><span class="line">    get_ip</span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Upgrading Shipyard"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">" -&gt; Pulling <span class="variable">$IMAGE</span>"</span></span><br><span class="line">    docker pull <span class="variable">$IMAGE</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">" -&gt; Upgrading Controller"</span></span><br><span class="line">    remove_controller</span><br><span class="line">    start_controller</span><br><span class="line"></span><br><span class="line">    wait_for_available <span class="variable">$SHIPYARD_IP</span> <span class="variable">$SHIPYARD_PORT</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Shipyard controller updated"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">"<span class="variable">$ACTION</span>"</span> = <span class="string">"remove"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># ignore errors</span></span><br><span class="line">    <span class="built_in">set</span> +e</span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Removing Shipyard"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">" -&gt; Removing Database"</span></span><br><span class="line">    remove_rethinkdb</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">" -&gt; Removing Discovery"</span></span><br><span class="line">    remove_discovery</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">" -&gt; Removing Cert Volume"</span></span><br><span class="line">    remove_certs</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">" -&gt; Removing Proxy"</span></span><br><span class="line">    remove_proxy</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">" -&gt; Removing Swarm Agent"</span></span><br><span class="line">    remove_swarm_agent</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">" -&gt; Removing Swarm Manager"</span></span><br><span class="line">    remove_swarm_manager</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">" -&gt; Removing Controller"</span></span><br><span class="line">    remove_controller</span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Done"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Unknown action <span class="variable">$ACTION</span>"</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://www.cnblogs.com/kevingrace/p/6867820.html" target="_blank" rel="noopener">https://www.cnblogs.com/kevingrace/p/6867820.html</a></p>
<p><a href="https://www.fcwys.cc/index.php/archives/145.html" target="_blank" rel="noopener">https://www.fcwys.cc/index.php/archives/145.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kxinter.github.io/kxinter.gitub.io/kxinter.gitub.io/2018/08/20/Oracle-11g-R2安装教程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/kxinter.gitub.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OperationMAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/kxinter.gitub.io/2018/08/20/Oracle-11g-R2安装教程/" itemprop="url">Oracle-11g-R2安装教程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-20T07:36:34+08:00">
                2018-08-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/kxinter.gitub.io/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/kxinter.gitub.io/categories/Linux/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一、安装Oracle前准备"><a href="#一、安装Oracle前准备" class="headerlink" title="一、安装Oracle前准备"></a>一、安装Oracle前准备</h1><h2 id="1-创建运行oracle数据库的系统用户和用户组"><a href="#1-创建运行oracle数据库的系统用户和用户组" class="headerlink" title="1.创建运行oracle数据库的系统用户和用户组"></a>1.创建运行oracle数据库的系统用户和用户组</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[sonny@localhost ~]$ su root　　<span class="comment">#切换到root</span></span><br><span class="line">Password: </span><br><span class="line">[root@localhost sonny]<span class="comment"># groupadd oinstall　　#创建用户组oinstall</span></span><br><span class="line">[root@localhost sonny]<span class="comment"># groupadd dba　　#创建用户组dba</span></span><br><span class="line">[root@localhost sonny]<span class="comment"># useradd -g oinstall -g dba -m oracle　　#创建oracle用户，并加入到oinstall和dba用户组</span></span><br><span class="line">[root@localhost sonny]<span class="comment"># passwd oracle　　#设置用户oracle的登陆密码，不设置密码，在CentOS的图形登陆界面没法登陆</span></span><br><span class="line">Changing password <span class="keyword">for</span> user oracle.</span><br><span class="line">New password: 　　<span class="comment"># 密码</span></span><br><span class="line">BAD PASSWORD: The password is shorter than 8 characters</span><br><span class="line">Retype new password: 　　<span class="comment"># 确认密码</span></span><br><span class="line">passwd: all authentication tokens updated successfully.</span><br><span class="line">[root@localhost sonny]<span class="comment"># id oracle # 查看新建的oracle用户</span></span><br><span class="line">uid=1001(oracle) gid=1002(dba) groups=1002(dba)</span><br><span class="line">[root@localhost sonny]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h2 id="2-创建oracle数据库安装目录"><a href="#2-创建oracle数据库安装目录" class="headerlink" title="2.创建oracle数据库安装目录"></a>2.创建oracle数据库安装目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[sonny@localhost ~]$ su root</span><br><span class="line">Password: </span><br><span class="line">[root@localhost sonny]<span class="comment"># mkdir -p /data/oracle　　#oracle数据库安装目录</span></span><br><span class="line">[root@localhost sonny]<span class="comment"># mkdir -p /data/oraInventory　　#oracle数据库配置文件目录</span></span><br><span class="line">[root@localhost sonny]<span class="comment"># mkdir -p /data/database　　#oracle数据库软件包解压目录</span></span><br><span class="line">[root@localhost sonny]<span class="comment"># cd /data</span></span><br><span class="line">[root@localhost data]<span class="comment"># ls　　#创建完毕检查一下（强迫症）</span></span><br><span class="line">database  oracle  oraInventory</span><br><span class="line">[root@localhost data]<span class="comment"># chown -R oracle:oinstall /data/oracle　　#设置目录所有者为oinstall用户组的oracle用户</span></span><br><span class="line">[root@localhost data]<span class="comment"># chown -R oracle:oinstall /data/oraInventory</span></span><br><span class="line">[root@localhost data]<span class="comment"># chown -R oracle:oinstall /data/database</span></span><br><span class="line">[root@localhost data]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h2 id="3-修改OS系统标识"><a href="#3-修改OS系统标识" class="headerlink" title="3.修改OS系统标识"></a>3.修改OS系统标识</h2><p>oracle默认不支持CentOS系统安装，Oracle Database 11g Release 2 的 OS要求参考： <a href="https://docs.oracle.com/cd/E11882_01/install.112/e47689/pre_install.htm#LADBI1106" target="_blank" rel="noopener">https://docs.oracle.com/cd/E11882_01/install.112/e47689/pre_install.htm#LADBI1106</a></p>
<p>我安装是64位数据库，On Linux x86-64：Red Hat Enterprise Linux 7  （RHEL 7）</p>
<p>另外，CentOS7.0.1511 基于 RHEL7.2  参考：<a href="http://www.linuxidc.com/Linux/2015-12/126283.htm" target="_blank" rel="noopener">http://www.linuxidc.com/Linux/2015-12/126283.htm</a></p>
<p>修改文件 /etc/RedHat-release</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[sonny<span class="variable">@localhost</span> data]<span class="variable">$ </span>su root</span><br><span class="line"><span class="symbol">Password:</span> </span><br><span class="line">[root<span class="variable">@localhost</span> data]<span class="comment"># cat /proc/version </span></span><br><span class="line">Linux version <span class="number">3.10</span>.<span class="number">0</span>-<span class="number">327</span>.el7.x86_64 (builder<span class="variable">@kbuilder</span>.dev.centos.org) (gcc version <span class="number">4.8</span>.<span class="number">3</span> <span class="number">20140911</span> (Red Hat <span class="number">4.8</span>.<span class="number">3</span>-<span class="number">9</span>) (GCC) ) <span class="comment">#1 SMP Thu Nov 19 22:10:57 UTC 2015</span></span><br><span class="line">[root<span class="variable">@localhost</span> data]<span class="comment"># cat /etc/redhat-release　　</span></span><br><span class="line">CentOS Linux release <span class="number">7.2</span>.<span class="number">1511</span> (Core) </span><br><span class="line">[root<span class="variable">@localhost</span> data]<span class="comment"># vi /etc/redhat-release</span></span><br><span class="line">[root<span class="variable">@localhost</span> data]<span class="comment"># cat /etc/redhat-release </span></span><br><span class="line">redhat-<span class="number">7</span> </span><br><span class="line">[root<span class="variable">@localhost</span> data]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h2 id="4-安装oracle数据库所需要的软件包"><a href="#4-安装oracle数据库所需要的软件包" class="headerlink" title="4.安装oracle数据库所需要的软件包"></a>4.安装oracle数据库所需要的软件包</h2><p>重复一遍，我安装时Oracle Database 11g Release 2 64位数据库。</p>
<p>Oracle Database Package Requirements for Linux x86-64 如下：（参考：<a href="https://docs.oracle.com/cd/E11882_01/install.112/e47689/pre_install.htm#BABCFJFG）" target="_blank" rel="noopener">https://docs.oracle.com/cd/E11882_01/install.112/e47689/pre_install.htm#BABCFJFG）</a></p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">操作系统:<span class="keyword">Oracle </span>Linux <span class="number">7</span> <span class="keyword">and </span>Red Hat Enterprise Linux <span class="number">7</span></span><br><span class="line">The following packages (<span class="keyword">or </span>later versions) must <span class="keyword">be </span><span class="keyword">installed:</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">$ </span>yum <span class="keyword">install </span><span class="keyword">binutils </span>compat-libstdc++ compat-libstdc++-<span class="number">33</span> elfutils-libelf-devel gcc gcc-c++ glibc-devel glibc-headers ksh libaio-devel libstdc++-devel make sysstat unixODBC-devel <span class="keyword">binutils-* </span>compat-libstdc++* elfutils-libelf* glibc* gcc-* libaio* libgcc* libstdc++* make* sysstat* unixODBC* wget unzip</span><br></pre></td></tr></table></figure>
<h2 id="5-关闭防火墙-CentOS-7-2默认使用的是firewall作为防火墙"><a href="#5-关闭防火墙-CentOS-7-2默认使用的是firewall作为防火墙" class="headerlink" title="5.关闭防火墙 CentOS 7.2默认使用的是firewall作为防火墙"></a>5.关闭防火墙 CentOS 7.2默认使用的是firewall作为防火墙</h2><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl <span class="keyword">disable</span> firewalld</span><br><span class="line">$ systemctl <span class="keyword">stop</span> firewalld</span><br></pre></td></tr></table></figure>
<h2 id="6-关闭selinux（需重启生效）"><a href="#6-关闭selinux（需重启生效）" class="headerlink" title="6.关闭selinux（需重启生效）"></a>6.关闭selinux（需重启生效）</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[root@localhost /]</span><span class="comment"># vi /etc/selinux/config</span></span><br><span class="line"><span class="section">[root@localhost /]</span><span class="comment"># cat /etc/selinux/config</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This file controls the state of SELinux on the system.</span></span><br><span class="line"><span class="comment"># SELINUX= can take one of these three values:</span></span><br><span class="line"><span class="comment">#     enforcing - SELinux security policy is enforced.</span></span><br><span class="line"><span class="comment">#     permissive - SELinux prints warnings instead of enforcing.</span></span><br><span class="line"><span class="comment">#     disabled - No SELinux policy is loaded.</span></span><br><span class="line"><span class="attr">SELINUX</span>=disabled   #此处修改为disabled</span><br><span class="line"><span class="comment"># SELINUXTYPE= can take one of three two values:</span></span><br><span class="line"><span class="comment">#     targeted - Targeted processes are protected,</span></span><br><span class="line"><span class="comment">#     minimum - Modification of targeted policy. Only selected processes are protected. </span></span><br><span class="line"><span class="comment">#     mls - Multi Level Security protection.</span></span><br><span class="line"><span class="attr">SELINUXTYPE</span>=targeted</span><br></pre></td></tr></table></figure>
<h2 id="7-修改内核参数"><a href="#7-修改内核参数" class="headerlink" title="7.修改内核参数"></a>7.修改内核参数</h2><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[sonny@localhost /]$ su root</span><br><span class="line">Password: </span><br><span class="line">[root@localhost /]<span class="comment"># vi /etc/sysctl.conf </span></span><br><span class="line">[root@localhost /]<span class="comment"># cat /etc/sysct.conf</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat: /etc/sysct.conf: No such file <span class="literal">or</span> directory</span><br><span class="line">[root@localhost /]<span class="comment"># cat /etc/sysctl.conf </span></span><br><span class="line"><span class="comment"># System default settings live in /usr/lib/sysctl.d/00-system.conf.</span></span><br><span class="line"><span class="comment"># To override those settings, enter new settings here, or in an /etc/sysctl.d/&lt;name&gt;.conf file</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For more information, see sysctl.conf(5) and sysctl.d(5).</span></span><br><span class="line">net.ipv4.<span class="attr">icmp_echo_ignore_broadcasts</span> = <span class="number">1</span></span><br><span class="line">net.ipv4.conf.all.<span class="attr">rp_filter</span> = <span class="number">1</span></span><br><span class="line">fs.<span class="attr">file-max</span> = <span class="number">6815744</span> <span class="comment">#设置最大打开文件数</span></span><br><span class="line">fs.<span class="attr">aio-max-nr</span> = <span class="number">1048576</span></span><br><span class="line">kernel.<span class="attr">shmall</span> = <span class="number">2097152</span> <span class="comment">#共享内存的总量，8G内存设置：2097152*4k/1024/1024</span></span><br><span class="line">kernel.<span class="attr">shmmax</span> = <span class="number">2147483648</span> <span class="comment">#最大共享内存的段大小</span></span><br><span class="line">kernel.<span class="attr">shmmni</span> = <span class="number">4096</span> <span class="comment">#整个系统共享内存端的最大数</span></span><br><span class="line">kernel.<span class="attr">sem</span> = <span class="number">250</span> <span class="number">32000</span> <span class="number">100</span> <span class="number">128</span></span><br><span class="line">net.ipv4.<span class="attr">ip_local_port_range</span> = <span class="number">9000</span> <span class="number">65500</span> <span class="comment">#可使用的IPv4端口范围</span></span><br><span class="line">net.core.<span class="attr">rmem_default</span> = <span class="number">262144</span></span><br><span class="line">net.core.<span class="attr">rmem_max=</span> <span class="number">4194304</span></span><br><span class="line">net.core.<span class="attr">wmem_default=</span> <span class="number">262144</span></span><br><span class="line">net.core.<span class="attr">wmem_max=</span> <span class="number">1048576</span></span><br><span class="line">[root@localhost /]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">使配置参数生效</span><br><span class="line"></span><br><span class="line">[root@localhost /]<span class="comment"># sysctl -p</span></span><br><span class="line"></span><br><span class="line">net.ipv4.<span class="attr">icmp_echo_ignore_broadcasts</span> = <span class="number">1</span></span><br><span class="line">net.ipv4.conf.all.<span class="attr">rp_filter</span> = <span class="number">1</span></span><br><span class="line">sysctl: setting key <span class="string">"fs.file-max"</span>: Invalid argument</span><br><span class="line">fs.<span class="attr">file-max</span> = <span class="number">6815744</span> <span class="comment">#设置最大打开文件数</span></span><br><span class="line">fs.<span class="attr">aio-max-nr</span> = <span class="number">1048576</span></span><br><span class="line">sysctl: setting key <span class="string">"kernel.shmall"</span>: Invalid argument</span><br><span class="line">kernel.<span class="attr">shmall</span> = <span class="number">2097152</span> <span class="comment">#共享内存的总量，8G内存设置：2097152*4k/1024/1024</span></span><br><span class="line">sysctl: setting key <span class="string">"kernel.shmmax"</span>: Invalid argument</span><br><span class="line">kernel.<span class="attr">shmmax</span> = <span class="number">2147483648</span> <span class="comment">#最大共享内存的段大小</span></span><br><span class="line">sysctl: setting key <span class="string">"kernel.shmmni"</span>: Invalid argument</span><br><span class="line">kernel.<span class="attr">shmmni</span> = <span class="number">4096</span> <span class="comment">#整个系统共享内存端的最大数</span></span><br><span class="line">kernel.<span class="attr">sem</span> = <span class="number">250</span> <span class="number">32000</span> <span class="number">100</span> <span class="number">128</span></span><br><span class="line">sysctl: setting key <span class="string">"net.ipv4.ip_local_port_range"</span>: Invalid argument</span><br><span class="line">net.ipv4.<span class="attr">ip_local_port_range</span> = <span class="number">9000</span> <span class="number">65500</span> <span class="comment">#可使用的IPv4端口范围</span></span><br><span class="line">net.core.<span class="attr">rmem_default</span> = <span class="number">262144</span></span><br><span class="line">net.core.<span class="attr">rmem_max</span> = <span class="number">4194304</span></span><br><span class="line">net.core.<span class="attr">wmem_default</span> = <span class="number">262144</span></span><br><span class="line">net.core.<span class="attr">wmem_max</span> = <span class="number">1048576</span></span><br><span class="line">[root@localhost /]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h2 id="8-解压安装包"><a href="#8-解压安装包" class="headerlink" title="8.解压安装包"></a>8.解压安装包</h2><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[oracle<span class="variable">@localhost</span> /]<span class="variable">$ </span>cd /usr/local/src　　<span class="comment">#进入/usr/local/src目录</span></span><br><span class="line">[oracle<span class="variable">@localhost</span> src]<span class="variable">$ </span>ls</span><br><span class="line">linux.x64_11gR2_database_1of2.zip  linux.x64_11gR2_database_2of2.zip</span><br><span class="line">[oracle<span class="variable">@localhost</span> src]<span class="variable">$ </span>unzip linux.x64_11gR2_database_1of2.zip -d /data/database/　　<span class="comment">#解压</span></span><br><span class="line">(省略...)</span><br><span class="line">[oracle<span class="variable">@localhost</span> src]<span class="variable">$ </span>unzip linux.x64_11gR2_database_2of2.zip -d /data/database/　　<span class="comment">#解压</span></span><br><span class="line">(省略...)</span><br><span class="line">[oracle<span class="variable">@localhost</span> src]<span class="variable">$ </span>su root</span><br><span class="line"><span class="symbol">Password:</span> </span><br><span class="line">[root<span class="variable">@localhost</span> src]<span class="comment"># chown -R oracle:oinstall /data/database/database/</span></span><br><span class="line">[root<span class="variable">@localhost</span> src]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h1 id="二、oracle安装"><a href="#二、oracle安装" class="headerlink" title="二、oracle安装"></a>二、oracle安装</h1><p>1.图形界面登陆oracle用户：</p>
<blockquote>
<p>备注：root用户切换到oracle用户无法安装报错，必须使用oracle直接登录，否则报如下错误</p>
<p>==Exception in thread “main” java.lang.NoClassDefFoundError==</p>
</blockquote>
<p><img src="1.png" alt="enter description here"></p>
<p>2.启动oralce安装，到/data/database/database/目录下，执行runInstaller<br> <img src="2.png" alt="enter description here"><br>3.去掉勾，懒得填，个人使用环境不需要自动接收Oracle的安全更新。<br> <img src="3.png" alt="enter description here"><br>4.下一步，只安装数据库软件，个人用不要那些玩意~~<br><img src="4.png" alt="enter description here"><br>5.选择单例安装，前面的所有配置均为单例安装。<br> <img src="5.png" alt="enter description here"><br>6.添加语言<br><img src="6.png" alt="enter description here"><br>7.默认安装版本企业版-Enterprise Edition<br>8.确定数据软件的安装路径，自动读取前面Oracle环境变量中配置的值。<br><img src="8.png" alt="enter description here"><br>9.理论上要创建Database Operation（OSOPER）Group:oper ,个人用，懒得建，就使用dba用户组<br><img src="9.png" alt="enter description here"><br>10.安装检查，按照提示信息一个一个解决。<br><img src="10.png" alt="enter description here"><br>11.一个一个检查package，在准备阶段中漏掉的，此处再安装，有些系统报错是因为现有的包的版本比检测要高，最后忽略即可。（点击Check_Again 多检查几次）<br><img src="11.png" alt="enter description here"><br>12.准备完毕，fuck “Finish”开始安装。<br><img src="12.png" alt="enter description here"><br>14.提示安装成功。安装日志懒得看，再说。<br><img src="14.png" alt="enter description here"></p>
<h1 id="三、配置监听listener"><a href="#三、配置监听listener" class="headerlink" title="三、配置监听listener"></a>三、配置监听listener</h1><p>1.执行netca 报错</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[@localhost ~]$ netca</span><br><span class="line"></span><br><span class="line"><span class="symbol">Oracle</span> <span class="symbol">Net</span> <span class="symbol">Services</span> <span class="symbol">Configuration</span>:</span><br><span class="line">#</span><br><span class="line"># <span class="symbol">An</span> unexpected error has been detected by <span class="symbol">HotSpot</span> <span class="symbol">Virtual</span> <span class="symbol">Machine</span>:</span><br><span class="line">#</span><br><span class="line">#  <span class="symbol">SIGSEGV</span> (<span class="number">0xb</span>) at pc=<span class="number">0x00007f69a69fcb9d</span>, pid=<span class="number">8033</span>, tid=<span class="number">140092892297024</span></span><br><span class="line">#</span><br><span class="line"># <span class="symbol">Java</span> <span class="symbol">VM</span>: <span class="symbol">Java</span> <span class="symbol">HotSpot</span>(<span class="symbol">TM</span>) <span class="number">64</span>-<span class="symbol">Bit</span> <span class="symbol">Server</span> <span class="symbol">VM</span> (<span class="number">1.5</span><span class="number">.0</span><span class="symbol">_17</span>-b03 mixed mode)</span><br><span class="line"># <span class="symbol">Problematic</span> frame:</span><br><span class="line"># <span class="symbol">C</span>  [libclntsh.so<span class="number">.11</span><span class="number">.1</span>+<span class="number">0x62ab9d</span>]  snlinGetAddrInfo+<span class="number">0x1b1</span></span><br><span class="line">#</span><br><span class="line"># <span class="symbol">An</span> error report file with more information is saved as hs_err_pid8033.log</span><br><span class="line">#</span><br><span class="line"># <span class="symbol">If</span> you would like to submit a bug report, please visit:</span><br><span class="line">#   http://java.sun.com/webapps/bugreport/crash.jsp</span><br><span class="line">#</span><br><span class="line">/data/oracle/product/<span class="number">11.2</span><span class="number">.0</span>/db_1/bin/netca: line <span class="number">178</span>:  <span class="number">8033</span> <span class="symbol">Aborted</span>                 (core dumped) $<span class="symbol">JRE</span> $<span class="symbol">JRE_OPTIONS</span> -classpath $<span class="symbol">CLASSPATH</span> oracle.net.ca.<span class="symbol">NetCA</span> $*</span><br><span class="line">[oracle@localhost ~]$</span><br></pre></td></tr></table></figure>
<p>错误原因：安装操作系统是默认主机名localhost造成错误</p>
<p>解决办法：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[racle]<span class="comment"># cat /etc/sysconfig/network</span></span><br><span class="line"><span class="comment"># Created by anaconda</span></span><br><span class="line"></span><br><span class="line">[root<span class="meta">@localhost</span> oracle]<span class="comment"># vi /etc/sysconfig/network　　#增加HOSTNAME</span></span><br><span class="line">[root<span class="meta">@localhost</span> oracle]<span class="comment"># cat /etc/sysconfig/network</span></span><br><span class="line"><span class="comment"># Created by anaconda</span></span><br><span class="line">HOSTNAME=odb-sonny</span><br><span class="line">[root<span class="meta">@localhost</span> oracle]<span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">[root<span class="meta">@localhost</span> oracle]<span class="comment"># vi /etc/hosts　　#增加HOSTNAME&lt;/strong&gt;</span></span><br><span class="line">[root<span class="meta">@localhost</span> oracle]<span class="comment"># cat /etc/hosts     </span></span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 odb-sonny</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">[root<span class="meta">@localhost</span> oracle]<span class="comment"># hostname odb-sonny　　#执行</span></span><br><span class="line">[root<span class="meta">@localhost</span> oracle]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>最后注销当前oracle用户，重新登陆即可！！这次发现打开配置界面正常，安装windows下面配置即可。<br><img src="15.png" alt="enter description here"></p>
<h1 id="四、创建Oracle数据实例Orcl"><a href="#四、创建Oracle数据实例Orcl" class="headerlink" title="四、创建Oracle数据实例Orcl"></a>四、创建Oracle数据实例Orcl</h1><p>执行dbca命令，启动oracle实例安装界面，剩下的与Windows上安装一样，不废话了：</p>
<p>注意：必须先创建监听，并且监听是启动中，否则报错。<br><img src="16.png" alt="enter description here"></p>
<h1 id="问题总结"><a href="#问题总结" class="headerlink" title="问题总结"></a>问题总结</h1><h2 id="问题一："><a href="#问题一：" class="headerlink" title="问题一："></a>问题一：</h2><p>root用户切换到oracle用户无法安装报错，必须使用oracle直接登录，否则报如下错误</p>
<p><strong><em>Exception in thread “main” java.lang.NoClassDefFoundError</em></strong></p>
<h2 id="问题二："><a href="#问题二：" class="headerlink" title="问题二："></a>问题二：</h2><p>Oracle 安装报错 <strong><em>[INS-06101] IP address of localhost could not be determined</em></strong> 解决方法</p>
<p>出现这种错误是因为主机名和/etc/hosts 文件不一致，只需要把主机名和其IP 写入/etc/hosts 文件，就ok了。</p>
<h2 id="问题三："><a href="#问题三：" class="headerlink" title="问题三："></a>问题三：</h2><p>在ORACLE11G R2 安装ORACLE时出现以下错误：</p>
<p><strong><em>[INS-08109] Unexpected error occurred while validating inputs at state ‘getOCMDetails’.</em></strong></p>
<p>经GOOGLE看到</p>
<p><a href="http://www.linkedin.com/groups/I-try-clone-oracle-grid-77941.S.38808726" target="_blank" rel="noopener">http://www.linkedin.com/groups/I-try-clone-oracle-grid-77941.S.38808726</a></p>
<p>说是使用了 LD_LIBRARY_PATH 环境参数，经查看.bash_profile ，有如下设置：</p>
<p>LD_LIBRARY_PATH=$ORACLE_HOME/lib:/lib:/usr/lib; export LD_LIBRARY_PATH</p>
<p>注释掉后，问题解决。</p>
<h2 id="问题四："><a href="#问题四：" class="headerlink" title="问题四："></a>问题四：</h2><p><strong><em>“#Error in invoking target ‘install’ of makefile ‘/data/oracle/product/11.2.0/db_1/ctx/lib/ins_ctx.mk’”</em></strong><br>解决方法：打开一个新的终端，使用root身份登入，</p>
<p>#vi ORACLE_HOME/ctx/lib/ins_ctx.mk<br>找到<br>ctxhx: $(CTXHXOBJ)<br>$(LINK_CTXHX) $(CTXHXOBJ) $(INSO_LINK)<br>修改为(添加红色部分):                   ctxhx: $(CTXHXOBJ)<br><strong><em>-static</em></strong>  $(LINK_CTXHX) $(CTXHXOBJ) $(INSO_LINK)  <strong><em>/usr/lib64/libc.a</em></strong></p>
<h2 id="问题五："><a href="#问题五：" class="headerlink" title="问题五："></a>问题五：</h2><p><strong><em>“#Error in invoking target ‘agent nmhs’ of makefile ‘/home/oracle_11/app/oracle/product/11.2.0/db_1/sysman/lib/ins_emagent.mk’”</em></strong><br>解决方法：打开一个新的终端，使用root身份登入，</p>
<p>#vi $ORACLE_HOME/sysman/lib/ins_emagent.mk<br>找到<br>$(MK_EMAGENT_NMECTL)<br>修改为(添加红色部分)：<br>$(MK_EMAGENT_NMECTL) ==-lnnz11==<br>完成后在错误提示框上retry既可</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kxinter.github.io/kxinter.gitub.io/kxinter.gitub.io/2018/08/16/npm私库部署-cnpmjs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/kxinter.gitub.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OperationMAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/kxinter.gitub.io/2018/08/16/npm私库部署-cnpmjs/" itemprop="url">npm私库部署-cnpmjs</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-16T18:25:38+08:00">
                2018-08-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/kxinter.gitub.io/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="部署cnpm"><a href="#部署cnpm" class="headerlink" title="部署cnpm"></a>部署cnpm</h1><h2 id="获取代码"><a href="#获取代码" class="headerlink" title="获取代码"></a>获取代码</h2><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="keyword">clone</span> <span class="title">git</span>://github.com/fengmk2/cnpmjs.org.git</span><br></pre></td></tr></table></figure>
<h2 id="创建mysql库"><a href="#创建mysql库" class="headerlink" title="创建mysql库"></a>创建mysql库</h2><p>Default</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> cnpmjs;</span><br><span class="line"><span class="keyword">use</span> cnpmjs;</span><br><span class="line">source docs/db.sql【db.sql位于cnpmjs.org/docs/db.sql】</span><br></pre></td></tr></table></figure>
<h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><p>安装依赖其实就是一个 npm install，不过 CNPM 把该指令已经写到 Makefile 里面了，所以直接执行下面的命令就好了。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> cnpmjs.org </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm install</span></span><br></pre></td></tr></table></figure></p>
<p>当然万一你是 Windows 用户或者不会 make，那么还是要用 npm install。<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install <span class="params">--build-from-source</span> <span class="params">--registry=https</span>:<span class="string">//registry.npm.taobao.org</span> <span class="params">--disturl=https</span>:<span class="string">//npm.taobao.org/mirrors/node</span></span><br></pre></td></tr></table></figure></p>
<h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><p>修改配置</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vim</span> /cnpmjs.org/config/<span class="built_in">index</span>.js</span><br></pre></td></tr></table></figure>
<p><img src="1.png" alt="enter description here"></p>
<p>cnpm提供两个端口：7001和7002，其中7001用于NPM的注册服务，7002用于Web访问。</p>
<p>bindingHost为安装cnpm的服务器ip地址，也就是在浏览器中只能通过访问<a href="http://192.168.48.57来访问cnpm以及获取npm的注册服务。" target="_blank" rel="noopener">http://192.168.48.57来访问cnpm以及获取npm的注册服务。</a></p>
<p><img src="2.png" alt="2"><br>按照之前创建的数据库来进行配置</p>
<p>这里将会列举一些常用的配置项，其余的一些配置项请自行参考 config/index.js 文件。</p>
<h3 id="配置字段参考"><a href="#配置字段参考" class="headerlink" title="配置字段参考"></a>配置字段参考</h3><p><a href="https://segmentfault.com/a/1190000005946580" target="_blank" rel="noopener">https://segmentfault.com/a/1190000005946580</a></p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">enableCluster：</span>是否启用 <span class="string">cluster-worker </span>模式启动服务，默认 <span class="string">false，</span>生产环节推荐为 <span class="string">true;</span></span><br><span class="line"><span class="string">registryPort：</span><span class="string">API </span>专用的 <span class="string">registry </span>服务端口，默认 <span class="string">7001；</span></span><br><span class="line"><span class="string">webPort：</span><span class="string">Web </span>服务端口，默认 <span class="string">7002；</span></span><br><span class="line"><span class="string">bindingHost：</span>监听绑定的 <span class="string">Host，</span>默认为 <span class="string">127.</span>0.0.1，如果外面架了一层本地的 <span class="string">Nginx </span>反向代理或者 <span class="string">Apache </span>反向代理的话推荐不用改；</span><br><span class="line"><span class="string">sessionSecret：</span><span class="string">session </span>用的盐；</span><br><span class="line"><span class="string">logdir：</span>日志目录；</span><br><span class="line"><span class="string">uploadDir：</span>临时上传文件目录；</span><br><span class="line"><span class="string">viewCache：</span>视图模板缓存是否开启，默认为 <span class="string">false；</span></span><br><span class="line"><span class="string">enableCompress：</span>是否开启 <span class="string">gzip </span>压缩，默认为 <span class="string">false；</span></span><br><span class="line"><span class="string">admins：</span>管理员们，这是一个 <span class="string">JSON </span><span class="string">Object，</span>对应各键名为各管理员的用户名，键值为其邮箱，默认为 &#123; <span class="string">fengmk2:</span> <span class="string">'fengmk2@gmail.com'</span>, <span class="string">admin:</span> <span class="string">'admin@cnpmjs.org'</span>, <span class="string">dead_horse:</span> <span class="string">'dead_horse@qq.com'</span> &#125;；</span><br><span class="line"><span class="string">logoURL：</span><span class="string">Logo </span>地址，不过对于我这个已经把 <span class="string">CNPM </span>前端改得面目全非的人来说已经忽略了这个配置了；</span><br><span class="line"><span class="string">adBanner：</span>广告 <span class="string">Banner </span>的地址；</span><br><span class="line"><span class="string">customReadmeFile：</span>实际上我们看到的 <span class="string">cnpmjs.</span><span class="string">org </span>首页中间一大堆冗长的介绍是一个 <span class="string">Markdown </span>文件转化而成的，你可以设置该项来自行替换这个文件；</span><br><span class="line"><span class="string">customFooter：</span>自定义页脚模板；</span><br><span class="line"><span class="string">npmClientName：</span>默认为 <span class="string">cnpm，</span>如果你有自己开发或者 <span class="string">fork </span>的 <span class="string">npm </span>客户端的话请改成自己的 <span class="string">CLI </span>命令，这个应该会在一些页面的说明处替换成你所写的；</span><br><span class="line"><span class="string">backupFilePrefix：</span>备份目录；</span><br><span class="line"><span class="string">database：</span>数据库相关配置，为一个对象，默认如果不配置将会是一个 ~/.<span class="string">cnpmjs.</span><span class="string">org/</span><span class="string">data.</span><span class="string">sqlite </span>的 <span class="string">SQLite；</span></span><br><span class="line"><span class="string">db：</span>数据的库名；</span><br><span class="line"><span class="string">username：</span>数据库用户名；</span><br><span class="line"><span class="string">password：</span>数据库密码；</span><br><span class="line"><span class="string">dialect：</span>数据库适配器，可选 <span class="string">"mysql"</span>、<span class="string">"sqlite"</span>、<span class="string">"postgres"</span>、<span class="string">"mariadb"</span>，默认为 <span class="string">"sqlite"</span>；</span><br><span class="line"><span class="string">hsot：</span>数据库地址；</span><br><span class="line"><span class="string">port：</span>数据库端口；</span><br><span class="line"><span class="string">pool：</span>数据库连接池相关配置，为一个对象；</span><br><span class="line"><span class="string">maxConnections：</span>最大连接数，默认为 <span class="string">10；</span></span><br><span class="line"><span class="string">minConnections：</span>最小连接数，默认为 0；</span><br><span class="line"><span class="string">maxIdleTime：</span>单条链接最大空闲时间，默认为 <span class="string">30000 </span>毫秒；</span><br><span class="line"><span class="string">storege：</span>仅对 <span class="string">SQLite </span>配置有效，数据库地址，默认为 ~/.<span class="string">cnpmjs/</span><span class="string">data.</span><span class="string">sqlite；</span></span><br><span class="line"><span class="string">nfs：</span>包文件系统处理对象，为一个 <span class="string">Node.</span><span class="string">js </span>对象，默认是 [<span class="string">fs-cnpm]</span>() 这个包，并且配置在 ~/.<span class="string">cnpmjs/</span><span class="string">nfs </span>目录下，也就是说默认所有同步的包都会被放在这个目录下；开发者可以使用别的一些文件系统插件（如上传到又拍云等）,又或者自己去按接口开发一个逻辑层，这些都是后话了；</span><br><span class="line"><span class="string">registryHost：</span>暂时还未试过，我猜是用于 <span class="string">Web </span>页面显示用的，默认为 r.<span class="string">cnpmjs.</span><span class="string">org；</span></span><br><span class="line"><span class="string">enablePrivate：</span>是否开启私有模式，默认为 <span class="string">false；</span></span><br><span class="line">如果是私有模式则只有管理员能发布包，其它人只能从源站同步包；</span><br><span class="line">如果是非私有模式则所有登录用户都能发布包；</span><br><span class="line"><span class="string">scopes：</span>非管理员发布包的时候只能用以 <span class="string">scopes </span>里面列举的命名空间为前缀来发布，如果没设置则无法发布，也就是说这是一个必填项，默认为 [ <span class="string">'@cnpm'</span>, <span class="string">'@cnpmtest'</span>, <span class="string">'@cnpm-test'</span> ]，据苏千大大解释是为了便于管理以及让公司的员工自觉按需发布；更多关于 <span class="string">NPM </span><span class="string">scope </span>的说明请参见 <span class="string">npm-scope；</span></span><br><span class="line"><span class="string">privatePackages：</span>就如该配置项的注释所述，出于历史包袱的原因，有些已经存在的私有包（可能之前是用 <span class="string">Git </span>的方式安装的）并没有以命名空间的形式来命名，而这种包本来是无法上传到 <span class="string">CNPM </span>的，这个配置项数组就是用来加这些例外白名单的，默认为一个空数组；</span><br><span class="line"><span class="string">sourceNpmRegistry：</span>更新源 <span class="string">NPM </span>的 <span class="string">registry </span>地址，默认为 <span class="string">https:</span>//<span class="string">registry.</span><span class="string">npm.</span><span class="string">taobao.</span><span class="string">org；</span></span><br><span class="line"><span class="string">sourceNpmRegistryIsCNpm：</span>源 <span class="string">registry </span>是否为 <span class="string">CNPM，</span>默认为 <span class="string">true，</span>如果你使用的源是官方 <span class="string">NPM </span>源，请将其设为 <span class="string">false；</span></span><br><span class="line"><span class="string">syncByInstall：</span>如果安装包的时候发现包不存在，则尝试从更新源同步，默认为 <span class="string">true；</span></span><br><span class="line"><span class="string">syncModel：</span>更新模式（不过我觉得是个 <span class="string">typo）</span>，有下面几种模式可以选择，默认为 <span class="string">"none"</span>;</span><br><span class="line"><span class="string">"none"</span>：永不同步，只管理私有用户上传的包，其它源包会直接从源站获取；</span><br><span class="line"><span class="string">"exist"</span>：定时同步已经存在于数据库的包；</span><br><span class="line"><span class="string">"all"</span>：定时同步所有源站的包；</span><br><span class="line"><span class="string">syncInterval：</span>同步间隔，默认为 <span class="string">"10m"</span> 即十分钟；</span><br><span class="line"><span class="string">syncDevDependencies：</span>是否同步每个包里面的 <span class="string">devDependencies </span>包们，默认为 <span class="string">false；</span></span><br><span class="line"><span class="string">badgeSubject：</span>包的 <span class="string">badge </span>显示的名字，默认为 <span class="string">cnpm；</span></span><br><span class="line"><span class="string">userService：</span>用户验证接口，默认为 <span class="string">null，</span>即无用户相关功能也就是无法有用户去上传包，该部分需要自己实现接口功能并配置，如与公司的 <span class="string">Gitlab </span>相对接，这也是后话了；</span><br><span class="line"><span class="string">alwaysAuth：</span>是否始终需要用户验证，即便是 $ <span class="string">cnpm </span><span class="string">install </span>等命令；</span><br><span class="line"><span class="string">httpProxy：</span>代理地址设置，用于你在墙内源站在墙外的情况。</span><br></pre></td></tr></table></figure>
<p>下面是index.js配置实例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> mkdirp = <span class="built_in">require</span>(<span class="string">'mkdirp'</span>);</span><br><span class="line"><span class="keyword">var</span> copy = <span class="built_in">require</span>(<span class="string">'copy-to'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> os = <span class="built_in">require</span>(<span class="string">'os'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> version = <span class="built_in">require</span>(<span class="string">'../package.json'</span>).version;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> root = path.dirname(__dirname);</span><br><span class="line"><span class="keyword">var</span> dataDir = path.join(process.env.HOME || root, <span class="string">'.cnpmjs.org'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> config = &#123;</span><br><span class="line">  version: version,</span><br><span class="line">  dataDir: dataDir,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Cluster mode</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  enableCluster: <span class="literal">false</span>,</span><br><span class="line">  numCPUs: os.cpus().length,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * server configure</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">//cnpm提供两个端口：7001和7002，其中7001用于NPM的注册服务，7002用于Web访问。</span></span><br><span class="line">  registryPort: <span class="number">7001</span>,</span><br><span class="line">  webPort: <span class="number">7002</span>,</span><br><span class="line">  <span class="comment">//bindingHost为安装cnpm的服务器ip地址，也就是在浏览器中只能通过访问http://192.168.48.57来访问cnpm以及获取npm的注册服务。</span></span><br><span class="line">  bindingHost: <span class="string">'192.168.1.12'</span>, <span class="comment">// only binding on 127.0.0.1 for local access</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// debug mode</span></span><br><span class="line">  <span class="comment">// if in debug mode, some middleware like limit wont load</span></span><br><span class="line">  <span class="comment">// logger module will print to stdout</span></span><br><span class="line">  debug: process.env.NODE_ENV === <span class="string">'development'</span>,</span><br><span class="line">  <span class="comment">// page mode, enable on development env</span></span><br><span class="line">  pagemock: process.env.NODE_ENV === <span class="string">'development'</span>,</span><br><span class="line">  <span class="comment">// session secret</span></span><br><span class="line">  sessionSecret: <span class="string">'cnpmjs.org test session secret'</span>,</span><br><span class="line">  <span class="comment">// max request json body size</span></span><br><span class="line">  jsonLimit: <span class="string">'10mb'</span>,</span><br><span class="line">  <span class="comment">// log dir name</span></span><br><span class="line">  logdir: path.join(dataDir, <span class="string">'logs'</span>),</span><br><span class="line">  <span class="comment">// update file template dir</span></span><br><span class="line">  uploadDir: path.join(dataDir, <span class="string">'downloads'</span>),</span><br><span class="line">  <span class="comment">// web page viewCache</span></span><br><span class="line">  viewCache: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// config for koa-limit middleware</span></span><br><span class="line">  <span class="comment">// for limit download rates</span></span><br><span class="line">  limit: &#123;</span><br><span class="line">    enable: <span class="literal">false</span>,</span><br><span class="line">    token: <span class="string">'koa-limit:download'</span>,</span><br><span class="line">    limit: <span class="number">1000</span>,</span><br><span class="line">    interval: <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>,</span><br><span class="line">    whiteList: [],</span><br><span class="line">    blackList: [],</span><br><span class="line">    message: <span class="string">'request frequency limited, any question, please contact fengmk2@gmail.com'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  enableCompress: <span class="literal">false</span>, <span class="comment">// enable gzip response or not</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// default system admins</span></span><br><span class="line">  admins: &#123;</span><br><span class="line">    <span class="comment">// name: email</span></span><br><span class="line">    fengmk2: <span class="string">'fengmk2@gmail.com'</span>,</span><br><span class="line">    admin: <span class="string">'admin@cnpmjs.org'</span>,</span><br><span class="line">    dead_horse: <span class="string">'dead_horse@qq.com'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// email notification for errors</span></span><br><span class="line">  <span class="comment">// check https://github.com/andris9/Nodemailer for more informations</span></span><br><span class="line">  mail: &#123;</span><br><span class="line">    enable: <span class="literal">false</span>,</span><br><span class="line">    appname: <span class="string">'cnpmjs.org'</span>,</span><br><span class="line">    <span class="keyword">from</span>: <span class="string">'cnpmjs.org mail sender &lt;adderss@gmail.com&gt;'</span>,</span><br><span class="line">    service: <span class="string">'gmail'</span>,</span><br><span class="line">    auth: &#123;</span><br><span class="line">      user: <span class="string">'address@gmail.com'</span>,</span><br><span class="line">      pass: <span class="string">'your password'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  logoURL: <span class="string">'https://os.alipayobjects.com/rmsportal/oygxuIUkkrRccUz.jpg'</span>, <span class="comment">// cnpm logo image url</span></span><br><span class="line">  adBanner: <span class="string">''</span>,</span><br><span class="line">  customReadmeFile: <span class="string">''</span>, <span class="comment">// you can use your custom readme file instead the cnpm one</span></span><br><span class="line">  customFooter: <span class="string">''</span>, <span class="comment">// you can add copyright and site total script html here</span></span><br><span class="line">  npmClientName: <span class="string">'cnpm'</span>, <span class="comment">// use `$&#123;name&#125; install package`</span></span><br><span class="line">  packagePageContributorSearch: <span class="literal">true</span>, <span class="comment">// package page contributor link to search, default is true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// max handle number of package.json `dependencies` property</span></span><br><span class="line">  maxDependencies: <span class="number">200</span>,</span><br><span class="line">  <span class="comment">// backup filepath prefix</span></span><br><span class="line">  backupFilePrefix: <span class="string">'/cnpm/backup/'</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * database config</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">//配置数据库连接信息</span></span><br><span class="line">  database: &#123;</span><br><span class="line">    db: <span class="string">'cnpm'</span>,</span><br><span class="line">    username: <span class="string">'root'</span>,</span><br><span class="line">    password: <span class="string">'123456'</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// the sql dialect of the database</span></span><br><span class="line">    <span class="comment">// - currently supported: 'mysql', 'sqlite', 'postgres', 'mariadb'</span></span><br><span class="line">    dialect: <span class="string">'mysql'</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// custom host; default: 127.0.0.1</span></span><br><span class="line">    host: <span class="string">'192.168.1.12'</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// custom port; default: 3306</span></span><br><span class="line">    port: <span class="number">3306</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// use pooling in order to reduce db connection overload and to increase speed</span></span><br><span class="line">    <span class="comment">// currently only for mysql and postgresql (since v1.5.0)</span></span><br><span class="line">    pool: &#123;</span><br><span class="line">      maxConnections: <span class="number">10</span>,</span><br><span class="line">      minConnections: <span class="number">0</span>,</span><br><span class="line">      maxIdleTime: <span class="number">30000</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// the storage engine for 'sqlite'</span></span><br><span class="line">    <span class="comment">// default store into ~/.cnpmjs.org/data.sqlite</span></span><br><span class="line">    storage: path.join(dataDir, <span class="string">'data.sqlite'</span>),</span><br><span class="line"></span><br><span class="line">    logging: !!process.env.SQL_DEBUG,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// package tarball store in local filesystem by default</span></span><br><span class="line">  nfs: <span class="built_in">require</span>(<span class="string">'fs-cnpm'</span>)(&#123;</span><br><span class="line">    dir: path.join(dataDir, <span class="string">'nfs'</span>)</span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="comment">// if set true, will 302 redirect to `nfs.url(dist.key)`</span></span><br><span class="line">  downloadRedirectToNFS: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// registry url name</span></span><br><span class="line">  registryHost: <span class="string">'r.cnpmjs.org'</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * registry mode config</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// enable private mode or not</span></span><br><span class="line">  <span class="comment">// private mode: only admins can publish, other users just can sync package from source npm</span></span><br><span class="line">  <span class="comment">// public mode: all users can publish</span></span><br><span class="line">  enablePrivate: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// registry scopes, if don't set, means do not support scopes</span></span><br><span class="line">  scopes: [ <span class="string">'@cnpm'</span>, <span class="string">'@cnpmtest'</span>, <span class="string">'@cnpm-test'</span> ],</span><br><span class="line"></span><br><span class="line">  <span class="comment">// some registry already have some private packages in global scope</span></span><br><span class="line">  <span class="comment">// but we want to treat them as scoped private packages,</span></span><br><span class="line">  <span class="comment">// so you can use this white list.</span></span><br><span class="line">  privatePackages: [],</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * sync configs</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// the official npm registry</span></span><br><span class="line">  <span class="comment">// cnpm wont directly sync from this one</span></span><br><span class="line">  <span class="comment">// but sometimes will request it for some package infomations</span></span><br><span class="line">  <span class="comment">// please don't change it if not necessary</span></span><br><span class="line">  officialNpmRegistry: <span class="string">'https://registry.npmjs.com'</span>,</span><br><span class="line">  officialNpmReplicate: <span class="string">'https://replicate.npmjs.com'</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sync source, upstream registry</span></span><br><span class="line">  <span class="comment">// If you want to directly sync from official npm's registry</span></span><br><span class="line">  <span class="comment">// please drop them an email first</span></span><br><span class="line">  sourceNpmRegistry: <span class="string">'https://registry.npm.taobao.org'</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// upstream registry is base on cnpm/cnpmjs.org or not</span></span><br><span class="line">  <span class="comment">// if your upstream is official npm registry, please turn it off</span></span><br><span class="line">  sourceNpmRegistryIsCNpm: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if install return 404, try to sync from source registry</span></span><br><span class="line">  syncByInstall: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sync mode select</span></span><br><span class="line">  <span class="comment">// none: do not sync any module, proxy all public modules from sourceNpmRegistry</span></span><br><span class="line">  <span class="comment">// exist: only sync exist modules</span></span><br><span class="line">  <span class="comment">// all: sync all modules</span></span><br><span class="line">  <span class="comment">//配置从仓库同步到本地（重要）</span></span><br><span class="line">  syncModel: <span class="string">'exist'</span>, <span class="comment">// 'none', 'all', 'exist'</span></span><br><span class="line"></span><br><span class="line">  syncConcurrency: <span class="number">1</span>,</span><br><span class="line">  <span class="comment">// sync interval, default is 10 minutes</span></span><br><span class="line">  syncInterval: <span class="string">'10m'</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sync polular modules, default to false</span></span><br><span class="line">  <span class="comment">// because cnpm can't auto sync tag change for now</span></span><br><span class="line">  <span class="comment">// so we want to sync popular modules to ensure their tags</span></span><br><span class="line">  syncPopular: <span class="literal">false</span>,</span><br><span class="line">  syncPopularInterval: <span class="string">'1h'</span>,</span><br><span class="line">  <span class="comment">// top 100</span></span><br><span class="line">  topPopular: <span class="number">100</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sync devDependencies or not, default is false</span></span><br><span class="line">  syncDevDependencies: <span class="literal">false</span>,</span><br><span class="line">  <span class="comment">// try to remove all deleted versions from original registry</span></span><br><span class="line">  syncDeletedVersions: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// changes streaming sync</span></span><br><span class="line">  syncChangesStream: <span class="literal">false</span>,</span><br><span class="line">  handleSyncRegistry: <span class="string">'http://127.0.0.1:7001'</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// badge subject on http://shields.io/</span></span><br><span class="line">  badgePrefixURL: <span class="string">'https://img.shields.io/badge'</span>,</span><br><span class="line">  badgeSubject: <span class="string">'cnpm'</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// custom user service, @see https://github.com/cnpm/cnpmjs.org/wiki/Use-Your-Own-User-Authorization</span></span><br><span class="line">  <span class="comment">// when you not intend to ingegrate with your company's user system, then use null, it would</span></span><br><span class="line">  <span class="comment">// use the default cnpm user system</span></span><br><span class="line">  userService: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// always-auth https://docs.npmjs.com/misc/config#always-auth</span></span><br><span class="line">  <span class="comment">// Force npm to always require authentication when accessing the registry, even for GET requests.</span></span><br><span class="line">  alwaysAuth: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if you're behind firewall, need to request through http proxy, please set this</span></span><br><span class="line">  <span class="comment">// e.g.: `httpProxy: 'http://proxy.mycompany.com:8080'`</span></span><br><span class="line">  httpProxy: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// snyk.io root url</span></span><br><span class="line">  snykUrl: <span class="string">'https://snyk.io'</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// https://github.com/cnpm/cnpmjs.org/issues/1149</span></span><br><span class="line">  <span class="comment">// if enable this option, must create module_abbreviated and package_readme table in database</span></span><br><span class="line">  <span class="comment">//enableAbbreviatedMetadata: false,</span></span><br><span class="line">  <span class="comment">//配置enableAbbreviatedMetadata为true（默认false）,解决不能同步。重要！</span></span><br><span class="line">  enableAbbreviatedMetadata: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// global hook function: function* (envelope) &#123;&#125;</span></span><br><span class="line">  <span class="comment">// envelope format please see https://github.com/npm/registry/blob/master/docs/hooks/hooks-payload.md#payload</span></span><br><span class="line">  globalHook: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  opensearch: &#123;</span><br><span class="line">    host: <span class="string">''</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'test'</span>) &#123;</span><br><span class="line">  config.enableAbbreviatedMetadata = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'test'</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> customConfig;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'development'</span>) &#123;</span><br><span class="line">    customConfig = path.join(root, <span class="string">'config'</span>, <span class="string">'config.js'</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 1. try to load `$dataDir/config.json` first, not exists then goto 2.</span></span><br><span class="line">    <span class="comment">// 2. load config/config.js, everything in config.js will cover the same key in index.js</span></span><br><span class="line">    customConfig = path.join(dataDir, <span class="string">'config.json'</span>);</span><br><span class="line">    <span class="keyword">if</span> (!fs.existsSync(customConfig)) &#123;</span><br><span class="line">      customConfig = path.join(root, <span class="string">'config'</span>, <span class="string">'config.js'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (fs.existsSync(customConfig)) &#123;</span><br><span class="line">    copy(<span class="built_in">require</span>(customConfig)).override(config);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mkdirp.sync(config.logdir);</span><br><span class="line">mkdirp.sync(config.uploadDir);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = config;</span><br><span class="line"></span><br><span class="line">config.loadConfig = <span class="function"><span class="keyword">function</span> (<span class="params">customConfig</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!customConfig) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  copy(customConfig).override(config);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><p>搞好配置之后就可以直接启动服务了。<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">node</span> <span class="title">dispatch</span>.js</span><br></pre></td></tr></table></figure></p>
<h3 id="官方脚本启动"><a href="#官方脚本启动" class="headerlink" title="官方脚本启动"></a>官方脚本启动</h3><p>官方的其它一些指令，比如你可以用 NPM 的 script 来运行。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm run start</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>在 CNPM 里面，npm script 还有下面几种指令</p>
</blockquote>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">run</span><span class="bash"> dev：调试模式启动；</span></span><br><span class="line"><span class="bash">npm run <span class="built_in">test</span>：跑测试；</span></span><br><span class="line"><span class="bash">npm run start：启动 CNPM；</span></span><br><span class="line"><span class="bash">npm run status：查看 CNPM 启动状态；</span></span><br><span class="line"><span class="bash">npm run stop：停止 CNPM。</span></span><br></pre></td></tr></table></figure>
<h2 id="访问cnpm"><a href="#访问cnpm" class="headerlink" title="访问cnpm"></a>访问cnpm</h2><p><a href="http://192.168.1.12:7002/" target="_blank" rel="noopener">http://192.168.1.12:7002/</a><br><img src="3.png" alt="enter description here"></p>
<h1 id="问题总结"><a href="#问题总结" class="headerlink" title="问题总结"></a>问题总结</h1><h2 id="问题1：安装cnmp依赖问题"><a href="#问题1：安装cnmp依赖问题" class="headerlink" title="问题1：安装cnmp依赖问题"></a>问题1：安装cnmp依赖问题</h2><p>npm 默认使用官方源（国外），速度慢,已报错；可以安装cnpm，使用cnpm install安装（淘宝源）</p>
<p>Default</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//安装cnpm</span></span><br><span class="line"> <span class="symbol">$</span> npm install -g cnpm --registry=https:<span class="comment">//registry.npm.taobao.org</span></span><br><span class="line"><span class="comment">//使用cnpm执行安装依赖命令</span></span><br><span class="line"> <span class="symbol">$</span> cnpm install</span><br></pre></td></tr></table></figure>
<h2 id="问题2：设置同步后报错"><a href="#问题2：设置同步后报错" class="headerlink" title="问题2：设置同步后报错"></a>问题2：设置同步后报错</h2><p>设置同步后，syncModel设置为exist或all,通过仓库下载模块报如下错误</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[c#</span><span class="bash">0] [error] [connect] sync error: TypeError: Cannot <span class="built_in">read</span> property ‘findAll’ of null</span></span><br></pre></td></tr></table></figure>
<p><strong>解决办法：</strong></p>
<p>在index.js文件内设置enableAbbreviatedMetadata: true，问题解决。</p>
<p>参考：<a href="https://github.com/cnpm/cnpmjs.org/issues/1236" target="_blank" rel="noopener">https://github.com/cnpm/cnpmjs.org/issues/1236</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kxinter.github.io/kxinter.gitub.io/kxinter.gitub.io/2018/08/16/centos同步yum源到本地/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/kxinter.gitub.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OperationMAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/kxinter.gitub.io/2018/08/16/centos同步yum源到本地/" itemprop="url">centos同步yum源到本地</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-16T18:12:05+08:00">
                2018-08-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/kxinter.gitub.io/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>os:centos 7.3 1611</p>
<p>应用：yum-utils</p>
<p>互联网源：阿里云</p>
<h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><p>删除/etc/yum.repos.d下所有源文件</p>
<p>1、下载源repo到本地</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget -O /etc/yum.repos.d/aliyun.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br></pre></td></tr></table></figure>
<p>2、安装yum-utils提供reporsync服务</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install yum-utils -<span class="built_in">y</span></span><br></pre></td></tr></table></figure>
<p>3、查看yum源仓库标识</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost yum.repos.d]<span class="comment"># yum repolist</span></span><br><span class="line">已加载插件：fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: mirrors.aliyun.com</span><br><span class="line"> * extras: mirrors.aliyun.com</span><br><span class="line"> * updates: mirrors.aliyun.com</span><br><span class="line">源标识 源名称 状态</span><br><span class="line">base/7/x86_64 CentOS-7 - Base - mirrors.aliyun.com 9,591</span><br><span class="line">extras/7/x86_64 CentOS-7 - Extras - mirrors.aliyun.com 196</span><br><span class="line">updates/7/x86_64 CentOS-7 - Updates - mirrors.aliyun.com 657</span><br><span class="line">repolist: 10,444</span><br></pre></td></tr></table></figure>
<p>4、根据源标识同步源到本地目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># reposync -r base -p /var/www/html/     #这里同步base目录到本地</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意： 部分互联网yum源不支持同步</p>
</blockquote>
<p>参考资料<br><a href="http://www.cnblogs.com/chengd/articles/6912938.html" target="_blank" rel="noopener">http://www.cnblogs.com/chengd/articles/6912938.html</a></p>
<p><a href="https://www.2cto.com/net/201512/455901.html" target="_blank" rel="noopener">https://www.2cto.com/net/201512/455901.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kxinter.github.io/kxinter.gitub.io/kxinter.gitub.io/2018/08/16/Centos7安装独立显卡驱动/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/kxinter.gitub.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OperationMAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/kxinter.gitub.io/2018/08/16/Centos7安装独立显卡驱动/" itemprop="url">Centos7安装独立显卡驱动</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-16T17:54:11+08:00">
                2018-08-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/kxinter.gitub.io/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Centos7-安装独立显卡驱动"><a href="#Centos7-安装独立显卡驱动" class="headerlink" title="Centos7 安装独立显卡驱动"></a>Centos7 安装独立显卡驱动</h1><h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><p><a href="https://blog.csdn.net/u013378306/article/details/69229919" target="_blank" rel="noopener">https://blog.csdn.net/u013378306/article/details/69229919</a></p>
<h2 id="安装基础依赖环境"><a href="#安装基础依赖环境" class="headerlink" title="安装基础依赖环境"></a>安装基础依赖环境</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ Yum install gcc kernel-delve -y</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意事项，保证内核版本和源码版本一样，否则，安装报错误6：</p>
</blockquote>
<p> 查看内核版本：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ls /boot | grep vmlinu</span><br></pre></td></tr></table></figure></p>
<p>查看源码包版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -aq | grep kernel-devel</span><br></pre></td></tr></table></figure>
<p>从上面的输出中可以看出内核版本号和内核源码版本。为了解决这个错误，需要从FC官方网站上下载与内核版本对应的源码包进行安装。<br>可以在以下网站下载并安装：<br><a href="http://rpmfind.net/linux/rpm2html/search.php?query=kernel-devel" target="_blank" rel="noopener">http://rpmfind.net/linux/rpm2html/search.php?query=kernel-devel</a></p>
<h2 id="源码安装"><a href="#源码安装" class="headerlink" title="源码安装"></a>源码安装</h2><h3 id="1-在英伟达官网下载相应驱动"><a href="#1-在英伟达官网下载相应驱动" class="headerlink" title="1 在英伟达官网下载相应驱动"></a>1 在英伟达官网下载相应驱动</h3><p>搜索出相应的驱动后，不要直接点，而是右健，Save Link as…</p>
<p>否则，会出现下载半天没动静的情况。</p>
<p>存放的路径上最好不要有中文。</p>
<p>我存放的路径是 ~/Downloads/NVIDIA-Linux-x86_64-346.47.run</p>
<h3 id="2-屏蔽默认带有的nouveau"><a href="#2-屏蔽默认带有的nouveau" class="headerlink" title="2 屏蔽默认带有的nouveau"></a>2 屏蔽默认带有的nouveau</h3><p>使用su命令切换到root用户下: su root</p>
<p>打开/lib/modprobe.d/dist-blacklist.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 将nvidiafb注释掉。</span><br><span class="line"># blacklist nvidiafb </span><br><span class="line">然后添加以下语句：</span><br><span class="line">blacklist nouveau</span><br><span class="line">options nouveau modeset=0</span><br></pre></td></tr></table></figure>
<h3 id="3-重建initramfs-image步骤"><a href="#3-重建initramfs-image步骤" class="headerlink" title="3 重建initramfs image步骤"></a>3 重建initramfs image步骤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ mv /boot/initramfs-$(uname -r).img /boot/initramfs-$(uname -r).img.bak</span><br><span class="line">$ dracut /boot/initramfs-$(uname -r).img $(uname -r)</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"><span class="comment">### 4 修改运行级别为文本模式</span></span><br><span class="line"></span><br><span class="line">``` bash</span><br><span class="line">$ systemctl <span class="built_in">set</span>-default multi-user.target</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"><span class="comment">### 5 重新启动, 使用root用户登陆</span></span><br><span class="line"></span><br><span class="line">``` bash</span><br><span class="line">$ reboot</span><br></pre></td></tr></table></figure>
<h3 id="6-查看nouveau是否已经禁用"><a href="#6-查看nouveau是否已经禁用" class="headerlink" title="6 查看nouveau是否已经禁用"></a>6 查看nouveau是否已经禁用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls mod | grep nouveau</span><br></pre></td></tr></table></figure>
<p>如果没有显示相关的内容，说明已禁用。</p>
<h3 id="7-进入下载的驱动所在目录"><a href="#7-进入下载的驱动所在目录" class="headerlink" title="7 进入下载的驱动所在目录"></a>7 进入下载的驱动所在目录</h3><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="string">chmod </span>+x <span class="string">NVIDIA-Linux-</span><span class="string">x86_64-346.</span><span class="string">47.</span><span class="string">run</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$</span> ./<span class="string">NVIDIA-Linux-</span><span class="string">x86_64-346.</span><span class="string">47.</span><span class="string">run</span></span><br></pre></td></tr></table></figure>
<p>安装过程中，选择accept</p>
<p>如果提示要修改xorg.conf，选择yes</p>
<h3 id="8-修改运行级别回图形模式"><a href="#8-修改运行级别回图形模式" class="headerlink" title="8 修改运行级别回图形模式"></a>8 修改运行级别回图形模式</h3><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">systemctl </span><span class="built_in">set-default</span> <span class="string">graphical.</span><span class="string">target</span></span><br></pre></td></tr></table></figure>
<h3 id="9-重新启动，OK"><a href="#9-重新启动，OK" class="headerlink" title="9 重新启动，OK"></a>9 重新启动，OK</h3><p>在Applications–Other可以看见NVIDIA X Server Settings菜单。 </p>
<h1 id="问题："><a href="#问题：" class="headerlink" title="问题："></a>问题：</h1><p><strong>错误1：</strong></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR: The Nouveau kernel driver <span class="keyword">is</span> currently <span class="keyword">in</span> use <span class="keyword">by</span> your system.  This driver <span class="keyword">is</span> incompatible <span class="keyword">with</span> <span class="keyword">the</span> NVIDIA driver, <span class="keyword">and</span> must be disabled <span class="keyword">before</span> proceeding.  Please consult <span class="keyword">the</span> NVIDIA driver README <span class="keyword">and</span> your Linux distribution's documentation <span class="keyword">for</span> details <span class="keyword">on</span> how         <span class="keyword">to</span> correctly disable <span class="keyword">the</span> Nouveau kernel driver.</span><br></pre></td></tr></table></figure>
<p>解释：如果没有执行屏蔽nouveau操作，报以上错误。</p>
<p><strong>错误2：</strong></p>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unable <span class="keyword">to</span> find the development too <span class="symbol">'cc</span>' <span class="keyword">in</span> you path; please make sure that you have the <span class="keyword">package</span> <span class="symbol">'gcc</span></span><br></pre></td></tr></table></figure>
<p>解决办法：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install gcc</span><br></pre></td></tr></table></figure>
<p><strong>错误3：</strong></p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ERROR</span>: Unable <span class="keyword">to</span> find the kernel source tree <span class="keyword">for</span> the currently running kernel.  Please make sure you have installed the kernel source files <span class="keyword">for</span> your</span><br><span class="line"></span><br><span class="line"> kernel <span class="keyword">and</span> that they are properly configured; <span class="keyword">on</span> Red Hat Linux systems, <span class="keyword">for</span> example, be sure you have the  <span class="comment">'kernel-source' or 'kernel-devel' RPM installed.  If you know the correct kernel source files are installed, you may specify the kernel source path with the '--kernel-source-path' command line option.</span></span><br></pre></td></tr></table></figure>
<p>解决办法：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install kernel-delve</span><br></pre></td></tr></table></figure></p>
<p><strong>错误5：</strong></p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ERROR</span>: Unable <span class="keyword">to</span> find the kernel source tree <span class="keyword">for</span> the currently running kernel.  Please make sure you have installed the kernel source files <span class="keyword">for</span> your kernel <span class="keyword">and</span> that they are properly configured; <span class="keyword">on</span> Red Hat Linux systems, <span class="keyword">for</span> example, be sure you have the         <span class="comment">'kernel-source' or 'kernel-devel' RPM installed.  If you know the correct kernel source files are installed, you may specify the kernel source path with the '--kernel-source-path' command line option.</span></span><br></pre></td></tr></table></figure>
<p> 解决方法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./NVIDIA-Linux-x86_64-390.67.run --kernel-source-path=/usr/src/kernels/3.10.0-862.3.2.el7.x86_64/</span><br></pre></td></tr></table></figure>
<p><strong>错误6：</strong></p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR: Unable <span class="built_in">to</span> <span class="built_in">load</span> <span class="keyword">the</span> kernel module <span class="string">'nvidia.ko'</span>.  This happens most frequently when this kernel module was built against <span class="keyword">the</span> wrong <span class="keyword">or</span> improperly configured kernel sources, <span class="keyword">with</span> <span class="keyword">a</span> <span class="built_in">version</span> <span class="keyword">of</span> gcc that differs <span class="built_in">from</span> <span class="keyword">the</span> <span class="literal">one</span> used <span class="built_in">to</span> build <span class="keyword">the</span> target kernel, <span class="keyword">or</span> <span class="keyword">if</span> another driver, such <span class="keyword">as</span> nouveau, is present <span class="keyword">and</span> prevents <span class="keyword">the</span> NVIDIA kernel module <span class="built_in">from</span> obtaining ownership <span class="keyword">of</span> <span class="keyword">the</span> NVIDIA GPU(s), <span class="keyword">or</span> no NVIDIA GPU installed <span class="keyword">in</span> this <span class="keyword">system</span> is supported <span class="keyword">by</span> this NVIDIA Linux graphics driver release.</span><br></pre></td></tr></table></figure>
<pre><code>Please see the log entries &apos;Kernel module load error&apos; and &apos;Kernel messages&apos; at the end of the file &apos;/var/log/nvidia-installer.log&apos; for more information.
</code></pre><p>解决办法：</p>
<p>可以通过以下方式查看内核版本和源码包版本：<br>ls /boot | grep vmlinuz<br>如果上面的命令输出中有多个内核，则按grub.conf中指定的文件为准。<br>rpm -aq | grep kernel-devel<br>kernel-devel-2.6.35.13-92.fc14.i686<br>从上面的输出中可以看出内核版本号和内核源码版本。为了解决这个错误，需要从FC官方网站上下载与内核版本对应的源码包进行安装。<br>         可以在以下网站下载并安装：<br>        <a href="http://rpmfind.net/linux/rpm2html/search.php?query=kernel-devel" target="_blank" rel="noopener">http://rpmfind.net/linux/rpm2html/search.php?query=kernel-devel</a></p>
<blockquote>
<p>备注：执行更新内核操作好需要重新执行屏蔽nouveau，及重建initramfs image步骤。</p>
</blockquote>
<p><strong>警告：</strong></p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">**</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">WARNING: nvidia-installer was forced <span class="built_in">to</span> guess <span class="keyword">the</span> X library path <span class="string">'/usr/lib64'</span> <span class="keyword">and</span> X module path <span class="string">'/usr/lib64/xorg/modules'</span>; these paths were <span class="keyword">not</span> queryable <span class="built_in">from</span> <span class="keyword">the</span> <span class="keyword">system</span>.  If X fails <span class="built_in">to</span> find <span class="keyword">the</span> NVIDIA X driver module, please install <span class="keyword">the</span> `pkg-config` utility <span class="keyword">and</span> <span class="keyword">the</span></span><br><span class="line"></span><br><span class="line">           X.Org SDK/development package <span class="keyword">for</span> your distribution <span class="keyword">and</span> reinstall <span class="keyword">the</span> driver.</span><br></pre></td></tr></table></figure>
<p>字符模式安装警告信息，可忽略。</p>
<h1 id="安装cuda"><a href="#安装cuda" class="headerlink" title="安装cuda"></a>安装cuda</h1><p>参考：<a href="https://blog.csdn.net/claroja/article/details/81034147" target="_blank" rel="noopener">https://blog.csdn.net/claroja/article/details/81034147</a></p>
<p><strong>错误：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Installing the CUDA Toolkit <span class="keyword">in</span> /usr/<span class="built_in">local</span>/cuda-6.5 ...</span><br><span class="line">Missing recommended library: libGLU.so</span><br><span class="line">Missing recommended library: libXmu.so</span><br></pre></td></tr></table></figure>
<p>解决：安装第三方软件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ yum install freeglut-devel libX11-devel libXi-devel libXmu-devel  \</span><br><span class="line"></span><br><span class="line">$ make mesa-libGLU-devel</span><br></pre></td></tr></table></figure>
<h2 id="测试CUDA"><a href="#测试CUDA" class="headerlink" title="测试CUDA"></a>测试CUDA</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@fengyun6 ~]<span class="comment"># find / -name deviceQuery</span></span><br><span class="line"></span><br><span class="line"><span class="regexp">/root/</span>NVIDIA_CUDA-<span class="number">9.0</span>_Samples<span class="regexp">/1_Utilities/</span>deviceQuery</span><br><span class="line"></span><br><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/cuda-9.0/</span>extras<span class="regexp">/demo_suite/</span>deviceQuery</span><br><span class="line"></span><br><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/cuda-9.0/</span>samples<span class="regexp">/1_Utilities/</span>deviceQuery</span><br></pre></td></tr></table></figure>
<blockquote>
<p>若出现以下信息，则表示安装成功</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@fengyun6</span> <span class="string">~]#</span> <span class="string">/usr/local/cuda-9.0/extras/demo_suite/deviceQuery</span></span><br><span class="line"></span><br><span class="line"><span class="string">/usr/local/cuda-9.0/extras/demo_suite/deviceQuery</span> <span class="string">Starting...</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> <span class="string">CUDA</span> <span class="string">Device</span> <span class="string">Query</span> <span class="string">(Runtime</span> <span class="string">API)</span> <span class="string">version</span> <span class="string">(CUDART</span> <span class="string">static</span> <span class="string">linking)</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="string">Detected</span> <span class="number">1</span> <span class="string">CUDA</span> <span class="string">Capable</span> <span class="string">device(s)</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="string">Device</span> <span class="number">0</span><span class="string">:</span> <span class="string">"GeForce GTX 1080 Ti"</span></span><br><span class="line"></span><br><span class="line">  <span class="string">CUDA</span> <span class="string">Driver</span> <span class="string">Version</span> <span class="string">/</span> <span class="string">Runtime</span> <span class="string">Version</span>          <span class="number">9.1</span> <span class="string">/</span> <span class="number">9.0</span></span><br><span class="line"></span><br><span class="line">  <span class="string">CUDA</span> <span class="string">Capability</span> <span class="string">Major/Minor</span> <span class="string">version</span> <span class="attr">number:</span>    <span class="number">6.1</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Total</span> <span class="string">amount</span> <span class="string">of</span> <span class="string">global</span> <span class="attr">memory:</span>                 <span class="number">11178</span> <span class="string">MBytes</span> <span class="string">(11721113600</span> <span class="string">bytes)</span></span><br><span class="line"></span><br><span class="line">  <span class="string">(28)</span> <span class="string">Multiprocessors,</span> <span class="string">(128)</span> <span class="string">CUDA</span> <span class="string">Cores/MP:</span>     <span class="number">3584</span> <span class="string">CUDA</span> <span class="string">Cores</span></span><br><span class="line"></span><br><span class="line">  <span class="string">GPU</span> <span class="string">Max</span> <span class="string">Clock</span> <span class="attr">rate:</span>                            <span class="number">1645</span> <span class="string">MHz</span> <span class="string">(1.64</span> <span class="string">GHz)</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Memory</span> <span class="string">Clock</span> <span class="attr">rate:</span>                             <span class="number">5505</span> <span class="string">Mhz</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Memory</span> <span class="string">Bus</span> <span class="attr">Width:</span>                              <span class="number">352</span><span class="bullet">-bit</span></span><br><span class="line"></span><br><span class="line">  <span class="string">L2</span> <span class="string">Cache</span> <span class="attr">Size:</span>                                 <span class="number">2883584</span> <span class="string">bytes</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Maximum</span> <span class="string">Texture</span> <span class="string">Dimension</span> <span class="string">Size</span> <span class="string">(x,y,z)</span>         <span class="number">1</span><span class="string">D=(131072),</span> <span class="number">2</span><span class="string">D=(131072,</span> <span class="number">65536</span><span class="string">),</span> <span class="number">3</span><span class="string">D=(16384,</span> <span class="number">16384</span><span class="string">,</span> <span class="number">16384</span><span class="string">)</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Maximum</span> <span class="string">Layered</span> <span class="number">1</span><span class="string">D</span> <span class="string">Texture</span> <span class="string">Size,</span> <span class="string">(num)</span> <span class="string">layers</span>  <span class="number">1</span><span class="string">D=(32768),</span> <span class="number">2048</span> <span class="string">layers</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Maximum</span> <span class="string">Layered</span> <span class="number">2</span><span class="string">D</span> <span class="string">Texture</span> <span class="string">Size,</span> <span class="string">(num)</span> <span class="string">layers</span>  <span class="number">2</span><span class="string">D=(32768,</span> <span class="number">32768</span><span class="string">),</span> <span class="number">2048</span> <span class="string">layers</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Total</span> <span class="string">amount</span> <span class="string">of</span> <span class="string">constant</span> <span class="attr">memory:</span>               <span class="number">65536</span> <span class="string">bytes</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Total</span> <span class="string">amount</span> <span class="string">of</span> <span class="string">shared</span> <span class="string">memory</span> <span class="string">per</span> <span class="attr">block:</span>       <span class="number">49152</span> <span class="string">bytes</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Total</span> <span class="string">number</span> <span class="string">of</span> <span class="string">registers</span> <span class="string">available</span> <span class="string">per</span> <span class="attr">block:</span> <span class="number">65536</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Warp</span> <span class="attr">size:</span>                                     <span class="number">32</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Maximum</span> <span class="string">number</span> <span class="string">of</span> <span class="string">threads</span> <span class="string">per</span> <span class="attr">multiprocessor:</span>  <span class="number">2048</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Maximum</span> <span class="string">number</span> <span class="string">of</span> <span class="string">threads</span> <span class="string">per</span> <span class="attr">block:</span>           <span class="number">1024</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Max</span> <span class="string">dimension</span> <span class="string">size</span> <span class="string">of</span> <span class="string">a</span> <span class="string">thread</span> <span class="string">block</span> <span class="string">(x,y,z):</span> <span class="string">(1024,</span> <span class="number">1024</span><span class="string">,</span> <span class="number">64</span><span class="string">)</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Max</span> <span class="string">dimension</span> <span class="string">size</span> <span class="string">of</span> <span class="string">a</span> <span class="string">grid</span> <span class="string">size</span>    <span class="string">(x,y,z):</span> <span class="string">(2147483647,</span> <span class="number">65535</span><span class="string">,</span> <span class="number">65535</span><span class="string">)</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Maximum</span> <span class="string">memory</span> <span class="attr">pitch:</span>                          <span class="number">2147483647</span> <span class="string">bytes</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Texture</span> <span class="attr">alignment:</span>                             <span class="number">512</span> <span class="string">bytes</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Concurrent</span> <span class="string">copy</span> <span class="string">and</span> <span class="string">kernel</span> <span class="attr">execution:</span>          <span class="literal">Yes</span> <span class="string">with</span> <span class="number">2</span> <span class="string">copy</span> <span class="string">engine(s)</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Run</span> <span class="string">time</span> <span class="string">limit</span> <span class="string">on</span> <span class="attr">kernels:</span>                     <span class="literal">No</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Integrated</span> <span class="string">GPU</span> <span class="string">sharing</span> <span class="string">Host</span> <span class="attr">Memory:</span>            <span class="literal">No</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Support</span> <span class="string">host</span> <span class="string">page-locked</span> <span class="string">memory</span> <span class="attr">mapping:</span>       <span class="literal">Yes</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Alignment</span> <span class="string">requirement</span> <span class="string">for</span> <span class="attr">Surfaces:</span>            <span class="literal">Yes</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Device</span> <span class="string">has</span> <span class="string">ECC</span> <span class="attr">support:</span>                        <span class="string">Disabled</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Device</span> <span class="string">supports</span> <span class="string">Unified</span> <span class="string">Addressing</span> <span class="string">(UVA):</span>      <span class="literal">Yes</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Device</span> <span class="string">PCI</span> <span class="string">Domain</span> <span class="string">ID</span> <span class="string">/</span> <span class="string">Bus</span> <span class="string">ID</span> <span class="string">/</span> <span class="string">location</span> <span class="attr">ID:</span>   <span class="number">0</span> <span class="string">/</span> <span class="number">1</span> <span class="string">/</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="string">Compute</span> <span class="attr">Mode:</span></span><br><span class="line"></span><br><span class="line">     <span class="string">&lt;</span> <span class="string">Default</span> <span class="string">(multiple</span> <span class="string">host</span> <span class="string">threads</span> <span class="string">can</span> <span class="string">use</span> <span class="string">::cudaSetDevice()</span> <span class="string">with</span> <span class="string">device</span> <span class="string">simultaneously)</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">deviceQuery, CUDA Driver = CUDART, CUDA Driver Version = 9.1, CUDA Runtime Version = 9.0, NumDevs = 1, Device0 = GeForce GT</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">X 1080 TiResult = PASS</span></span><br></pre></td></tr></table></figure>
<p>安装cudnn<br>参考：<a href="https://www.cnblogs.com/mar-q/p/7482720.html" target="_blank" rel="noopener">https://www.cnblogs.com/mar-q/p/7482720.html</a></p>
<p>下载：<a href="https://developer.nvidia.com/rdp/cudnn-archive" target="_blank" rel="noopener">https://developer.nvidia.com/rdp/cudnn-archive</a></p>
<h1 id="安装cudnn"><a href="#安装cudnn" class="headerlink" title="安装cudnn"></a>安装cudnn</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tar -xvf cudnn-8.0-linux-x64-v6.0.tgz -C /usr/<span class="built_in">local</span>/</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kxinter.github.io/kxinter.gitub.io/kxinter.gitub.io/2018/08/16/jenkins各种触发方式介绍/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/kxinter.gitub.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OperationMAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/kxinter.gitub.io/2018/08/16/jenkins各种触发方式介绍/" itemprop="url">jenkins各种触发方式介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-16T17:49:34+08:00">
                2018-08-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/kxinter.gitub.io/categories/自动化运维/" itemprop="url" rel="index">
                    <span itemprop="name">自动化运维</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>触发远程构建</strong><br>使用svn存储库hooks的post-commit,调用jenkins的api触发job。（存储库更新即触发构建，不能针对某个分支目录更新触发）</p>
<p><strong>Build after other projects are built</strong><br>某个projects触发构建后执行构建</p>
<p><strong>Build periodically</strong><br>Build periodically：周期进行项目构建（它不care源码是否发生变化），我的配置如下：</p>
<p>0 2 <em> </em> *  （每天2:00 必须build一次源码）</p>
<p><strong>Poll SCM</strong><br>Poll SCM：定时检查源码变更（根据SCM软件的版本号），如果有更新就checkout最新code下来，然后执行构建动作。我的配置如下：</p>
<p><em>/5 </em> <em> </em> *  （每5分钟检查一次源码变化）可针对某个分支目录更新触发构建</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kxinter.github.io/kxinter.gitub.io/kxinter.gitub.io/2018/08/16/Nginx反向代理报504超时错误/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/kxinter.gitub.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OperationMAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/kxinter.gitub.io/2018/08/16/Nginx反向代理报504超时错误/" itemprop="url">Nginx反向代理报504超时错误</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-16T17:42:47+08:00">
                2018-08-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/kxinter.gitub.io/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="nginx-tomcat"><a href="#nginx-tomcat" class="headerlink" title="nginx+tomcat"></a>nginx+tomcat</h1><p>后端为tomcat,nginx代理报504超时错误。</p>
<p><strong>问题描述：</strong></p>
<p>#错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.198.17.123 - - [06/Jul/2018:01:48:57 +0000] &quot;POST /mapbj3/getticket HTTP/1.1&quot; 504 537 &quot;https://XXXXXXXXXX.com/walkcode3/index.html?openId=oB6UW0cF3Z_dnYXnz4tG4OFt7Rt0&quot; &quot;Mozilla/5.0 (Linux; Android 8.1; PACM00 Build/O11019; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/53.0.2785.143 Crosswalk/24.53.595.0 XWEB/155 MMWEBSDK/19 Mobile Safari/537.36 MicroMessenger/6.6.6.1300(0x26060638) NetType/WIFI Language/zh_CN MicroMessenger/6.6.6.1300(0x26060638) NetType/WIFI Language/zh_CN miniProgram&quot; &quot;-&quot;</span><br><span class="line">2018/07/06 01:48:57 [error] 6#6: *2573 upstream timed out (110: Connection timed out) while connecting to upstream, client: 1.198.17.123, server: , request: &quot;POST /mapbj3/getticket HTTP/1.1&quot;, upstream: &quot;http://123.149.236.180:8022/mapbj3//getticket&quot;, host: &quot;XXXXXXXX.com&quot;, referrer: &quot;https://XXXXXXX.com/walkcode3/index.html?openId=oB6UW0cF3Z_dnYXnz4tG4OFt7Rt0&quot;</span><br></pre></td></tr></table></figure>
<p>1、项目本地访问没问题，通过nginx访问报504错误；</p>
<p>2、重启nginx后正常，反复发生，其它项目代理没有问题；</p>
<p>3、搜索了一大推”NGINX 504 Gateway Time-out tomcat”,都是与php有关的,而默认优化的就是php配置的;</p>
<p><strong>问题处理：</strong><br>修改/etc/nginx/nginx.conf,添加如下信息</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /etc/nginx/nginx.conf</span></span><br><span class="line"><span class="string">user </span> <span class="string">nginx;</span></span><br><span class="line"><span class="string">worker_processes </span> 1;</span><br><span class="line"></span><br><span class="line"><span class="string">error_log </span> /<span class="string">var/</span><span class="string">log/</span><span class="string">nginx/</span><span class="string">error.</span><span class="string">log </span><span class="string">warn;</span></span><br><span class="line"><span class="string">pid </span>       /<span class="string">var/</span><span class="string">run/</span><span class="string">nginx.</span><span class="string">pid;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">events </span>&#123;</span><br><span class="line">    <span class="string">worker_connections </span> <span class="string">1024;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">http </span>&#123;</span><br><span class="line">    <span class="string">include </span>      /<span class="string">etc/</span><span class="string">nginx/</span><span class="string">mime.</span><span class="string">types;</span></span><br><span class="line">    <span class="string">default_type </span> <span class="string">application/</span><span class="string">octet-stream;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">log_format </span> <span class="string">main </span> <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="string">access_log </span> /<span class="string">var/</span><span class="string">log/</span><span class="string">nginx/</span><span class="string">access.</span><span class="string">log </span> <span class="string">main;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">sendfile </span>       <span class="string">on;</span></span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">keepalive_timeout </span> <span class="string">65;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">include </span>/<span class="string">etc/</span><span class="string">nginx/</span><span class="string">conf.</span>d/*.<span class="string">conf;</span></span><br><span class="line">    <span class="comment">#用于tomcat反向代理,解决nginx 504错误 </span></span><br><span class="line">    <span class="string">proxy_connect_timeout </span>  <span class="string">300;</span> </span><br><span class="line">    <span class="string">proxy_send_timeout </span>     <span class="string">300;</span> </span><br><span class="line">    <span class="string">proxy_read_timeout </span>     <span class="string">300;</span> </span><br><span class="line">    <span class="string">proxy_buffer_size </span>      <span class="string">16k;</span> </span><br><span class="line">    <span class="string">proxy_buffers </span>          4 <span class="string">64k;</span> </span><br><span class="line">    <span class="string">proxy_busy_buffers_size </span><span class="string">128k;</span> </span><br><span class="line">    <span class="string">proxy_temp_file_write_size </span><span class="string">128k;</span></span><br><span class="line">    <span class="comment"># ps:以timeout结尾配置项时间要配置大点</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="nginx-php-未验证"><a href="#nginx-php-未验证" class="headerlink" title="nginx+php(未验证)"></a>nginx+php(未验证)</h1><p>问题如上，问题处理添加如下内容</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">user </span> <span class="string">nginx;</span></span><br><span class="line"><span class="string">worker_processes </span> 1;</span><br><span class="line"></span><br><span class="line"><span class="string">error_log </span> /<span class="string">var/</span><span class="string">log/</span><span class="string">nginx/</span><span class="string">error.</span><span class="string">log </span><span class="string">warn;</span></span><br><span class="line"><span class="string">pid </span>       /<span class="string">var/</span><span class="string">run/</span><span class="string">nginx.</span><span class="string">pid;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">events </span>&#123;</span><br><span class="line">    <span class="string">worker_connections </span> <span class="string">1024;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">http </span>&#123;</span><br><span class="line">    <span class="string">include </span>      /<span class="string">etc/</span><span class="string">nginx/</span><span class="string">mime.</span><span class="string">types;</span></span><br><span class="line">    <span class="string">default_type </span> <span class="string">application/</span><span class="string">octet-stream;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">log_format </span> <span class="string">main </span> <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="string">access_log </span> /<span class="string">var/</span><span class="string">log/</span><span class="string">nginx/</span><span class="string">access.</span><span class="string">log </span> <span class="string">main;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">sendfile </span>       <span class="string">on;</span></span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">keepalive_timeout </span> <span class="string">65;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">include </span>/<span class="string">etc/</span><span class="string">nginx/</span><span class="string">conf.</span>d/*.<span class="string">conf;</span></span><br><span class="line">    <span class="comment">#用于php反向代理,解决nginx 504错误 </span></span><br><span class="line">    <span class="comment">#以fastcgi_*配置项是php用的    </span></span><br><span class="line">    <span class="string">fastcgi_connect_timeout </span><span class="string">1000;</span></span><br><span class="line">    <span class="string">fastcgi_send_timeout </span><span class="string">1000;</span></span><br><span class="line">    <span class="string">fastcgi_read_timeout </span><span class="string">1000;</span></span><br><span class="line">    <span class="string">fastcgi_buffer_size </span><span class="string">64k;</span></span><br><span class="line">    <span class="string">fastcgi_buffers </span>8 <span class="string">128k;</span></span><br><span class="line">    <span class="string">fastcgi_busy_buffers_size </span><span class="string">128k;</span></span><br><span class="line">    <span class="string">fastcgi_temp_file_write_size </span><span class="string">128k;</span></span><br><span class="line">    <span class="string">fastcgi_intercept_errors </span><span class="string">on;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="https://blog.csdn.net/lcj_star/article/details/76672748https://www.iyunv.com/thread-319236-1-1.html" target="_blank" rel="noopener">https://blog.csdn.net/lcj_star/article/details/76672748https://www.iyunv.com/thread-319236-1-1.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kxinter.github.io/kxinter.gitub.io/kxinter.gitub.io/2018/08/16/yapi部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/kxinter.gitub.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OperationMAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/kxinter.gitub.io/2018/08/16/yapi部署/" itemprop="url">yapi部署</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-16T17:15:57+08:00">
                2018-08-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/kxinter.gitub.io/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一、在线安装"><a href="#一、在线安装" class="headerlink" title="一、在线安装"></a>一、在线安装</h1><h2 id="1、安装nodejs"><a href="#1、安装nodejs" class="headerlink" title="1、安装nodejs"></a>1、安装nodejs</h2><p>下载压缩包，设置环境变量，这里不祥述。</p>
<h2 id="2、安装mongodb"><a href="#2、安装mongodb" class="headerlink" title="2、安装mongodb"></a>2、安装mongodb</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加yum源</span></span><br><span class="line">$ vim /etc/yum.repos.d/mongodb-3.4.repo</span><br><span class="line"> </span><br><span class="line"><span class="comment">#添加下面的内容，wq保存。 </span></span><br><span class="line"></span><br><span class="line">[mongodb-org-3.4]</span><br><span class="line">name=MongoDB Repository</span><br><span class="line">baseurl=https://repo.mongodb.org/yum/RedHat/<span class="variable">$releasever</span>/mongodb-org/3.4/x86_64/</span><br><span class="line">gpgcheck= 0</span><br><span class="line">enabled=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装mongodb</span></span><br><span class="line">yum install -y mongodb-org</span><br><span class="line"><span class="comment"># 配置mongod</span></span><br><span class="line"><span class="comment">#启动:</span></span><br><span class="line">$ service mongod start</span><br><span class="line">[root@CENTSVR247 vendors]<span class="comment"># mongo</span></span><br><span class="line">&amp;gt; use admin   <span class="comment">#切换到admin数据库</span></span><br><span class="line">switched to db admin</span><br><span class="line"><span class="comment">#创建dba用户</span></span><br><span class="line">&amp;gt; db.createUser(</span><br><span class="line">... ...   &#123;</span><br><span class="line">... ...     user: <span class="string">"dba"</span>,</span><br><span class="line">... ...     <span class="built_in">pwd</span>: <span class="string">"dba"</span>,</span><br><span class="line">... ...     roles: [ &#123; role: <span class="string">"userAdminAnyDatabase"</span>, db: <span class="string">"admin"</span> &#125; ]</span><br><span class="line">... ...   &#125;</span><br><span class="line">... ... )</span><br><span class="line"><span class="comment"># 创建yapi数据库</span></span><br><span class="line">use yapi</span><br><span class="line">switched to db yapi</span><br><span class="line">给yapi数据库添加test1用户,权限为读写</span><br><span class="line">db.createUser(</span><br><span class="line">... ...     &#123;</span><br><span class="line">... ...       user: <span class="string">"test1"</span>,</span><br><span class="line">... ...       <span class="built_in">pwd</span>: <span class="string">"test1"</span>,</span><br><span class="line">... ...       roles: [</span><br><span class="line">... ...          &#123; role: <span class="string">"readWrite"</span>, db: <span class="string">"yapi"</span> &#125;  </span><br><span class="line">... ...       ]</span><br><span class="line">... ...     &#125;</span><br><span class="line">... ... )</span><br></pre></td></tr></table></figure>
<h2 id="3、安装Yapi"><a href="#3、安装Yapi" class="headerlink" title="3、安装Yapi"></a>3、安装Yapi</h2><p>官方说明：<a href="https://yapi.ymfe.org/devops/index.html" target="_blank" rel="noopener">https://yapi.ymfe.org/devops/index.html</a></p>
<h3 id="方式一：可视化部署"><a href="#方式一：可视化部署" class="headerlink" title="方式一：可视化部署"></a>方式一：可视化部署</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ npm install -g yapi-cli --registry https://registry.npm.taobao.org</span><br><span class="line">$ yapi server</span><br></pre></td></tr></table></figure>
<p><img src="1.png" alt="enter description here"><br>根据提示，浏览器访问 http://部署YApi服务器的IP:9090。<br><img src="2.png" alt="enter description here"></p>
<p>填写完信息后，点击“开始部署”。（大概等待1分钟）<br><img src="3.png" alt="enter description here"><br><img src="4.png" alt="enter description here"><br>退出当前状态</p>
<p>CTRL + C</p>
<p> <strong>修改配置</strong></p>
<p>这里我们不急着根据提示进行启动，有些参数我们可以通过修改配置达到。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改config.json</span></span><br><span class="line"></span><br><span class="line">$ vim /root/my-yapi/config.json</span><br><span class="line"> 修改下面的内容（邮箱可以不用163的），wq保存。</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"port"</span>: <span class="string">"80"</span>,</span><br><span class="line">  <span class="string">"adminAccount"</span>: <span class="string">"yizitadmin@yizit.cn"</span>,</span><br><span class="line">  <span class="string">"db"</span>: &#123;</span><br><span class="line">       <span class="string">"servername"</span>: <span class="string">"127.0.0.1"</span>,</span><br><span class="line">       <span class="string">"DATABASE"</span>: <span class="string">"yapi"</span>,</span><br><span class="line">       <span class="string">"port"</span>: <span class="string">"27017"</span></span><br><span class="line">   &#125;,</span><br><span class="line">  <span class="string">"mail"</span>: &#123;</span><br><span class="line">       <span class="string">"enable"</span>: <span class="literal">true</span>,</span><br><span class="line">       <span class="string">"host"</span>: <span class="string">"smtp.163.com"</span>,</span><br><span class="line">       <span class="string">"port"</span>: 465,</span><br><span class="line">       <span class="string">"from"</span>: <span class="string">"可用于发送邮件的163邮箱"</span>,</span><br><span class="line">       <span class="string">"auth"</span>: &#123;</span><br><span class="line">           <span class="string">"user"</span>: <span class="string">"163邮箱"</span>,</span><br><span class="line">           <span class="string">"pass"</span>: <span class="string">"163邮箱对应的密码或授权码"</span></span><br><span class="line">       &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>启动</strong></p>
<p> 切换到部署目录下</p>
<p>cd /root/my-yapi<br><strong><em>启动服务</em></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ node vendors/server/app.js</span><br></pre></td></tr></table></figure>
<p>由于修改了配置，所以直接访问 http://部署YApi服务器的IP/login。</p>
<p>访问http://部署YApi服务器的IP:3000/login</p>
<p>默认用户密码：<a href="mailto:admin@admin.com" target="_blank" rel="noopener">admin@admin.com</a>               ymfe.org<br><img src="5.png" alt="enter description here"></p>
<h3 id="方式二：命令行部署"><a href="#方式二：命令行部署" class="headerlink" title="方式二：命令行部署"></a>方式二：命令行部署</h3><p><strong>安装yapi</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir yapi</span><br><span class="line">$ <span class="built_in">cd</span> yapi</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/YMFE/yapi.git vendors //或者下载 zip 包解压到 vendors 目录</span><br><span class="line">$ cp vendors/config_example.json ./config.json //复制完成后请修改相关配置</span><br><span class="line">$ <span class="built_in">cd</span> vendors</span><br><span class="line">$ npm install --production --registry https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure>
<p><strong>安装pm2</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> vendors</span><br><span class="line">$ npm install -S pm2</span><br></pre></td></tr></table></figure>
<p><strong>初始化及启动yapi</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ npm run install-server //安装程序会初始化数据库索引和管理员账号，管理员账号名可在 config.json 配置</span><br><span class="line">$ node server/app.js //启动服务器后，请访问 127.0.0.1:&#123;config.json配置的端口&#125;，初次运行会有个编译的过程，请耐心等候</span><br></pre></td></tr></table></figure>
<p><strong>使用pm2启动方式</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ npx pm2 start ./server/app.js</span><br><span class="line"><span class="comment"># 停止</span></span><br><span class="line">$ npx pm2 stop all</span><br></pre></td></tr></table></figure>
<h1 id="二、离线安装"><a href="#二、离线安装" class="headerlink" title="二、离线安装"></a>二、离线安装</h1><blockquote>
<p>离线安装只能采用命令行部署方式</p>
</blockquote>
<h2 id="node安装"><a href="#node安装" class="headerlink" title="node安装"></a>node安装</h2><p>不再详述。</p>
<h2 id="内网安装mongodb"><a href="#内网安装mongodb" class="headerlink" title="内网安装mongodb"></a>内网安装mongodb</h2><p>解压mongodb-linux-x86_64-3.6.4.tgz并放入mongodb文件夹中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ tar -zxvf mongodb-linux-x86_64-3.6.4.tgz</span><br><span class="line">$ mv mongodb-linux-x86_64-3.6.4 mongodb</span><br></pre></td></tr></table></figure>
<p>把mongodb放入环境变量中, 修改~/.bashrc, 加入以下内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=&amp;lt;mongodb文件夹的路径&amp;gt;/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>
<p>验证安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br><span class="line">$ mongo --version</span><br></pre></td></tr></table></figure>
<p>创建dbdata/db文件夹和dblog文件夹(请自行确保这些文件夹的读写权限)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p dbdata/db</span><br><span class="line">$ mkdir dblog</span><br></pre></td></tr></table></figure>
<p>启动mongodb服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ./mongodb/bin/mongod --fork --dbpath ./dbdata --logpath ./dblog/<span class="built_in">log</span></span><br></pre></td></tr></table></figure>
<p>配置</p>
<p>参考上文mongodb配置。</p>
<h2 id="离线安装yapi"><a href="#离线安装yapi" class="headerlink" title="离线安装yapi"></a>离线安装yapi</h2><p>在一台连接互联网的pc上安装node环境</p>
<p>在外网机器获取yapi源码并安装依赖<br>使用git获取yapi源码, 如果没有git命令请按照对应平台的安装方法安装git.</p>
<p>创建一个新文件夹yapi, 使用clone将yapi源码放入vendors中:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir yapi</span><br><span class="line">$ <span class="built_in">cd</span> yapi</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/YMFE/yapi.git vendors</span><br><span class="line">$ cp vendors/config_example.json ./config.json</span><br><span class="line">$ <span class="built_in">cd</span> vendors</span><br><span class="line">$ npm install --production</span><br></pre></td></tr></table></figure>
<p>我这里还安装了pm2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm n install -S pm2</span><br></pre></td></tr></table></figure>
<p>将创建的yapi文件夹打成压缩包得到yapi.tar.gz(其目录下有config.json和vendors)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tar -czf yapi.tar.gz yapi</span><br></pre></td></tr></table></figure>
<p>至此, 所有需要外部网络的操作已经完成, 可以进行内网部署.</p>
<h2 id="启动yapi"><a href="#启动yapi" class="headerlink" title="启动yapi"></a>启动yapi</h2><p>解压yapi.tar.gz</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tar -zxvf yapi.tar.gz</span><br></pre></td></tr></table></figure>
<p>按需要修改yapi/config.json中的相关配置(例如管理员账号等)</p>
<p>初始化数据库:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ./yapi/vendors</span><br><span class="line">$ npm run install-server</span><br></pre></td></tr></table></figure>
<p>使用pm2启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npx n pm2 start ./server/app.js</span><br></pre></td></tr></table></figure>
<p>启动完成后即可尝试访问yapi看是否成功, 具体地址要根据内网机器的ip和在config.json中配置的端口号</p>
<p>如果要关闭yapi服务, 可以使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npx n pm2 stop all</span><br></pre></td></tr></table></figure>
<h1 id="问题总结："><a href="#问题总结：" class="headerlink" title="问题总结："></a>问题总结：</h1><p>两种方式安装yapi,按照正常方式安装都是无法安装的，有如下错误</p>
<p>方式1图形界面，yapi server 启动9090服务后，页面无法打开，会报错误，原因是无网络。<br>方式2命令行安装，npm install –production 回报git错误，因需要联网git操作，原因无网络，npm使用私库代理也不行。</p>
<h1 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h1><p><a href="https://yapi.ymfe.org/devops/index.html" target="_blank" rel="noopener">https://yapi.ymfe.org/devops/index.html</a></p>
<p><a href="http://stlighter.github.io/2018/04/19/yapi%E7%A6%BB%E7%BA%BF%E9%83%A8%E7%BD%B2/" target="_blank" rel="noopener">http://stlighter.github.io/2018/04/19/yapi%E7%A6%BB%E7%BA%BF%E9%83%A8%E7%BD%B2/</a></p>
<p><a href="https://www.linuxidc.com/Linux/2018-01/150513.htm" target="_blank" rel="noopener">https://www.linuxidc.com/Linux/2018-01/150513.htm</a></p>
<p><a href="https://blog.csdn.net/luwei42768/article/details/78919073" target="_blank" rel="noopener">https://blog.csdn.net/luwei42768/article/details/78919073</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/kxinter.gitub.io/page/2/">2</a><a class="extend next" rel="next" href="/kxinter.gitub.io/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Mr.Zhao</p>
              <p class="site-description motion-element" itemprop="description">日常运维文档整理。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/kxinter.gitub.io/archives/">
              
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/kxinter.gitub.io/categories/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/kxinter.gitub.io/tags/index.html">
                  <span class="site-state-item-count">26</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mr.Zhao</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/kxinter.gitub.io/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/kxinter.gitub.io/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/kxinter.gitub.io/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/kxinter.gitub.io/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/kxinter.gitub.io/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/kxinter.gitub.io/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/kxinter.gitub.io/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/kxinter.gitub.io/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/kxinter.gitub.io/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

  
  
</body>
</html>
